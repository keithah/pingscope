---
phase: 12-icmp-host-persistence-verification-closure
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - Tests/PingScopeTests/ICMPHostFlowIntegrationTests.swift
  - Tests/PingScopeTests/PingSchedulerTests.swift
autonomous: true

must_haves:
  truths:
    - "Persisted ICMP hosts participate in scheduler monitoring flow"
    - "ICMP host CRUD -> persist -> scheduler flow is covered by automated regression evidence"
  artifacts:
    - path: "Tests/PingScopeTests/ICMPHostFlowIntegrationTests.swift"
      provides: "End-to-end integration test for ICMP host persistence and scheduler execution"
      contains: "HostStore"
    - path: "Tests/PingScopeTests/PingSchedulerTests.swift"
      provides: "Scheduler coverage extension for mixed-method host sets"
      contains: "icmp"
  key_links:
    - from: "Tests/PingScopeTests/ICMPHostFlowIntegrationTests.swift"
      to: "Sources/PingScope/Services/HostStore.swift"
      via: "persisted host retrieval before scheduling"
      pattern: "allHosts"
    - from: "Tests/PingScopeTests/ICMPHostFlowIntegrationTests.swift"
      to: "Sources/PingScope/Services/PingScheduler.swift"
      via: "scheduler start and result collection"
      pattern: "start\(hosts"
---

<objective>
Prove the ICMP host flow works end-to-end after persistence by adding explicit automated integration coverage.

Purpose: Close the audit flow gap (`ICMP host CRUD -> persist -> scheduler monitoring`) with deterministic tests that fail on future wiring regressions.
Output: Integration test evidence showing persisted ICMP hosts are scheduled and produce monitoring results.
</objective>

<execution_context>
@/Users/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1.0-v1.0-MILESTONE-AUDIT.md
@.planning/phases/12-icmp-host-persistence-verification-closure/12-01-SUMMARY.md

@Sources/PingScope/Services/HostStore.swift
@Sources/PingScope/Services/PingScheduler.swift
@Tests/PingScopeTests/PingSchedulerTests.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ICMP persistence-to-scheduler integration regression test</name>
  <files>Tests/PingScopeTests/ICMPHostFlowIntegrationTests.swift</files>
  <action>Create a new integration test that persists an ICMP host through `HostStore`, reloads hosts from store state, starts `PingScheduler` with an injected ping operation, and asserts the persisted ICMP host is actually scheduled/executed. Keep the test deterministic (bounded sleep windows, explicit counters, isolated `UserDefaults`).</action>
  <verify>`swift test --filter ICMPHostFlowIntegrationTests` passes.</verify>
  <done>Automated test directly covers the previously broken audit flow from CRUD persistence into scheduler monitoring.</done>
</task>

<task type="auto">
  <name>Task 2: Extend scheduler regression coverage for mixed host-method sets</name>
  <files>Tests/PingScopeTests/PingSchedulerTests.swift</files>
  <action>Add a targeted scheduler test using a host set that includes `.icmp` and at least one non-ICMP method to confirm cadence loop and result handling remain stable across method diversity. Do not couple this test to real networking; use injected ping operation test doubles.</action>
  <verify>`swift test --filter PingSchedulerTests` passes.</verify>
  <done>Scheduler regression suite includes method-mix coverage that guards ICMP flow integration.</done>
</task>

</tasks>

<verification>
- `swift test --filter ICMPHostFlowIntegrationTests`
- `swift test --filter PingSchedulerTests`
</verification>

<success_criteria>
1. A persisted ICMP host is observed in scheduler execution via automated integration test.
2. Scheduler tests remain deterministic and green for mixed ping-method host sets.
3. Audit flow gap has executable regression evidence, not only manual assertions.
</success_criteria>

<output>
After completion, create `.planning/phases/12-icmp-host-persistence-verification-closure/12-02-SUMMARY.md`
</output>
