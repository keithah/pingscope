---
phase: 13-xcode-infrastructure-setup
plan: 02
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - Configuration/PingScope-AppStore.entitlements
  - Configuration/PingScope-DeveloperID.entitlements
  - Configuration/Info.plist
  - Info.plist
autonomous: true
requirements:
  - INFRA-05
  - INFRA-06
  - INFRA-07

must_haves:
  truths:
    - "App Store entitlements file exists with sandbox enabled"
    - "Developer ID entitlements file exists with sandbox disabled"
    - "Info.plist migrated to Configuration/ with version variable placeholders"
    - "Root Info.plist remains for SPM builds compatibility"
  artifacts:
    - path: "Configuration/PingScope-AppStore.entitlements"
      provides: "Sandbox-enabled entitlements for App Store distribution"
      contains: "com.apple.security.app-sandbox.*true"
    - path: "Configuration/PingScope-DeveloperID.entitlements"
      provides: "Hardened runtime entitlements for Developer ID distribution"
      contains: "com.apple.security.app-sandbox.*false"
    - path: "Configuration/Info.plist"
      provides: "Xcode-managed Info.plist with version automation variables"
      contains: "$(MARKETING_VERSION)"
  key_links:
    - from: "Configuration/PingScope-AppStore.entitlements"
      to: "Xcode build scheme"
      via: "Code Signing Entitlements build setting"
      pattern: "com.apple.security.app-sandbox"
    - from: "Configuration/Info.plist"
      to: "Xcode version automation"
      via: "MARKETING_VERSION and CURRENT_PROJECT_VERSION variables"
      pattern: "\\$\\(MARKETING_VERSION\\)"
---

<objective>
Create dual entitlements files and migrate Info.plist for Xcode version automation.

Purpose: Establish separate security postures for App Store (sandboxed) and Developer ID (non-sandboxed) distributions, and enable automated version management through Xcode build settings.
Output: Entitlements files for both distributions, Xcode-managed Info.plist with version variables
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-xcode-infrastructure-setup/13-RESEARCH.md
@.planning/phases/13-xcode-infrastructure-setup/13-01-SUMMARY.md

@entitlements-appstore.plist
@Info.plist
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create App Store entitlements file</name>
  <files>Configuration/PingScope-AppStore.entitlements</files>
  <action>
    Create Configuration/PingScope-AppStore.entitlements with sandbox enabled for App Store distribution.

    Content (based on existing entitlements-appstore.plist, converted to .entitlements extension):
    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
    <plist version="1.0">
    <dict>
        <!-- Required for App Store -->
        <key>com.apple.security.app-sandbox</key>
        <true/>

        <!-- Network access for ping operations -->
        <key>com.apple.security.network.client</key>
        <true/>

        <!-- File access for future export features -->
        <key>com.apple.security.files.user-selected.read-write</key>
        <true/>
    </dict>
    </plist>
    ```

    Why .entitlements extension: Xcode expects .entitlements (not .plist) for entitlement files. The existing entitlements-appstore.plist has wrong extension per research "Pitfall 2: Entitlement File Extension Mismatch".

    Research reference: RESEARCH.md "Entitlements: App Store (Sandbox Enabled)"
  </action>
  <verify>
    `cat Configuration/PingScope-AppStore.entitlements | grep -q "com.apple.security.app-sandbox.*true" && echo "✅ Sandbox enabled"`
  </verify>
  <done>
    PingScope-AppStore.entitlements exists with sandbox enabled, network client access, and file access permissions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Developer ID entitlements file</name>
  <files>Configuration/PingScope-DeveloperID.entitlements</files>
  <action>
    Create Configuration/PingScope-DeveloperID.entitlements with sandbox disabled for Developer ID distribution.

    Content:
    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
    <plist version="1.0">
    <dict>
        <!-- Hardened runtime enabled, sandbox disabled for ICMP -->
        <key>com.apple.security.app-sandbox</key>
        <false/>

        <!-- Hardened runtime: disable unsigned executable memory -->
        <key>com.apple.security.cs.allow-unsigned-executable-memory</key>
        <false/>

        <!-- Hardened runtime: disable environment variables -->
        <key>com.apple.security.cs.allow-dyld-environment-variables</key>
        <false/>
    </dict>
    </plist>
    ```

    Why sandbox disabled: Developer ID builds need raw socket access for true ICMP ping. Hardened runtime is still enabled (required for notarization) but sandbox is off.

    Critical: This enables SandboxDetector.isRunningInSandbox to return false, which shows ICMP option in PingMethod picker (existing behavior from v1.0).

    Research reference: RESEARCH.md "Entitlements: Developer ID (Hardened Runtime Only)"
  </action>
  <verify>
    `cat Configuration/PingScope-DeveloperID.entitlements | grep -q "com.apple.security.app-sandbox.*false" && echo "✅ Sandbox disabled"`
  </verify>
  <done>
    PingScope-DeveloperID.entitlements exists with sandbox disabled and hardened runtime exceptions configured for notarization
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate Info.plist with version automation</name>
  <files>Configuration/Info.plist</files>
  <action>
    Copy Info.plist to Configuration/Info.plist and replace hardcoded version strings with Xcode build setting variables.

    Steps:
    1. Copy existing Info.plist to Configuration/: `cp Info.plist Configuration/Info.plist`
    2. Replace version strings with variables:
       - Change CFBundleShortVersionString from "1.0.1" to "$(MARKETING_VERSION)"
       - Change CFBundleVersion from "1.0.1" to "$(CURRENT_PROJECT_VERSION)"

    Critical: Keep root Info.plist unchanged (needed for existing SPM build workflow). Configuration/Info.plist will be used only by Xcode builds.

    Why separate version/build: App Store requires incrementing build number (CFBundleVersion) on each upload, even for same version (CFBundleShortVersionString). Current setup has them identical ("1.0.1" for both) which causes "duplicate binary" on resubmission.

    Version scheme for v1.1:
    - MARKETING_VERSION = "1.1.0" (user-facing version)
    - CURRENT_PROJECT_VERSION = "1" (build number, increments per upload attempt)

    Research reference: RESEARCH.md "Pitfall 3: Info.plist Keys Missing for App Store"
  </action>
  <verify>
    `grep -q '$(MARKETING_VERSION)' Configuration/Info.plist && grep -q '$(CURRENT_PROJECT_VERSION)' Configuration/Info.plist && echo "✅ Version variables present"`
  </verify>
  <done>
    Configuration/Info.plist exists with $(MARKETING_VERSION) and $(CURRENT_PROJECT_VERSION) variables ready for Xcode build settings, root Info.plist preserved for SPM builds
  </done>
</task>

</tasks>

<verification>
- App Store entitlements exist with sandbox enabled: `cat Configuration/PingScope-AppStore.entitlements | grep "com.apple.security.app-sandbox"`
- Developer ID entitlements exist with sandbox disabled: `cat Configuration/PingScope-DeveloperID.entitlements | grep "com.apple.security.app-sandbox"`
- Info.plist migrated with version variables: `grep '$(MARKETING_VERSION)' Configuration/Info.plist`
- Configuration directory structure complete: `ls -la Configuration/`
- Root Info.plist still exists for SPM: `ls -la Info.plist`
</verification>

<success_criteria>
- Two entitlements files exist with correct sandbox settings (enabled for AppStore, disabled for DeveloperID)
- Info.plist migrated to Configuration/ with Xcode version automation variables
- Root Info.plist preserved for existing SPM build workflow
- All files ready for Xcode project integration in Plan 03
</success_criteria>

<output>
After completion, create `.planning/phases/13-xcode-infrastructure-setup/13-02-SUMMARY.md`
</output>
