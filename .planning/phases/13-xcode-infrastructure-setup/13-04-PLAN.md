---
phase: 13-xcode-infrastructure-setup
plan: 04
type: execute
wave: 4
depends_on: [13-03]
files_modified: []
autonomous: false
requirements:
  - INFRA-08

must_haves:
  truths:
    - "App Store build runs sandboxed (SandboxDetector returns true)"
    - "App Store build hides ICMP option in ping method picker"
    - "App Store build shows only TCP and UDP methods"
    - "Developer ID build runs non-sandboxed (SandboxDetector returns false)"
    - "Developer ID build shows all three methods (ICMP, TCP, UDP)"
    - "Both builds are functionally identical except sandbox-gated features"
    - "Both builds use same version string (1.1.0) with different build numbers"
    - "Asset catalog produces AppIcon.icns in both builds"
  artifacts:
    - path: "DerivedData/Build/Products/Debug/PingScope.app (AppStore scheme)"
      provides: "Sandboxed App Store build"
      min_lines: 0
    - path: "DerivedData/Build/Products/Debug/PingScope.app (DeveloperID scheme)"
      provides: "Non-sandboxed Developer ID build"
      min_lines: 0
  key_links:
    - from: "App Store build"
      to: "SandboxDetector.isRunningInSandbox"
      via: "NSHomeDirectory() contains /Library/Containers/"
      pattern: "isRunningInSandbox.*true"
    - from: "Developer ID build"
      to: "SandboxDetector.isRunningInSandbox"
      via: "NSHomeDirectory() does not contain /Library/Containers/"
      pattern: "isRunningInSandbox.*false"
    - from: "PingMethod picker"
      to: "SandboxDetector"
      via: "Conditional rendering based on sandbox status"
      pattern: "!SandboxDetector.isRunningInSandbox"
---

<objective>
Verify dual-build capability produces functionally correct apps for both distribution channels.

Purpose: Confirm sandbox detection works correctly, UI adapts to sandbox status, and both builds are ready for their respective distribution workflows.
Output: Human verification that App Store and Developer ID builds behave as specified
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-xcode-infrastructure-setup/13-RESEARCH.md
@.planning/phases/13-xcode-infrastructure-setup/13-01-SUMMARY.md
@.planning/phases/13-xcode-infrastructure-setup/13-02-SUMMARY.md
@.planning/phases/13-xcode-infrastructure-setup/13-03-SUMMARY.md

@Sources/PingScope/Services/SandboxDetector.swift
@Sources/PingScope/Models/PingMethod.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build and export both scheme variants</name>
  <files></files>
  <action>
    Build both Xcode schemes to produce .app bundles for verification.

    Steps:
    1. Build App Store scheme:
       ```bash
       xcodebuild -project PingScope.xcodeproj \
         -scheme PingScope-AppStore \
         -configuration Debug \
         -derivedDataPath ./DerivedData \
         build
       ```

    2. Build Developer ID scheme:
       ```bash
       xcodebuild -project PingScope.xcodeproj \
         -scheme PingScope-DeveloperID \
         -configuration Debug \
         -derivedDataPath ./DerivedData \
         build
       ```

    3. Copy builds to verification directory:
       ```bash
       mkdir -p build/verification
       cp -R DerivedData/Build/Products/Debug/PingScope.app build/verification/PingScope-AppStore.app
       # Rebuild DeveloperID to overwrite
       xcodebuild -project PingScope.xcodeproj -scheme PingScope-DeveloperID -configuration Debug -derivedDataPath ./DerivedData build
       cp -R DerivedData/Build/Products/Debug/PingScope.app build/verification/PingScope-DeveloperID.app
       ```

    4. Verify entitlements for each build:
       ```bash
       echo "=== App Store Build Entitlements ==="
       codesign -d --entitlements - build/verification/PingScope-AppStore.app

       echo -e "\n=== Developer ID Build Entitlements ==="
       codesign -d --entitlements - build/verification/PingScope-DeveloperID.app
       ```

    5. Verify asset catalog integration:
       ```bash
       echo -e "\n=== App Store Icon ==="
       ls -lh build/verification/PingScope-AppStore.app/Contents/Resources/AppIcon.icns

       echo -e "\n=== Developer ID Icon ==="
       ls -lh build/verification/PingScope-DeveloperID.app/Contents/Resources/AppIcon.icns
       ```

    6. Verify Info.plist versions:
       ```bash
       echo -e "\n=== App Store Version ==="
       /usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" build/verification/PingScope-AppStore.app/Contents/Info.plist
       /usr/libexec/PlistBuddy -c "Print CFBundleVersion" build/verification/PingScope-AppStore.app/Contents/Info.plist

       echo -e "\n=== Developer ID Version ==="
       /usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" build/verification/PingScope-DeveloperID.app/Contents/Info.plist
       /usr/libexec/PlistBuddy -c "Print CFBundleVersion" build/verification/PingScope-DeveloperID.app/Contents/Info.plist
       ```

    Expected output:
    - App Store entitlements: com.apple.security.app-sandbox = true
    - Developer ID entitlements: com.apple.security.app-sandbox = false
    - Both builds: AppIcon.icns exists (~100KB+)
    - Both builds: CFBundleShortVersionString = "1.1.0", CFBundleVersion = "1"
  </action>
  <verify>
    Both builds exist in build/verification/, entitlement verification shows different sandbox settings, icon files present
  </verify>
  <done>
    App Store and Developer ID builds created with verified entitlements, icons, and version metadata
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Verify dual-build sandbox behavior</name>
  <what-built>
    Dual Xcode build schemes producing App Store (sandboxed) and Developer ID (non-sandboxed) variants
  </what-built>
  <how-to-verify>
    **Test 1: App Store Build (Sandboxed)**
    1. Launch App Store build:
       ```bash
       open build/verification/PingScope-AppStore.app
       ```
    2. Click menu bar icon → right-click any host → Edit Host
    3. In "Ping Method" section, verify:
       - [ ] Only TCP and UDP options visible
       - [ ] ICMP option NOT visible (hidden by sandbox detection)
    4. Test ping functionality:
       - [ ] Select TCP method, save host
       - [ ] Verify menu bar shows latency updates
       - [ ] Click menu bar to see full interface
       - [ ] Confirm graph and history populate
    5. Quit app

    **Test 2: Developer ID Build (Non-Sandboxed)**
    1. Launch Developer ID build:
       ```bash
       open build/verification/PingScope-DeveloperID.app
       ```
    2. Click menu bar icon → right-click any host → Edit Host
    3. In "Ping Method" section, verify:
       - [ ] All three options visible: ICMP, TCP, UDP
       - [ ] ICMP is available (sandbox detection returns false)
    4. Test ICMP ping functionality:
       - [ ] Select ICMP method, save host
       - [ ] Verify menu bar shows latency updates
       - [ ] Confirm ICMP pings work (may show slightly different latency than TCP)
    5. Quit app

    **Test 3: Build Metadata**
    1. Verify version strings match:
       - [ ] Both apps show "Version 1.1.0" in About window
       - [ ] Build number is "1" for both
    2. Verify icon appearance:
       - [ ] Menu bar icon displays correctly in both builds
       - [ ] App icon shows in Dock when window open (both builds)

    **Test 4: Functional Parity**
    1. Run App Store build:
       - [ ] Add custom host (e.g., example.com) with TCP method
       - [ ] Verify multi-host monitoring works
       - [ ] Switch to compact mode
       - [ ] Enable floating window (stay-on-top)
       - [ ] Check notifications work
    2. Run Developer ID build:
       - [ ] Repeat all above steps with ICMP method
       - [ ] Confirm identical behavior except ping method

    **Expected Results:**
    - App Store build: ICMP hidden, TCP/UDP work
    - Developer ID build: ICMP visible and functional
    - Both builds: Identical UI/UX except sandbox-gated features
    - Both builds: Version 1.1.0, Build 1
    - Both builds: Icon displays correctly

    **Common Issues:**
    - If ICMP shows in App Store build: Entitlements not applied correctly, check codesign output
    - If ICMP doesn't work in Developer ID build: Not running from correct .app bundle, rebuild scheme
    - If version shows "1.0.1": Using SPM build instead of Xcode build, verify DerivedData path
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe failing tests with specific details</resume-signal>
</task>

</tasks>

<verification>
After human approval:
- [ ] App Store build verified sandboxed (ICMP hidden)
- [ ] Developer ID build verified non-sandboxed (ICMP visible)
- [ ] Both builds show version 1.1.0, build 1
- [ ] Both builds have working icons
- [ ] Functional parity confirmed except sandbox-gated features
</verification>

<success_criteria>
- Xcode builds both App Store and Developer ID variants from single codebase
- App Store build correctly hides ICMP option (sandboxed)
- Developer ID build shows all three ping methods (non-sandboxed)
- Both builds are functionally identical except sandbox-gated features
- Asset catalog produces valid app icons in both builds
- Version automation works (MARKETING_VERSION and CURRENT_PROJECT_VERSION applied)
- Ready to proceed to Phase 14 (Privacy and Compliance)
</success_criteria>

<output>
After completion, create `.planning/phases/13-xcode-infrastructure-setup/13-04-SUMMARY.md`
</output>
