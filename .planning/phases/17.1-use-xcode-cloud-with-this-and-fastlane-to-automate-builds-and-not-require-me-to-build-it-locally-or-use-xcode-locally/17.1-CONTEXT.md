# Phase 17.1: CI/CD Automation - Context

**Gathered:** 2026-02-23
**Status:** Ready for planning

<domain>
## Phase Boundary

Automate building and distributing PingScope (both App Store and Developer ID variants) using Xcode Cloud, Fastlane, and GitHub Actions. After this phase: pushing to GitHub triggers cloud builds automatically; local builds remain possible but are not required.

</domain>

<decisions>
## Implementation Decisions

### Tool Role Split
- **Xcode Cloud** owns all CI/CD: builds the App Store variant, signs it, uploads to App Store Connect
- **Fastlane** owns App Store Connect automation (API setup, TestFlight delivery, submission triggers) and provides local build lanes so Xcode is not required locally
- **GitHub Actions** handles two jobs: (1) compile + test on every PR/push, (2) build + export Developer ID .dmg on release tags and upload to GitHub Releases
- Clean split: Fastlane = local scripting + ASC API; Xcode Cloud = App Store CI; GitHub Actions = PR validation + Developer ID distribution

### Build Triggers
- **Push to main branch** → Xcode Cloud triggers TestFlight build automatically
- **Git tag matching `release/x.y.z`** → Xcode Cloud builds App Store variant AND auto-submits for App Store review via Fastlane `deliver(submit_for_review: true)` in `ci_post_xcodebuild.sh`
- **Git tag matching `release/x.y.z`** → GitHub Actions also triggers Developer ID build and attaches .dmg to GitHub Release
- **Every push + every PR** → GitHub Actions compile + test job runs (fast feedback, catches errors before merge)

### Distribution Targets
- **App Store variant**: TestFlight by default (every main push). App Store review submission on `release/` tag.
- **Developer ID variant**: GitHub Actions builds .dmg and uploads to GitHub Releases on `release/` tag.
- No manual upload steps — everything triggered by git events.

### Version and Build Number Management
- **Marketing version** (e.g., 1.2.0): Managed manually in the Xcode project. Developer bumps this before pushing a release tag.
- **Build number** (CFBundleVersion): Xcode Cloud auto-increments on each build. Zero manual maintenance required.

### Signing
- **App Store signing**: Managed by Xcode Cloud natively (automatic signing, no manual cert setup).
- **Developer ID signing** in GitHub Actions: Certificate and provisioning profile exported and stored as base64-encoded GitHub repository secrets. Standard macOS GitHub-hosted runner approach.

### Local Dev Experience
- Fastlane provides lanes for local builds/archives so Xcode is not required for building
- Cloud pipeline is the primary path; local builds are optional for testing before push
- Pipeline changes can be tested by pushing to a branch (GitHub Actions) or using Xcode Cloud's branch filters

### GitHub Actions Runner
- User will provide a **self-hosted macOS runner** with Xcode 26 installed
- GitHub Actions CI test job targets macOS 26 — do NOT pin to Xcode 16.x, do NOT exclude the widget target
- The workflow should specify `runs-on: self-hosted` (or appropriate self-hosted runner label)

### App Store Auto-Submit
- App Store review submission must be **fully automated** — no manual step in App Store Connect
- `release/x.y.z` tag → Xcode Cloud builds → `ci_post_xcodebuild.sh` calls Fastlane `deliver(submit_for_review: true)`
- App Store Connect API key (not password) must be stored in Xcode Cloud environment variables
- Fastlane uses ASC API key from environment for headless, non-interactive submission

### Claude's Discretion
- Specific Fastlane lane names and Fastfile structure
- Exact Xcode Cloud workflow YAML configuration
- GitHub Actions workflow file organization
- Notification setup for build success/failure

</decisions>

<specifics>
## Specific Ideas

- Pushing to GitHub should "just work" — no manual steps after push
- TestFlight should receive every main-branch build automatically
- Developer ID `.dmg` should appear as a GitHub Release asset on `release/` tags
- Local Fastlane lanes should be runnable without opening Xcode at all

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope.

</deferred>

---

*Phase: 17.1-use-xcode-cloud-with-this-and-fastlane-to-automate-builds-and-not-require-me-to-build-it-locally-or-use-xcode-locally*
*Context gathered: 2026-02-23*
