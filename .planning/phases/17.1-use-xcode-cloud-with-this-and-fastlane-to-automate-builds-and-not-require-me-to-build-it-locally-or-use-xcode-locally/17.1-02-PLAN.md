---
phase: 17.1-use-xcode-cloud-with-this-and-fastlane-to-automate-builds-and-not-require-me-to-build-it-locally-or-use-xcode-locally
plan: 02
type: execute
wave: 2
depends_on:
  - 17.1-01
files_modified: []
autonomous: false
requirements:
  - CI-04
  - CI-05

must_haves:
  truths:
    - "Pushing to main branch triggers a Xcode Cloud build that uploads to TestFlight automatically"
    - "Pushing a release/x.y.z tag triggers a Xcode Cloud build that calls Fastlane submit_review for App Store review"
    - "Xcode Cloud environment has ASC_KEY_ID, ASC_ISSUER_ID, ASC_KEY_CONTENT variables set so ci_post_xcodebuild.sh can authenticate"
    - "App Store Connect API key exists (or was already created) with App Manager role"
  artifacts:
    - path: "App Store Connect > Users and Access > Integrations > App Store Connect API"
      provides: "ASC API key (.p8 file + Key ID + Issuer ID)"
    - path: "App Store Connect > Xcode Cloud > [PingScope] > Workflows"
      provides: "Two Xcode Cloud workflows: TestFlight—Main and AppStore—Release"
  key_links:
    - from: "Xcode Cloud workflow (tag trigger)"
      to: "ci_scripts/ci_post_xcodebuild.sh"
      via: "CI_TAG env var containing release/x.y.z"
      pattern: "release/"
    - from: "ci_scripts/ci_post_xcodebuild.sh"
      to: "fastlane/Fastfile submit_review lane"
      via: "bundle exec fastlane submit_review with ASC env vars from Xcode Cloud environment"
      pattern: "ASC_KEY_ID"
---

<objective>
Configure Xcode Cloud workflows and secrets in App Store Connect so the automated pipeline goes live. This plan consists entirely of human-required steps in the Xcode IDE and App Store Connect web UI — there is nothing Claude can automate here.

Purpose: Xcode Cloud workflow configuration is stored in App Store Connect (not in the repo as YAML). Two workflows must be created through the Xcode IDE or ASC web UI. The ASC API key secrets must be set in the Xcode Cloud environment. Without these steps, the code from Plan 01 has no trigger.

Output: Two live Xcode Cloud workflows that respond to git events; ASC API key configured in Xcode Cloud environment.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/17.1-use-xcode-cloud-with-this-and-fastlane-to-automate-builds-and-not-require-me-to-build-it-locally-or-use-xcode-locally/17.1-CONTEXT.md
@.planning/phases/17.1-use-xcode-cloud-with-this-and-fastlane-to-automate-builds-and-not-require-me-to-build-it-locally-or-use-xcode-locally/17.1-RESEARCH.md

Key pitfalls to communicate to user (from RESEARCH.md):
- App Groups entitlement (6R7S5GA944.group.com.hadm.PingScope) must be registered in ASC before connecting Xcode Cloud
- PingScope must have an App Store Connect app record (bundle ID: com.hadm.PingScope) before Xcode Cloud onboarding
- Xcode Cloud does NOT have a native "submit for review" post-action — this is handled by Fastlane in ci_post_xcodebuild.sh
- Widget extension deployment target is macOS 26 — this is fine for Xcode Cloud but note it for awareness
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Create App Store Connect API key for Fastlane</name>
  <files>App Store Connect > Users and Access > Integrations > App Store Connect API (external service)</files>
  <action>
    Human must create an App Store Connect API key with App Manager role. Claude cannot access
    App Store Connect web UI. The key provides the ASC_KEY_ID, ASC_ISSUER_ID, and ASC_KEY_CONTENT
    values needed for Fastlane authentication in ci_post_xcodebuild.sh.

    Step 1: Go to https://appstoreconnect.apple.com/access/api
    Step 2: Click "+" > Name: "PingScope CI" > Access: "App Manager" > Generate
    Step 3: Download the .p8 file (only downloadable once) and note Key ID + Issuer ID
    Step 4: Base64-encode the .p8: `base64 -i /path/to/AuthKey_XXXXXXXXXX.p8 | pbcopy`
    Step 5: Store Key ID, Issuer ID, and base64 content securely (password manager)
  </action>
  <verify>
    <automated>MISSING — this is a human-only action in App Store Connect web UI; no automated verification possible</automated>
    <manual>
      Confirm you have three values ready to enter in Xcode Cloud:
      1. ASC_KEY_ID (10-character key ID)
      2. ASC_ISSUER_ID (UUID format)
      3. ASC_KEY_CONTENT (base64-encoded .p8 file content)
    </manual>
  </verify>
  <done>ASC API key with App Manager role created; Key ID, Issuer ID, and base64-encoded .p8 content stored securely and ready to enter in Xcode Cloud environment settings</done>
  <what-built>
    Plan 01 created Fastlane Fastfile that authenticates to App Store Connect using three environment variables:
    ASC_KEY_ID, ASC_ISSUER_ID, and ASC_KEY_CONTENT (base64-encoded .p8 key content).
    These must be created in App Store Connect and stored in Xcode Cloud's environment.
  </what-built>
  <resume-signal>Type "key created" when you have the Key ID, Issuer ID, and base64 .p8 content ready. Or type "key exists" if you already have an ASC API key from a previous phase.</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Create Xcode Cloud workflows (TestFlight and App Store release)</name>
  <files>App Store Connect > Xcode Cloud > [PingScope] > Workflows (external service — not a file in the repo)</files>
  <action>
    Human must create two Xcode Cloud workflows through the Xcode IDE (Product > Xcode Cloud).
    Claude cannot access Xcode IDE or App Store Connect. Workflows are stored in App Store Connect,
    not in the repository as YAML files.

    Prerequisites:
    - PingScope app record must exist in App Store Connect (bundle ID: com.hadm.PingScope)
    - App Group (6R7S5GA944.group.com.hadm.PingScope) must be registered in ASC > Certificates, Identifiers & Profiles
    - Plan 01 changes must be pushed to GitHub before creating workflows

    Workflow 1 — "TestFlight — Main":
    - Start Condition: Branch Changes > main
    - Action: Archive > Scheme: PingScope-AppStore > Destination: macOS
    - Post-Action: TestFlight Internal Testing
    - Environment secrets: ASC_KEY_ID, ASC_ISSUER_ID, ASC_KEY_CONTENT (from Task 1)

    Workflow 2 — "App Store — Release":
    - Start Condition: Tag Changes > pattern: release/**
    - Action: Archive > Scheme: PingScope-AppStore > Destination: macOS
    - Post-Action: TestFlight and App Store (uploads to ASC for submission)
    - Environment secrets: ASC_KEY_ID, ASC_ISSUER_ID, ASC_KEY_CONTENT (from Task 1)
  </action>
  <verify>
    <automated>MISSING — Xcode Cloud workflow configuration is in App Store Connect UI; no CLI/API access available</automated>
    <manual>
      In App Store Connect > Xcode Cloud > [PingScope product] > Workflows, confirm:
      1. "TestFlight — Main" workflow exists with a branch trigger on main
      2. "App Store — Release" workflow exists with a tag trigger matching release/**
      3. Both workflows have ASC_KEY_ID, ASC_ISSUER_ID, ASC_KEY_CONTENT set as secret environment variables
    </manual>
  </verify>
  <done>Two Xcode Cloud workflows saved and active: "TestFlight — Main" (branch trigger: main) and "App Store — Release" (tag trigger: release/**), both with ASC API key secrets configured</done>
  <what-built>
    Plan 01 has completed the Fastlane setup and fixed ci_scripts. Now Xcode Cloud needs two workflows
    configured to trigger on the correct git events. Xcode Cloud workflows are configured through the
    Xcode IDE (Product > Xcode Cloud) — they cannot be configured via YAML or CLI.
  </what-built>
  <resume-signal>Type "workflows created" when both Xcode Cloud workflows are saved and active in App Store Connect. Describe any errors you encountered.</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: End-to-end verification — push to main triggers TestFlight build</name>
  <files>App Store Connect > Xcode Cloud > [PingScope] > Builds (observe only)</files>
  <action>
    Push a test commit to main and observe the Xcode Cloud build in App Store Connect.
    This confirms the full pipeline works end-to-end: git push → Xcode Cloud triggers →
    ci_post_clone.sh runs → archive builds → ci_post_xcodebuild.sh runs → TestFlight upload.

    Run: git commit --allow-empty -m "test: verify Xcode Cloud pipeline" && git push origin main
    Then monitor: App Store Connect > Xcode Cloud > [PingScope] > Builds
  </action>
  <verify>
    <automated>MISSING — Xcode Cloud build status must be observed in App Store Connect web UI; no CLI access to Xcode Cloud build results</automated>
    <manual>
      Test 1 — TestFlight — Main workflow:
      1. Push a test commit to main (empty commit or comment change)
      2. App Store Connect > Xcode Cloud > [PingScope] > Builds — new build appears within 1-3 minutes
      3. Wait for build completion (typically 10-20 minutes)
      4. Confirm build uploads to TestFlight (status: "Testing" or "Ready to Test")
      5. Check build log: should show "Post-clone: Xcode Cloud environment ready." (ci_post_clone.sh)
      6. Check build log: should show "Non-release build — skipping App Store submission." (ci_post_xcodebuild.sh)

      Test 2 (optional — validate release trigger):
      git tag release/0.0.1-test && git push origin release/0.0.1-test
      Confirm "App Store — Release" workflow triggers and build log shows "Release tag detected: release/0.0.1-test"
      (Fastlane submit_review may fail for a test version — expected; confirms trigger works)
    </manual>
  </verify>
  <done>Main-branch push triggers Xcode Cloud build automatically; build completes and uploads to TestFlight; build log shows correct ci_script output (no version manipulation errors, no ExportOptions writing)</done>
  <what-built>
    Xcode Cloud workflows are configured and ci_scripts are fixed. This verification confirms
    the full pipeline works end-to-end before declaring the phase complete.
  </what-built>
  <resume-signal>Type "verified" if the main-branch workflow triggered successfully and a TestFlight build was created. Describe any build failures with error text from the Xcode Cloud build log.</resume-signal>
</task>

</tasks>

<verification>
Phase 17.1 is complete when:

1. Pushing any commit to main results in an Xcode Cloud build uploading to TestFlight automatically
2. The Xcode Cloud build log shows simplified ci_post_clone.sh output (no version manipulation errors)
3. The "App Store — Release" workflow exists and is ready to trigger on release/* tags
4. Fastlane is installed in the repo (Gemfile, Appfile, Fastfile present) and runnable locally with `bundle exec fastlane`
5. ASC API key env vars are set in both Xcode Cloud workflows as secrets
</verification>

<success_criteria>
- "Pushing to main just works" — TestFlight build appears without any manual action from developer
- "Pushing a release tag just works" — Xcode Cloud builds and Fastlane submits for App Store review
- Developer does not need to open Xcode or App Store Connect to ship a build
- `bundle exec fastlane submit_review` is available for local use if needed
</success_criteria>

<output>
After completion, create `.planning/phases/17.1-use-xcode-cloud-with-this-and-fastlane-to-automate-builds-and-not-require-me-to-build-it-locally-or-use-xcode-locally/17.1-02-SUMMARY.md`
</output>
