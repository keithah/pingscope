# Phase 17.1: CI/CD Automation - Research

**Researched:** 2026-02-23
**Domain:** Xcode Cloud + Fastlane + GitHub Actions (macOS CI/CD)
**Confidence:** MEDIUM-HIGH (Xcode Cloud UI-configured, not YAML; GitHub Actions pattern is HIGH; Fastlane is HIGH)

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions
- **Xcode Cloud** owns all CI/CD: builds the App Store variant, signs it, uploads to App Store Connect
- **Fastlane** owns App Store Connect automation (API setup, TestFlight delivery, submission triggers) and provides local build lanes so Xcode is not required locally
- **GitHub Actions** handles two jobs: (1) compile + test on every PR/push, (2) build + export Developer ID .dmg on release tags and upload to GitHub Releases
- Clean split: Fastlane = local scripting + ASC API; Xcode Cloud = App Store CI; GitHub Actions = PR validation + Developer ID distribution
- **Push to main branch** triggers Xcode Cloud TestFlight build automatically
- **Git tag matching `release/x.y.z`** triggers Xcode Cloud App Store submission (go-to-review)
- **Git tag matching `release/x.y.z`** also triggers GitHub Actions Developer ID build (.dmg to GitHub Release)
- **Every push + every PR** triggers GitHub Actions compile + test job
- **App Store variant**: TestFlight by default (every main push). App Store review submission on `release/` tag.
- **Developer ID variant**: GitHub Actions builds .dmg and uploads to GitHub Releases on `release/` tag.
- **Marketing version** (e.g., 1.2.0): Managed manually in the Xcode project.
- **Build number** (CFBundleVersion): Xcode Cloud auto-increments on each build.
- **App Store signing**: Managed by Xcode Cloud natively (automatic signing, no manual cert setup).
- **Developer ID signing** in GitHub Actions: Certificate and provisioning profile exported and stored as base64-encoded GitHub repository secrets.

### Claude's Discretion
- Specific Fastlane lane names and Fastfile structure
- Exact Xcode Cloud workflow YAML configuration
- GitHub Actions workflow file organization
- Notification setup for build success/failure
- Whether to use `fastlane deliver` vs `fastlane pilot` for specific steps

### Deferred Ideas (OUT OF SCOPE)
None — discussion stayed within phase scope.
</user_constraints>

---

## Summary

PingScope already has partial CI/CD infrastructure in place: a `ci_scripts/` directory (Xcode Cloud hooks), a `deploy/sign-notarize.sh` script, and a `.github/workflows/production-release.yml` GitHub Actions workflow. However, the existing GitHub Actions workflow uses a **self-hosted runner** and builds via **`swift build`** (SwiftPM), not via `xcodebuild`. Since PingScope now has a proper Xcode project (`PingScope.xcodeproj`), this entire pipeline must be updated to use `xcodebuild` with the project's schemes (`PingScope-AppStore` and `PingScope-DeveloperID`). The existing `ci_post_clone.sh` and `ci_post_xcodebuild.sh` scripts are skeletons that need completion.

The critical architectural insight discovered in research: **Xcode Cloud's automatic (cloud-managed) signing means the Developer ID certificate is NOT accessible to custom scripts running inside Xcode Cloud.** This is why the phase-design correctly routes Developer ID builds to GitHub Actions, not Xcode Cloud. Xcode Cloud handles App Store signing natively; GitHub Actions handles Developer ID via secrets-stored certificates.

**Primary recommendation:** Replace the self-hosted runner GitHub Actions workflow with a `macos-15` GitHub-hosted runner using `xcodebuild` + the existing `PingScope-DeveloperID` scheme. Set up Xcode Cloud workflows (configured through Xcode IDE, not YAML) for App Store distribution. Add Fastlane for local build lanes and App Store Connect API key authentication.

---

## Critical Project-Specific Findings

### What Already Exists (must be updated, not replaced wholesale)
| File | Status | What to do |
|------|--------|-----------|
| `ci_scripts/ci_post_clone.sh` | Exists but wrong | Uses old SwiftPM+Info.plist path; replace version logic |
| `ci_scripts/ci_post_xcodebuild.sh` | Exists but wrong | ExportOptions path is wrong; needs cleanup |
| `.github/workflows/production-release.yml` | Exists but wrong | Self-hosted runner + SwiftPM build; replace with xcodebuild |
| `deploy/sign-notarize.sh` | Exists and reusable | Already correct for DMG creation; keep, reference from new workflow |
| `Configuration/ExportOptions-AppStore.plist` | Exists | Correct for App Store; reference in Xcode Cloud export |

### What Does Not Exist Yet (must be created)
- `fastlane/Gemfile` + `fastlane/Fastfile` + `fastlane/Appfile`
- `Configuration/ExportOptions-DeveloperID.plist` (new, needed for `xcodebuild -exportArchive`)
- Updated `.github/workflows/ci.yml` (PR/push compile+test job — new file)
- Updated `.github/workflows/release.yml` (Developer ID release job — replaces production-release.yml)
- Xcode Cloud workflows (configured through Xcode IDE: two workflows)

### Project Targets (from pbxproj analysis)
- `PingScopeApp` — main app target, bundle ID `com.hadm.PingScope`
- `widgetExtension` — widget target, bundle ID `com.hadm.PingScope.widget`
- `PingScopeTests` — unit tests
- `PingScopeUITests` — UI tests
- Two shared schemes: `PingScope-AppStore` (archives with `APPSTORE` compilation condition) and `PingScope-DeveloperID`
- App Store Release: `CODE_SIGN_STYLE = Manual`, `CODE_SIGN_IDENTITY = "Apple Distribution"`, `PROVISIONING_PROFILE_SPECIFIER = PingScope`
- Developer ID: No explicit Developer ID configuration yet in pbxproj (needs to be verified / a separate build configuration may be needed)
- Team ID: `6R7S5GA944`
- CURRENT_PROJECT_VERSION: `2` (Xcode Cloud auto-increments from here)

---

## Standard Stack

### Core
| Tool | Version | Purpose | Why Standard |
|------|---------|---------|--------------|
| Xcode Cloud | Current (via ASC) | App Store CI/CD, automatic signing, TestFlight upload | Apple-native, no cert management needed |
| Fastlane | Latest (via Bundler) | ASC API auth, local build lanes, App Store submission trigger | Industry standard for Apple automation |
| GitHub Actions | N/A | PR compile+test, Developer ID .dmg release | Already in project; GitHub-hosted runners, no self-hosting |
| xcodebuild | Bundled with Xcode | Build, archive, export via Xcode project | Required for Xcode project (replaces `swift build`) |
| xcrun notarytool | Bundled with Xcode | Notarize .dmg for Developer ID distribution | Replaced deprecated altool (since Xcode 13) |

### Supporting
| Tool | Version | Purpose | When to Use |
|------|---------|---------|-------------|
| `create-dmg` | Latest (brew) | Create visually nice DMGs | Optional — `hdiutil` (already in deploy/sign-notarize.sh) works fine for CI |
| `softprops/action-gh-release` | v2 | Upload .dmg to GitHub Release | Already used in existing workflow |
| `apple-actions/import-codesign-certs` | v3 | Import p12 cert into macOS keychain | Optional — manual approach already in production-release.yml |
| `maxim-lobanov/setup-xcode` | v1 | Pin Xcode version on GitHub runner | Use to pin Xcode 16 on macos-15 |
| Bundler + Gemfile | Latest | Manage fastlane dependencies | Required for reproducible fastlane installs |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| `xcodebuild` direct | `fastlane gym`/`build_mac_app` | Fastlane wraps xcodebuild with nicer output; fine for both local and CI |
| `softprops/action-gh-release` | `gh release create` + `gh release upload` | gh CLI built-in works fine too |
| `apple-actions/import-codesign-certs` | Manual keychain commands | Manual commands already work (proven in existing workflow) |

**Installation:**
```bash
# Install Fastlane via Bundler (preferred)
gem install bundler
bundle install  # from project root with Gemfile
```

---

## Architecture Patterns

### Recommended File Structure

```
pingscope/
├── ci_scripts/                      # Xcode Cloud hooks (must be adjacent to .xcodeproj)
│   ├── ci_post_clone.sh             # EXISTS: replace version logic
│   └── ci_post_xcodebuild.sh        # EXISTS: simplify/fix
├── fastlane/                        # NEW: Fastlane configuration
│   ├── Appfile                      # app_identifier, team_id
│   ├── Fastfile                     # Lane definitions
│   └── README.md                    # How to use local lanes
├── Gemfile                          # NEW: fastlane dependency (project root)
├── Gemfile.lock                     # NEW: generated
├── Configuration/
│   ├── ExportOptions-AppStore.plist     # EXISTS: for App Store
│   └── ExportOptions-DeveloperID.plist  # NEW: for Developer ID GitHub Actions
└── .github/
    └── workflows/
        ├── ci.yml                   # NEW: PR + push compile+test
        └── release.yml              # REPLACE production-release.yml: Developer ID release
```

### Pattern 1: Xcode Cloud Workflow Configuration

Xcode Cloud workflows are configured **through Xcode IDE** (Product > Xcode Cloud > Create Workflow), not YAML files. Settings are stored in App Store Connect and Xcode reads them.

**Workflow 1: "TestFlight — Main"**
- Start condition: Branch changes → `main`
- Action: Archive → Scheme: `PingScope-AppStore` → Destination: macOS
- Post-action: TestFlight Internal Testing (or just upload to TestFlight)
- Signing: Automatic (Xcode Cloud manages certificates)
- Build number: Auto-incremented by Xcode Cloud

**Workflow 2: "App Store — Release"**
- Start condition: Tag changes → `release/*` (pattern: `release/**`)
- Action: Archive → Scheme: `PingScope-AppStore` → Destination: macOS
- Post-action: TestFlight and App Store (distribution)
- Note: Xcode Cloud does NOT have a native "submit for review" post-action — Fastlane handles that via a ci_post_xcodebuild.sh hook or a separate lane triggered manually

**Critical macOS Xcode Cloud note:** Xcode Cloud IS capable of building and uploading macOS apps to TestFlight. The macOS notarize post-action is available in Xcode Cloud UI (added June 2023) but it only applies to Developer ID distribution — which the plan correctly handles via GitHub Actions.

### Pattern 2: GitHub Actions — Developer ID Release

The existing `production-release.yml` pattern is mostly correct but uses wrong build tool. Replace:
- Runner: `self-hosted` → `macos-15`
- Build step: `swift build -c release` + `scripts/build-app-bundle.sh` → `xcodebuild archive` + `xcodebuild -exportArchive`
- Tag trigger: `v*` → `release/**` (matches phase plan) OR keep `v*` for backward compat

```yaml
# Source: Official GitHub Docs + defn.io verified pattern
on:
  push:
    tags:
      - 'release/*'

jobs:
  developer-id-release:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode 16
        run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer

      - name: Import Developer ID certificate
        env:
          APPLE_CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          echo -n "$APPLE_CERTIFICATE_P12" | base64 --decode -o $RUNNER_TEMP/cert.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security import $RUNNER_TEMP/cert.p12 -P "$CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

      - name: Archive (Developer ID)
        run: |
          xcodebuild archive \
            -project PingScope.xcodeproj \
            -scheme PingScope-DeveloperID \
            -destination 'generic/platform=macOS' \
            -archivePath $RUNNER_TEMP/PingScope.xcarchive

      - name: Export Developer ID .app
        run: |
          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/PingScope.xcarchive \
            -exportOptionsPlist Configuration/ExportOptions-DeveloperID.plist \
            -exportPath $RUNNER_TEMP/export \
            -allowProvisioningUpdates
```

### Pattern 3: GitHub Actions — PR Compile + Test

```yaml
# .github/workflows/ci.yml
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - name: Build and Test
        run: |
          xcodebuild test \
            -project PingScope.xcodeproj \
            -scheme PingScope-AppStore \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
```

### Pattern 4: Fastlane Fastfile Structure

```ruby
# fastlane/Fastfile
default_platform(:mac)

platform :mac do
  desc "Get App Store Connect API key from env vars"
  private_lane :api_key do
    app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: ENV["ASC_KEY_CONTENT"],   # base64-encoded .p8 content
      is_key_content_base64: true,
      in_house: false
    )
  end

  desc "Build App Store archive locally (no Xcode required)"
  lane :build_appstore do
    build_mac_app(
      project: "PingScope.xcodeproj",
      scheme: "PingScope-AppStore",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "PingScope.pkg"
    )
  end

  desc "Build Developer ID app locally (no Xcode required)"
  lane :build_developerid do
    build_mac_app(
      project: "PingScope.xcodeproj",
      scheme: "PingScope-DeveloperID",
      configuration: "Release",
      export_method: "developer-id",
      output_directory: "./build",
      output_name: "PingScope.app"
    )
  end

  desc "Upload to TestFlight (for CI use after Xcode Cloud build)"
  lane :upload_testflight do
    key = api_key
    upload_to_testflight(
      pkg: "./build/PingScope.pkg",
      api_key: key,
      skip_waiting_for_build_processing: true
    )
  end

  desc "Submit latest TestFlight build for App Store review"
  lane :submit_review do
    key = api_key
    deliver(
      api_key: key,
      submit_for_review: true,
      automatic_release: false,
      force: true,
      skip_metadata: true,
      skip_screenshots: true,
      skip_binary_upload: true,
      platform: "osx"
    )
  end
end
```

### Pattern 5: Xcode Cloud ci_scripts

```bash
# ci_scripts/ci_post_clone.sh — executed after git clone
#!/bin/sh
set -e
# Build number is managed by Xcode Cloud (CI_BUILD_NUMBER env var)
# Marketing version is in the project file (MARKETING_VERSION build setting)
# No manual plist manipulation needed — Xcode reads build settings
echo "Post-clone: CI_BUILD_NUMBER=$CI_BUILD_NUMBER, CI_TAG=$CI_TAG"
```

### Anti-Patterns to Avoid

- **Using `swift build` in GitHub Actions**: The Xcode project does not support `swift build` directly for the full .app (widget extension, asset catalogs, entitlements require xcodebuild)
- **Using `self-hosted` GitHub runners**: The existing workflow uses self-hosted runners. The phase requires GitHub-hosted runners (macos-15). All cert handling must use secrets.
- **Modifying Info.plist in ci_post_clone.sh for build numbers**: Xcode Cloud auto-increments CFBundleVersion from the project's CURRENT_PROJECT_VERSION. The existing ci_post_clone.sh script incorrectly writes to `$CI_PRIMARY_REPOSITORY_PATH/Info.plist` (wrong path for this Xcode project structure).
- **Using altool for uploads**: altool is deprecated. Use `xcrun notarytool` for notarization and Fastlane's `upload_to_testflight` (which uses notarytool internally) for TestFlight uploads.
- **Trying to codesign DMG inside Xcode Cloud**: Xcode Cloud's cloud-managed signing keychain is not accessible to custom scripts. Developer ID signing + DMG creation must happen in GitHub Actions.

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| p12 cert → keychain import | Custom key management | `security create-keychain` + `security import` (already in deploy/sign-notarize.sh pattern) | Proven pattern, handles cleanup on runner exit |
| TestFlight upload | Custom altool/ASC API calls | `fastlane pilot` / `upload_to_testflight` | Handles processing wait, error retry, API auth |
| App Store submission | Custom API calls | `fastlane deliver` with `submit_for_review: true` | Handles metadata, screenshots, compliance |
| Notarization polling | Manual xcrun loop | `xcrun notarytool submit --wait` | Built-in wait flag handles polling |
| DMG creation | Custom hdiutil script | Existing `deploy/sign-notarize.sh` ALREADY handles this | Reuse what works |
| ASC API auth | Custom JWT signing | `fastlane app_store_connect_api_key` | Handles token expiry, JWT generation |

**Key insight:** The project already has a working `deploy/sign-notarize.sh` that handles DMG+PKG creation, notarization, and stapling. Reuse it from the GitHub Actions workflow instead of rebuilding.

---

## Common Pitfalls

### Pitfall 1: Wrong Build Tool in GitHub Actions
**What goes wrong:** Using `swift build` or `scripts/build-app-bundle.sh` (existing SwiftPM approach) to build the app. This misses the widget extension, asset catalog compilation, and proper app bundle structure.
**Why it happens:** The existing `production-release.yml` was built before the Xcode project migration.
**How to avoid:** Replace `swift build` with `xcodebuild archive -project PingScope.xcodeproj -scheme PingScope-DeveloperID`.
**Warning signs:** The built `.app` lacks the widget extension or `Assets.car` compiled asset catalog.

### Pitfall 2: Developer ID Build Configuration Missing
**What goes wrong:** The `PingScope-DeveloperID` scheme archives with the Release build configuration, which uses `CODE_SIGN_IDENTITY = "Apple Distribution"` (App Store cert). The Developer ID scheme should use a different build configuration.
**Why it happens:** The pbxproj only shows one Release configuration for `PingScopeApp` (App Store signing). No separate Developer ID configuration is defined.
**How to avoid:** Either create a `Release-DeveloperID` build configuration in Xcode (duplicating Release), or override signing in the ExportOptions-DeveloperID.plist. The existing `Configuration/PingScope-DeveloperID.entitlements` exists but the scheme's archive configuration still uses App Store certs.
**Warning signs:** `xcodebuild -exportArchive` fails with "no valid signing identity for developer-id".

### Pitfall 3: Xcode Cloud Build Number Confusion
**What goes wrong:** The project has `CURRENT_PROJECT_VERSION = 2`. Xcode Cloud auto-increments from App Store Connect's next build number setting. The existing `ci_post_clone.sh` script manually sets `CFBundleVersion` to `"0.0.$CI_BUILD_NUMBER"` which overrides Xcode Cloud's system.
**Why it happens:** The existing script was written for SwiftPM workflow before proper Xcode project integration.
**How to avoid:** Remove or simplify `ci_post_clone.sh` — Xcode Cloud handles build number via the "Build Number" setting in App Store Connect > Xcode Cloud > Product Settings. The `CURRENT_PROJECT_VERSION` in the project is the starting point; Xcode Cloud increments from App Store Connect's counter.
**Warning signs:** TestFlight receives builds with wrong/duplicate build numbers; App Store Connect rejects uploads.

### Pitfall 4: App Groups Entitlements in Xcode Cloud
**What goes wrong:** App Groups (`6R7S5GA944.group.com.hadm.PingScope`) require automatic signing to register the capability. Xcode Cloud's automatic signing should handle this, but if the App Group isn't registered in the provisioning profile, the build fails with entitlement mismatch.
**Why it happens:** macOS App Groups in provisioning profiles have known complexity with automatic vs manual signing.
**How to avoid:** Ensure the App Group capability is registered in App Store Connect (Certificates, Identifiers & Profiles) before connecting Xcode Cloud. Let Xcode Cloud use automatic signing — it will fetch/create the right profiles.
**Warning signs:** `ITMS-90166` or `ITMS-90286` errors in Xcode Cloud build log about entitlements.

### Pitfall 5: Widget Extension Signing in Xcode Cloud
**What goes wrong:** The `widgetExtension` target uses `CODE_SIGN_ENTITLEMENTS = PingScopeWidget/PingScopeWidget.entitlements` in Release config. Xcode Cloud's automatic signing must handle both the main app AND the widget extension. If not configured correctly, the extension signing fails.
**Why it happens:** Widget extensions are embedded in the main app and must be signed with a matching team and provisioning profile.
**How to avoid:** Ensure `widgetExtension` target has `CODE_SIGN_STYLE = Automatic` for Debug. In Release/Xcode Cloud, verify it has proper entitlements file and the App Group is registered. The widget deployment target is macOS 26 (from pbxproj) — verify this is intentional or matches the Xcode Cloud environment.
**Warning signs:** Archive succeeds but validation fails with "invalid signature" on the embedded extension.

### Pitfall 6: Self-Hosted Runner in Existing Workflow
**What goes wrong:** The existing `.github/workflows/production-release.yml` uses `runs-on: self-hosted`. On GitHub Actions runs, this requires a self-hosted runner machine to be configured and running. Without it, the workflow queues indefinitely.
**Why it happens:** The original workflow was designed for local infrastructure.
**How to avoid:** Replace with `runs-on: macos-15` and move all cert/notary secrets to GitHub repository secrets. The existing secret names (`APPLE_CERTIFICATE_P12`, `CERTIFICATE_PASSWORD`, `APPLE_INSTALLER_P12`, `APPLE_ID`, `APPLE_APP_PASSWORD`, `APPLE_TEAM_ID`) need to be set in GitHub repository settings.
**Warning signs:** Workflow stays in "Queued" state permanently.

### Pitfall 7: Xcode Cloud GitHub Connection Requires App Store Connect App Record
**What goes wrong:** If PingScope does not have an App Store Connect record, Xcode Cloud onboarding will fail. The release notes explicitly say "Onboarding a product will fail if a developer team has no existing apps in App Store Connect."
**Why it happens:** Xcode Cloud is tied to App Store Connect app records.
**How to avoid:** Create the PingScope app record in App Store Connect before attempting Xcode Cloud setup. Bundle ID `com.hadm.PingScope` must match.
**Warning signs:** Xcode Cloud onboarding fails with "No products found" or similar.

### Pitfall 8: Xcode Version Mismatch on GitHub Actions
**What goes wrong:** Using `macos-15` runner defaults to Xcode 16.0. This project was created with Xcode 26.0.1 (`LastUpgradeCheck = 2600`). GitHub Actions does NOT have Xcode 26.x available (as of research date — Feb 2026). Available on macos-15: Xcode 15.4, 16.0, 16.1, 16.2.
**Why it happens:** Xcode 26 is the Apple internal naming for what was publicly released but GitHub Actions lags behind.
**How to avoid:** Use `xcode-select` to pin Xcode 16.2 explicitly. Test that the project builds with Xcode 16.x. The `LastUpgradeCheck = 2600` does not prevent building with Xcode 16.x, it's only an upgrade check hint.
**Warning signs:** Build fails with "Xcode version X not found" or compiler errors from version mismatches.

### Pitfall 9: altool is Deprecated — Use notarytool
**What goes wrong:** The existing `deploy/README.md` references `altool` for App Store uploads. `altool` was deprecated with Xcode 14 and removed from Xcode 15+.
**Why it happens:** Documentation written before the deprecation.
**How to avoid:** Use `xcrun notarytool submit --wait` for notarization. Use Fastlane's `upload_to_testflight` for TestFlight uploads. Use `xcrun altool --upload-package` only if on older Xcode — but on GitHub macos-15 with Xcode 16.x, it may not be available.
**Warning signs:** `command not found: altool` or deprecation warnings failing the CI step.

---

## Code Examples

### ExportOptions-DeveloperID.plist (new file needed)
```xml
<!-- Source: defn.io verified pattern + Apple docs -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>developer-id</string>
    <key>signingStyle</key>
    <string>automatic</string>
    <key>teamID</key>
    <string>6R7S5GA944</string>
    <key>stripSwiftSymbols</key>
    <true/>
    <key>compileBitcode</key>
    <false/>
</dict>
</plist>
```

### Gemfile (project root)
```ruby
# Source: fastlane docs official recommendation
source "https://rubygems.org"
gem "fastlane"
```

### fastlane/Appfile
```ruby
# Source: fastlane docs
app_identifier("com.hadm.PingScope")
team_id("6R7S5GA944")
# apple_id omitted — using API key auth, not password auth
```

### GitHub Actions: Certificate Import Pattern
```yaml
# Source: Official GitHub Docs (docs.github.com) + defn.io verified
- name: Import Developer ID certificate
  env:
    APPLE_CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
    CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
    KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
  run: |
    KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
    echo -n "$APPLE_CERTIFICATE_P12" | base64 --decode -o $RUNNER_TEMP/cert.p12
    security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
    security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
    security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
    security import $RUNNER_TEMP/cert.p12 -P "$CERTIFICATE_PASSWORD" \
      -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
    security set-key-partition-list -S apple-tool:,apple:,codesign: \
      -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
    security list-keychain -d user -s $KEYCHAIN_PATH

- name: Cleanup keychain
  if: always()
  run: security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
```

### GitHub Actions: Notarization Pattern (modern notarytool)
```yaml
# Source: Official Apple TN3147 + Stack Overflow verified pattern
- name: Notarize and staple DMG
  env:
    APPLE_ID: ${{ secrets.APPLE_ID }}
    APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
    APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
  run: |
    xcrun notarytool store-credentials "NotarytoolProfile" \
      --apple-id "$APPLE_ID" \
      --password "$APPLE_APP_PASSWORD" \
      --team-id "$APPLE_TEAM_ID"
    xcrun notarytool submit PingScope.dmg \
      --keychain-profile "NotarytoolProfile" --wait
    xcrun stapler staple PingScope.dmg
```

### Fastlane: App Store Connect API Key from Environment
```ruby
# Source: fastlane docs (docs.fastlane.tools/actions/app_store_connect_api_key/)
# Environment variables: ASC_KEY_ID, ASC_ISSUER_ID, ASC_KEY_CONTENT (base64 p8)
app_store_connect_api_key(
  key_id: ENV["ASC_KEY_ID"],
  issuer_id: ENV["ASC_ISSUER_ID"],
  key_content: ENV["ASC_KEY_CONTENT"],
  is_key_content_base64: true,
  in_house: false
)
```

### ci_scripts/ci_post_clone.sh (simplified replacement)
```bash
#!/bin/sh
# Source: Apple WWDC21 + Xcode Cloud docs
# Xcode Cloud manages build numbers automatically via CI_BUILD_NUMBER.
# CURRENT_PROJECT_VERSION in the project is the seed; ASC increments from there.
# No manual plist manipulation needed.
set -e
echo "Post-clone: Xcode Cloud environment ready."
echo "  CI_BUILD_NUMBER: ${CI_BUILD_NUMBER:-unset}"
echo "  CI_TAG: ${CI_TAG:-unset}"
echo "  CI_BRANCH: ${CI_BRANCH:-unset}"
```

---

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| `xcrun altool` for notarization | `xcrun notarytool` | Xcode 13 (2021), removed Xcode 15 | Must use notarytool on Xcode 16 |
| SwiftPM `swift build` + manual bundle | `xcodebuild` with Xcode project | Phase 17 migration | Enables widget extension, asset catalog, proper entitlements |
| Self-hosted GitHub runner | `macos-15` GitHub-hosted runner | This phase | Removes infrastructure dependency |
| Manual cert management (local keychain) | Xcode Cloud automatic signing (ASC) | Xcode 13 (2021) | No cert files needed for App Store path |
| `fastlane match` for cert management | Not needed (Xcode Cloud auto-signs) | This phase | Match adds complexity; skip it |
| `xcrun altool --upload-package` for App Store | `fastlane deliver` / `upload_to_testflight` | Xcode 14+ deprecation | Fastlane handles API auth, polling |

**Deprecated/outdated in this project:**
- `scripts/build-app-bundle.sh`: SwiftPM-based bundle creation — superseded by `xcodebuild` (keep file, just stop using it in CI)
- `production-release.yml` self-hosted runner: Replace with macos-15 GitHub-hosted runner
- `ci_post_clone.sh` version manipulation: Xcode Cloud handles this; simplify the script
- `ci_post_xcodebuild.sh` ExportOptions writing: Not how Xcode Cloud works; ExportOptions is for `xcodebuild -exportArchive` step which Xcode Cloud handles internally

---

## Open Questions

1. **Developer ID build configuration in Xcode project**
   - What we know: The `PingScope-DeveloperID` scheme exists with Archive configuration using Release build config, which has `CODE_SIGN_IDENTITY = "Apple Distribution"` — that's the App Store cert identity.
   - What's unclear: Does the DeveloperID scheme need a separate build configuration (`Release-DeveloperID`) with `CODE_SIGN_IDENTITY = "Developer ID Application"`, or can ExportOptions-DeveloperID.plist override at export time?
   - Recommendation: Create a separate `Release-DeveloperID` build configuration duplicating Release but with `CODE_SIGN_IDENTITY = "Developer ID Application"` and `CODE_SIGN_ENTITLEMENTS = Configuration/PingScope-DeveloperID.entitlements`. Assign it to the `PingScope-DeveloperID` scheme's Archive action.

2. **Xcode Cloud App Store submission (go-to-review) on tag**
   - What we know: Xcode Cloud does NOT have a built-in "submit for review" post-action. It can archive and upload to TestFlight. App Store review submission is a separate step.
   - What's unclear: The CONTEXT.md says tag → "App Store submission (go-to-review)". This may need Fastlane's `deliver(submit_for_review: true)` triggered via a `ci_post_xcodebuild.sh` script that detects `CI_TAG` and calls Fastlane, OR it means the tag workflow uploads to TestFlight and a manual submission happens.
   - Recommendation: Implement as two parts: (1) Xcode Cloud tag workflow uploads to App Store (TestFlight + App Store distribution), and (2) a Fastlane lane `fastlane submit_review` that the developer runs locally after build processes. Full automatic submission-to-review from Xcode Cloud requires the ASC API key in Xcode Cloud environment variables, then a ci_post_xcodebuild.sh script that calls Fastlane.

3. **Widget extension deployment target discrepancy**
   - What we know: `widgetExtension` has `MACOSX_DEPLOYMENT_TARGET = 26.0` — this is macOS Tahoe (next major release, in beta as of research date).
   - What's unclear: Is this intentional? Can Xcode Cloud build this against macOS 26 SDK? The Xcode Cloud release notes confirm macOS Tahoe 26 is available in Xcode Cloud.
   - Recommendation: This should be fine for Xcode Cloud (macOS 26 environments are available). For GitHub Actions with Xcode 16.x, this may fail compilation. The GitHub Actions CI job should use the `PingScope-AppStore` scheme for compile+test, which targets macOS 13 (main app). The widget extension is only tested via the App Store scheme which requires Xcode 26 compatibility — might need to skip widget tests in GitHub Actions.

4. **`APPLE_INSTALLER_P12` secret — needed for pkg?**
   - What we know: The existing `production-release.yml` imports both a Developer ID Application cert AND a Developer ID Installer cert. The `deploy/sign-notarize.sh` script creates a `.pkg` using `productsign`.
   - What's unclear: The phase decisions say "Developer ID .dmg on GitHub Releases". A PKG is optional (per the script). Is PKG distribution still wanted?
   - Recommendation: Plan for DMG only (simpler). Keep the PKG optional — if installer cert is provided in secrets, create PKG too. The existing `deploy/sign-notarize.sh` already handles this gracefully.

---

## GitHub Secrets Required

| Secret Name | Content | Used By |
|-------------|---------|---------|
| `APPLE_CERTIFICATE_P12` | Base64-encoded Developer ID Application .p12 | GitHub Actions release workflow |
| `CERTIFICATE_PASSWORD` | Password for the .p12 | GitHub Actions release workflow |
| `APPLE_INSTALLER_P12` | Base64-encoded Developer ID Installer .p12 (optional) | GitHub Actions release workflow |
| `KEYCHAIN_PASSWORD` | Random string for temp keychain | GitHub Actions release workflow |
| `APPLE_ID` | Apple ID email for notarytool | GitHub Actions release workflow |
| `APPLE_APP_PASSWORD` | App-specific password for notarytool | GitHub Actions release workflow |
| `APPLE_TEAM_ID` | `6R7S5GA944` | GitHub Actions release workflow |
| `ASC_KEY_ID` | App Store Connect API key ID | Fastlane (local + Xcode Cloud optional) |
| `ASC_ISSUER_ID` | App Store Connect issuer ID | Fastlane (local + Xcode Cloud optional) |
| `ASC_KEY_CONTENT` | Base64-encoded .p8 API key content | Fastlane (local + Xcode Cloud optional) |

Note: `APPLE_CERTIFICATE_P12`, `CERTIFICATE_PASSWORD`, `APPLE_INSTALLER_P12`, `APPLE_ID`, `APPLE_APP_PASSWORD`, and `APPLE_TEAM_ID` already exist as secrets (per `production-release.yml`). They just need to be verified/updated for the new workflow.

---

## Sources

### Primary (HIGH confidence)
- Apple Developer Documentation — Xcode Cloud workflow reference, environment variable reference
- Apple Xcode Cloud Release Notes (xcloud.apple.com) — confirmed Notarize post-action (macOS, June 2023), available Xcode versions, CI_BUILD_NUMBER behavior
- GitHub Official Documentation — Installing Apple certificates on macOS runners (docs.github.com)
- fastlane docs (docs.fastlane.tools) — app_store_connect_api_key, build_mac_app, upload_to_testflight, upload_to_app_store
- Project source files — PingScope.xcodeproj/project.pbxproj, existing ci_scripts/, existing .github/workflows/

### Secondary (MEDIUM confidence)
- Vladimir Fedorov Xcode Cloud guide — Xcode Cloud workflow configuration details, macOS-specific notes (multiple sources agree)
- defn.io "Distributing Mac Apps with GitHub Actions" — xcodebuild archive + Developer ID export pattern (matches official docs)
- Federico Terzi "Automatic Code-signing and Notarization for macOS apps using GitHub Actions" — certificate import + notarytool pattern (verified against GitHub official docs)

### Tertiary (LOW confidence — flag for validation)
- Apple Developer Forums (thread/731656) — macOS App Groups behavior in CI; macOS handles App Groups differently from iOS (may not need provisioning profile App Groups entry)
- Stack Overflow — Xcode Cloud Developer ID codesign DMG limitation (confirmed pattern of cloud-managed cert inaccessibility in ci_scripts)

---

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH — tools are well-documented, versions verified
- Architecture patterns: MEDIUM-HIGH — Xcode Cloud is GUI-configured so no YAML to verify; GitHub Actions pattern is HIGH confidence
- Pitfalls: MEDIUM — several discovered from official docs, some from community sources
- Open questions: 4 identified, all with recommendations

**Research date:** 2026-02-23
**Valid until:** 2026-05-23 (Xcode Cloud changes infrequently; GitHub runner images change regularly — verify macos-15 Xcode versions before execution)
