---
phase: 17.1-use-xcode-cloud-with-this-and-fastlane-to-automate-builds-and-not-require-me-to-build-it-locally-or-use-xcode-locally
plan: 01
subsystem: infra
tags: [xcode-cloud, fastlane, ci-cd, app-store-connect, bundler, ruby, codesign]

# Dependency graph
requires: []
provides:
  - Xcode Cloud post-clone script (simplified, no version manipulation)
  - Xcode Cloud post-xcodebuild script with release tag detection and Fastlane trigger
  - Fastlane Gemfile pinning fastlane gem via Bundler
  - Fastlane Appfile with app identity (com.hadm.PingScope, team 6R7S5GA944)
  - Fastlane Fastfile with api_key (private), build_appstore, and submit_review lanes
affects: [xcode-cloud-workflow-activation, app-store-submission]

# Tech tracking
tech-stack:
  added: [fastlane, bundler]
  patterns:
    - ASC API key auth via environment variables (ASC_KEY_ID, ASC_ISSUER_ID, ASC_KEY_CONTENT)
    - release/* tag pattern triggers App Store submission (not main push)
    - Xcode Cloud manages version/build numbers natively (no plist manipulation in CI scripts)

key-files:
  created:
    - Gemfile
    - fastlane/Appfile
    - fastlane/Fastfile
  modified:
    - ci_scripts/ci_post_clone.sh
    - ci_scripts/ci_post_xcodebuild.sh

key-decisions:
  - "ci_post_clone.sh: removed PlistBuddy/CFBundleVersion manipulation — Xcode Cloud manages build numbers via CI_BUILD_NUMBER and MARKETING_VERSION build setting"
  - "ci_post_xcodebuild.sh: removed ExportOptions.plist writing — Xcode Cloud handles export internally via workflow configuration, not external plist"
  - "Release tag pattern ^release/[0-9]+\\.[0-9]+\\.[0-9]+$ triggers Fastlane submit_review (not git tag v* pattern)"
  - "submit_review lane uses deliver with skip_binary_upload:true — binary already uploaded by Xcode Cloud, only submission trigger needed"
  - "apple_id omitted from Appfile — all automation uses ASC API key auth, not password-based auth"

patterns-established:
  - "Pattern CI-scripts: Xcode Cloud scripts are thin orchestration wrappers — no version manipulation, no export config duplication"
  - "Pattern Fastlane-auth: ASC API key loaded from environment variables, never hardcoded"
  - "Pattern Submit-flow: Xcode Cloud builds and uploads to TestFlight, Fastlane only triggers review submission"

requirements-completed: [CI-01, CI-02, CI-03]

# Metrics
duration: 3min
completed: 2026-02-24
---

# Phase 17.1 Plan 01: Xcode Cloud CI Scripts + Fastlane Setup Summary

**Replaced broken Xcode Cloud CI scripts (PlistBuddy version manipulation, ExportOptions.plist writing) with correct implementations and created complete Fastlane stack (Gemfile/Appfile/Fastfile) for App Store submission via ASC API key auth.**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-24T01:25:48Z
- **Completed:** 2026-02-24T01:28:40Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments

- Removed two bugs from existing CI scripts: PlistBuddy version manipulation (wrong path, breaks Xcode Cloud's native version management) and ExportOptions.plist writing (not how Xcode Cloud exports — it handles this internally via workflow configuration)
- ci_post_xcodebuild.sh now detects release/* tag pattern and triggers `bundle exec fastlane submit_review` with ASC API key validation, while main branch pushes correctly skip submission
- Created complete Fastlane configuration: Gemfile (bundler pin), Appfile (app identity), Fastfile (api_key private lane + build_appstore + submit_review lanes using deliver with skip_binary_upload)

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix CI scripts** - `0c9cda3` (fix)
2. **Task 2: Create Fastlane setup** - `2e91058` (feat)

## Files Created/Modified

- `ci_scripts/ci_post_clone.sh` - Simplified: removed PlistBuddy calls, logs CI env vars only
- `ci_scripts/ci_post_xcodebuild.sh` - Fixed: removed ExportOptions.plist, added release tag detection and Fastlane trigger, preserved codesign verification
- `Gemfile` - Fastlane dependency pinning via Bundler
- `fastlane/Appfile` - App identity: com.hadm.PingScope, team 6R7S5GA944, no apple_id
- `fastlane/Fastfile` - Three lanes: private api_key (ASC env vars), build_appstore (local gym), submit_review (deliver skip_binary_upload)

## Decisions Made

- Removed PlistBuddy manipulation: Xcode Cloud automatically sets CFBundleVersion from CI_BUILD_NUMBER and reads MARKETING_VERSION from build settings — manual plist writes corrupt this
- Removed ExportOptions.plist: Xcode Cloud workflow configuration handles export method, signing style, and destination — writing a plist to DerivedData has no effect and creates false confidence
- ASC API key auth only (no apple_id in Appfile): Password-based auth is deprecated and insecure; all automation uses the three env vars pattern
- `skip_binary_upload: true` in submit_review: Binary upload is Xcode Cloud's job — Fastlane only needs to trigger the review submission after the build is already in TestFlight

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

**External services require manual configuration before the pipeline is operational:**

1. Create an App Store Connect API key (Admin role) at appstoreconnect.apple.com > Users and Access > Integrations > API Keys
2. Add three environment variables to the Xcode Cloud workflow in App Store Connect > Xcode Cloud > [Workflow] > Environment:
   - `ASC_KEY_ID` — the API key ID
   - `ASC_ISSUER_ID` — the issuer ID
   - `ASC_KEY_CONTENT` — base64-encoded contents of the .p8 key file (`base64 -i AuthKey_XXXXXXXX.p8 | tr -d '\n'`)
3. Configure the Xcode Cloud workflow in App Store Connect (start branch: main, archive + TestFlight distribution)
4. To trigger App Store submission: push a tag matching `release/x.y.z` pattern

## Next Phase Readiness

- Repository is code-complete for Xcode Cloud activation
- Next step is configuring the Xcode Cloud workflow in App Store Connect UI (manual step)
- Developer can run `bundle exec fastlane build_appstore` locally to build without opening Xcode IDE

## Self-Check: PASSED

- FOUND: ci_scripts/ci_post_clone.sh
- FOUND: ci_scripts/ci_post_xcodebuild.sh
- FOUND: Gemfile
- FOUND: fastlane/Appfile
- FOUND: fastlane/Fastfile
- FOUND: 17.1-01-SUMMARY.md
- FOUND commit 0c9cda3: fix(17.1-01): replace broken CI scripts
- FOUND commit 2e91058: feat(17.1-01): add Fastlane configuration

---
*Phase: 17.1-use-xcode-cloud-with-this-and-fastlane-to-automate-builds-and-not-require-me-to-build-it-locally-or-use-xcode-locally*
*Completed: 2026-02-24*
