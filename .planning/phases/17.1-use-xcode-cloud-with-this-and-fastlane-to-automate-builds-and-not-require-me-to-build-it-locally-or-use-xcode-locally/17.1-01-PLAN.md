---
phase: 17.1-use-xcode-cloud-with-this-and-fastlane-to-automate-builds-and-not-require-me-to-build-it-locally-or-use-xcode-locally
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ci_scripts/ci_post_clone.sh
  - ci_scripts/ci_post_xcodebuild.sh
  - Gemfile
  - fastlane/Appfile
  - fastlane/Fastfile
autonomous: true
requirements:
  - CI-01
  - CI-02
  - CI-03

must_haves:
  truths:
    - "Pushing to main triggers a TestFlight build in Xcode Cloud (no manual steps)"
    - "Pushing a release/x.y.z tag triggers App Store submission via Fastlane automatically"
    - "Fastlane can be run locally with `bundle exec fastlane submit_review` without needing Xcode open"
    - "ci_post_clone.sh does not corrupt build numbers (Xcode Cloud manages version automatically)"
    - "ci_post_xcodebuild.sh triggers Fastlane submit_review when CI_TAG matches release/* pattern"
  artifacts:
    - path: "Gemfile"
      provides: "Fastlane dependency pinning via Bundler"
      contains: "gem \"fastlane\""
    - path: "fastlane/Appfile"
      provides: "App identity configuration for Fastlane"
      contains: "com.hadm.PingScope"
    - path: "fastlane/Fastfile"
      provides: "Fastlane lane definitions for ASC API auth, build, and submission"
      exports: ["api_key", "build_appstore", "submit_review"]
    - path: "ci_scripts/ci_post_clone.sh"
      provides: "Xcode Cloud post-clone hook (simplified, no version manipulation)"
    - path: "ci_scripts/ci_post_xcodebuild.sh"
      provides: "Xcode Cloud post-build hook triggering Fastlane on release tag"
  key_links:
    - from: "ci_scripts/ci_post_xcodebuild.sh"
      to: "fastlane submit_review"
      via: "bundle exec fastlane submit_review when CI_TAG matches release/* and CI_XCODEBUILD_ACTION=archive"
      pattern: "CI_TAG.*release"
    - from: "fastlane/Fastfile"
      to: "App Store Connect API"
      via: "app_store_connect_api_key with ASC_KEY_ID, ASC_ISSUER_ID, ASC_KEY_CONTENT env vars"
      pattern: "app_store_connect_api_key"
---

<objective>
Set up Fastlane configuration and fix Xcode Cloud CI scripts so the automated build pipeline is code-complete and ready for Xcode Cloud workflow configuration.

Purpose: The existing ci_scripts contain two bugs (wrong version manipulation in post_clone, incorrect ExportOptions writing in post_xcodebuild) that will break Xcode Cloud builds. Fastlane is not yet configured at all. This plan fixes the scripts and creates the Fastlane setup, making the repository ready for Xcode Cloud workflow activation.

Output: Working ci_scripts + Fastlane stack (Gemfile, Appfile, Fastfile) committed to repo.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17.1-use-xcode-cloud-with-this-and-fastlane-to-automate-builds-and-not-require-me-to-build-it-locally-or-use-xcode-locally/17.1-CONTEXT.md
@.planning/phases/17.1-use-xcode-cloud-with-this-and-fastlane-to-automate-builds-and-not-require-me-to-build-it-locally-or-use-xcode-locally/17.1-RESEARCH.md

Key decisions (CONTEXT.md locked):
- Xcode Cloud owns all CI/CD for App Store builds
- Fastlane owns App Store Connect API auth and submit_review lane
- GitHub Actions and Developer ID automation are OUT OF SCOPE for this phase
- Push to main → TestFlight (Xcode Cloud workflow)
- Push release/x.y.z tag → App Store submission via Fastlane in ci_post_xcodebuild.sh

Existing files that need to be FIXED (not replaced wholesale — preserve structure):
- ci_scripts/ci_post_clone.sh: Currently writes to wrong Info.plist path and sets wrong version format
- ci_scripts/ci_post_xcodebuild.sh: Currently writes ExportOptions.plist (not how Xcode Cloud works); needs to call Fastlane on release tag
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ci_scripts — replace broken version manipulation and ExportOptions writing</name>
  <files>
    ci_scripts/ci_post_clone.sh
    ci_scripts/ci_post_xcodebuild.sh
  </files>
  <action>
Replace both ci_scripts with correct implementations per RESEARCH.md patterns (Pattern 5).

**ci_scripts/ci_post_clone.sh** — Replace entirely with the simplified version:
```bash
#!/bin/sh
# Xcode Cloud Post-Clone Script
# Runs after the repository is cloned.
#
# Build number (CFBundleVersion) is managed automatically by Xcode Cloud via
# the CI_BUILD_NUMBER environment variable and App Store Connect product settings.
# Marketing version (CFBundleShortVersionString) is set in the Xcode project's
# MARKETING_VERSION build setting — no manual plist manipulation needed here.

set -e

echo "Post-clone: Xcode Cloud environment ready."
echo "  CI_BUILD_NUMBER: ${CI_BUILD_NUMBER:-unset}"
echo "  CI_TAG:          ${CI_TAG:-unset}"
echo "  CI_BRANCH:       ${CI_BRANCH:-unset}"
echo "  CI_WORKFLOW:     ${CI_WORKFLOW:-unset}"
```

**ci_scripts/ci_post_xcodebuild.sh** — Replace entirely with the corrected version that:
1. Removes the ExportOptions.plist writing (Xcode Cloud handles export internally)
2. Adds release-tag detection to trigger Fastlane submit_review
3. Keeps the codesign verification logic (it's correct)

```bash
#!/bin/sh
# Xcode Cloud Post-Xcodebuild Script
# Runs after xcodebuild completes.
#
# On release/* tag builds: calls Fastlane submit_review to submit
# the latest TestFlight build for App Store review via ASC API.
# Requires Xcode Cloud environment variables: ASC_KEY_ID, ASC_ISSUER_ID, ASC_KEY_CONTENT

set -e

echo "Post-xcodebuild: CI_XCODEBUILD_ACTION=${CI_XCODEBUILD_ACTION:-unset}"

if [ "$CI_XCODEBUILD_ACTION" = "archive" ]; then
  echo "Archive completed. Verifying code signing..."

  APP_PATH="$CI_ARCHIVE_PATH/Products/Applications/PingScope.app"
  if [ -d "$APP_PATH" ]; then
    codesign --verify --deep --strict --verbose=2 "$APP_PATH"
    codesign -d --entitlements - "$APP_PATH" 2>&1 || true
    echo "Code signing verification passed."
  else
    echo "Warning: Archive app not found at expected path: $APP_PATH"
    echo "Available paths in archive:"
    ls "$CI_ARCHIVE_PATH/Products/" 2>/dev/null || true
  fi

  # Auto-submit for App Store review on release tag builds
  # Trigger: CI_TAG must match release/x.y.z pattern
  if echo "$CI_TAG" | grep -qE '^release/[0-9]+\.[0-9]+\.[0-9]+$'; then
    echo "Release tag detected: $CI_TAG — triggering App Store submission via Fastlane"

    # Verify required ASC API env vars are present
    if [ -z "$ASC_KEY_ID" ] || [ -z "$ASC_ISSUER_ID" ] || [ -z "$ASC_KEY_CONTENT" ]; then
      echo "ERROR: ASC_KEY_ID, ASC_ISSUER_ID, and ASC_KEY_CONTENT must be set in Xcode Cloud environment variables."
      echo "Configure these in App Store Connect > Xcode Cloud > [Workflow] > Environment."
      exit 1
    fi

    # Install Fastlane via Bundler
    cd "$CI_PRIMARY_REPOSITORY_PATH"
    gem install bundler --quiet
    bundle install --quiet

    # Submit latest build for App Store review
    bundle exec fastlane submit_review
    echo "App Store submission triggered successfully."
  else
    echo "Non-release build (CI_TAG=${CI_TAG:-none}) — skipping App Store submission."
  fi
fi

echo "Post-xcodebuild completed."
```

Make both scripts executable:
```bash
chmod +x ci_scripts/ci_post_clone.sh
chmod +x ci_scripts/ci_post_xcodebuild.sh
```
  </action>
  <verify>
    <automated>cd /Users/keith/src/pingscope && bash -n ci_scripts/ci_post_clone.sh && echo "ci_post_clone.sh: syntax OK" && bash -n ci_scripts/ci_post_xcodebuild.sh && echo "ci_post_xcodebuild.sh: syntax OK" && grep -q "PlistBuddy" ci_scripts/ci_post_clone.sh && echo "FAIL: old PlistBuddy code still present" || echo "PASS: no PlistBuddy manipulation" && grep -q "release/" ci_scripts/ci_post_xcodebuild.sh && echo "PASS: release tag detection present" || echo "FAIL: missing release tag detection"</automated>
    <manual>Verify ci_post_clone.sh has no PlistBuddy calls and ci_post_xcodebuild.sh has no ExportOptions.plist writing. Confirm grep for "release/" succeeds.</manual>
  </verify>
  <done>
    - ci_post_clone.sh: No PlistBuddy calls, no CFBundleVersion manipulation, prints CI env vars only
    - ci_post_xcodebuild.sh: No ExportOptions.plist creation, codesign verification present, release/* tag detection triggers `bundle exec fastlane submit_review`
    - Both scripts have executable bit set
    - Both pass `bash -n` syntax check
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Fastlane setup (Gemfile, Appfile, Fastfile)</name>
  <files>
    Gemfile
    fastlane/Appfile
    fastlane/Fastfile
  </files>
  <action>
Create three files for Fastlane configuration per RESEARCH.md Pattern 4.

**Gemfile** (project root — create new file):
```ruby
# frozen_string_literal: true

source "https://rubygems.org"

gem "fastlane"
```

**fastlane/Appfile** (create directory + file):
```ruby
# fastlane/Appfile
# App identity — used by Fastlane actions that need app_identifier or team_id.
# apple_id is intentionally omitted: all automation uses ASC API key auth (not password).

app_identifier("com.hadm.PingScope")
team_id("6R7S5GA944")
```

**fastlane/Fastfile** (create file):
```ruby
# fastlane/Fastfile
# Lanes for PingScope CI/CD automation.
#
# Environment variables required for API key lanes:
#   ASC_KEY_ID      — App Store Connect API key ID
#   ASC_ISSUER_ID   — App Store Connect issuer ID
#   ASC_KEY_CONTENT — Base64-encoded .p8 API key content
#
# Usage:
#   bundle exec fastlane submit_review     # Submit latest build for App Store review
#   bundle exec fastlane build_appstore    # Build App Store archive locally

default_platform(:mac)

platform :mac do

  # ── Private: ASC API key authentication ──────────────────────────────────────
  desc "Load App Store Connect API key from environment variables"
  private_lane :api_key do
    app_store_connect_api_key(
      key_id:              ENV["ASC_KEY_ID"],
      issuer_id:           ENV["ASC_ISSUER_ID"],
      key_content:         ENV["ASC_KEY_CONTENT"],
      is_key_content_base64: true,
      in_house:            false
    )
  end

  # ── Build: App Store archive (local use — no Xcode IDE required) ─────────────
  desc "Build App Store archive locally using xcodebuild via fastlane gym"
  lane :build_appstore do
    build_mac_app(
      project:          "PingScope.xcodeproj",
      scheme:           "PingScope-AppStore",
      configuration:    "Release",
      export_method:    "app-store",
      output_directory: "./build",
      output_name:      "PingScope.pkg"
    )
  end

  # ── Submit: trigger App Store review for the latest processed build ──────────
  desc "Submit the latest TestFlight build for App Store review (no binary upload)"
  lane :submit_review do
    key = api_key
    deliver(
      api_key:               key,
      submit_for_review:     true,
      automatic_release:     false,
      force:                 true,
      skip_metadata:         true,
      skip_screenshots:      true,
      skip_binary_upload:    true,
      platform:              "osx"
    )
  end

end
```

After creating files, run `bundle install` to generate Gemfile.lock:
```bash
cd /Users/keith/src/pingscope
gem install bundler --quiet 2>/dev/null || true
bundle install
```

Note: If `bundle install` fails because Ruby/bundler is not available in this environment, skip this step — Gemfile.lock will be generated during first Xcode Cloud run or when developer runs `bundle install` locally. The Gemfile itself is what matters for committing.
  </action>
  <verify>
    <automated>cd /Users/keith/src/pingscope && test -f Gemfile && echo "PASS: Gemfile exists" && test -f fastlane/Appfile && echo "PASS: Appfile exists" && test -f fastlane/Fastfile && echo "PASS: Fastfile exists" && grep -q "com.hadm.PingScope" fastlane/Appfile && echo "PASS: correct bundle ID" && grep -q "6R7S5GA944" fastlane/Appfile && echo "PASS: correct team ID" && grep -q "submit_review" fastlane/Fastfile && echo "PASS: submit_review lane present" && grep -q "ASC_KEY_CONTENT" fastlane/Fastfile && echo "PASS: ASC API key env vars referenced"</automated>
    <manual>Open fastlane/Fastfile and confirm the submit_review lane calls deliver with submit_for_review: true and skip_binary_upload: true.</manual>
  </verify>
  <done>
    - Gemfile exists at project root with `gem "fastlane"`
    - fastlane/Appfile has correct app_identifier (com.hadm.PingScope) and team_id (6R7S5GA944)
    - fastlane/Fastfile has three items: private api_key lane, build_appstore lane, submit_review lane
    - submit_review lane uses ASC_KEY_ID/ASC_ISSUER_ID/ASC_KEY_CONTENT env vars (not Apple ID password)
    - submit_review lane uses deliver with skip_binary_upload: true and platform: "osx"
    - Gemfile.lock generated if bundler available (optional at this stage)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. `bash -n ci_scripts/ci_post_clone.sh` — syntax passes
2. `bash -n ci_scripts/ci_post_xcodebuild.sh` — syntax passes
3. `grep -c "PlistBuddy" ci_scripts/ci_post_clone.sh` — returns 0
4. `grep -c "ExportOptions" ci_scripts/ci_post_xcodebuild.sh` — returns 0
5. `grep "release/" ci_scripts/ci_post_xcodebuild.sh` — returns match on tag pattern check
6. `test -f Gemfile && test -f fastlane/Appfile && test -f fastlane/Fastfile` — all exist
7. `grep "submit_for_review: true" fastlane/Fastfile` — returns match
8. `grep "skip_binary_upload: true" fastlane/Fastfile` — returns match
</verification>

<success_criteria>
- ci_scripts are correct and will not break Xcode Cloud builds
- Fastlane is configured with API key auth and submit_review lane
- On release/x.y.z tag: ci_post_xcodebuild.sh installs Bundler, runs `bundle exec fastlane submit_review`
- On main push: ci_post_xcodebuild.sh skips submission (no CI_TAG match)
- Developer can run `bundle exec fastlane build_appstore` locally without opening Xcode
- All files pass syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/17.1-use-xcode-cloud-with-this-and-fastlane-to-automate-builds-and-not-require-me-to-build-it-locally-or-use-xcode-locally/17.1-01-SUMMARY.md`
</output>
