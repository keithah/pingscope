---
phase: 03-host-monitoring
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Sources/PingMonitor/Services/GatewayDetector.swift
autonomous: true

must_haves:
  truths:
    - "Default gateway IP is detected via sysctl routing table"
    - "Network changes are detected via NWPathMonitor"
    - "WiFi SSID is retrieved when available for network-aware naming"
    - "Gateway updates are debounced to prevent thrashing"
  artifacts:
    - path: "Sources/PingMonitor/Services/GatewayDetector.swift"
      provides: "Gateway detection and network monitoring"
      exports: ["GatewayDetector", "GatewayInfo"]
      min_lines: 100
  key_links:
    - from: "Sources/PingMonitor/Services/GatewayDetector.swift"
      to: "NWPathMonitor"
      via: "pathUpdateHandler callback"
      pattern: "pathUpdateHandler"
---

<objective>
Create the GatewayDetector service that monitors network changes and detects the default gateway IP with network-aware naming.

Purpose: Per CONTEXT.md, the gateway should show "Home Wi-Fi Gateway" when network name is available, and update in real-time when network changes. This is the foundation for HOST-02 (auto-detect default gateway).

Output: GatewayDetector actor with network monitoring, gateway IP detection via sysctl, WiFi SSID retrieval, and debounced updates.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-host-monitoring/03-CONTEXT.md
@.planning/phases/03-host-monitoring/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement GatewayInfo and gateway detection</name>
  <files>
    Sources/PingMonitor/Services/GatewayDetector.swift
  </files>
  <action>
Create `GatewayDetector.swift` with:

1. `GatewayInfo` struct (Sendable, Equatable):
   - `ipAddress: String` (empty string if unavailable)
   - `interfaceName: String?` (e.g., "en0")
   - `networkName: String?` (WiFi SSID if available)
   - Computed `isAvailable: Bool` = !ipAddress.isEmpty
   - Computed `displayName: String`:
     - If networkName present: "\(networkName) Gateway"
     - Else if ipAddress present: ipAddress
     - Else: "No Network"
   - `static let unavailable` = GatewayInfo(ipAddress: "", interfaceName: nil, networkName: nil)

2. Private function `getDefaultGateway() -> (ip: String, interface: String?)?`:
   - Use sysctl with mib: [CTL_NET, PF_ROUTE, 0, AF_INET, NET_RT_FLAGS, RTF_GATEWAY]
   - First call sysctl with nil buffer to get required size
   - Allocate buffer and call again
   - Parse rt_msghdr structures to find default route (destination 0.0.0.0)
   - Extract gateway IP from sockaddr_in structure
   - Return gateway IP as dotted-decimal string and interface name
   - Return nil if no default gateway found
   - IMPORTANT: Run on background thread, not main actor

3. Private function `getCurrentSSID() -> String?`:
   - Import CoreWLAN
   - Use CWWiFiClient.shared().interface()?.ssid()
   - Return nil if unavailable (graceful degradation per RESEARCH.md)
   - Note: May require Location permissions on macOS 15.3+ - degrade gracefully

4. `GatewayDetector` actor:
   - Private `pathMonitor: NWPathMonitor`
   - Private `monitorQueue: DispatchQueue` (label: "GatewayDetector")
   - Private `debounceTask: Task<Void, Never>?`
   - Private `debounceInterval: Duration = .milliseconds(200)` (per RESEARCH.md)
   - `currentGateway: GatewayInfo` (published state)

5. Actor methods:
   - `func startMonitoring() -> AsyncStream<GatewayInfo>`:
     - Set up pathUpdateHandler on pathMonitor
     - On each path update, debounce then resolve gateway
     - Yield GatewayInfo to stream
     - Start monitor on monitorQueue
   - `func stopMonitoring()`:
     - Cancel pathMonitor
     - Cancel debounceTask
   - Private `func resolveGateway() async -> GatewayInfo`:
     - Call getDefaultGateway() on background
     - Call getCurrentSSID() on background
     - Combine into GatewayInfo

Use `import Darwin` for sysctl, `import Network` for NWPathMonitor, `import CoreWLAN` for WiFi.
  </action>
  <verify>
`swift build` compiles. Note: Actual gateway detection requires running on macOS - unit testing would need mocking.
  </verify>
  <done>
GatewayDetector actor exists with startMonitoring() returning AsyncStream of GatewayInfo. Gateway IP detected via sysctl. WiFi SSID retrieved via CoreWLAN. Updates debounced at 200ms.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add network path status handling</name>
  <files>
    Sources/PingMonitor/Services/GatewayDetector.swift
  </files>
  <action>
Enhance GatewayDetector to handle network unavailability:

1. In pathUpdateHandler, check `path.status`:
   - If `.satisfied`: debounce then resolve gateway
   - If `.unsatisfied` or `.requiresConnection`: immediately yield GatewayInfo.unavailable (no debounce for disconnection)

2. Add `isNetworkAvailable: Bool` computed property:
   - Returns true if currentGateway.isAvailable

3. Add helper for "Network changed" indicator support (will be wired in Plan 06):
   - Track `previousNetworkName: String?`
   - Computed `networkJustChanged: Bool` that compares current vs previous
   - Method `acknowledgeNetworkChange()` to clear the flag

4. Ensure thread safety:
   - Gateway resolution runs on background queue
   - State updates happen within actor isolation
   - SSID lookup can block briefly; don't run on main thread
  </action>
  <verify>
`swift build` compiles. GatewayDetector handles both connected and disconnected states.
  </verify>
  <done>
GatewayDetector yields .unavailable immediately on network loss. Network change tracking added for future "Network changed" indicator. All gateway resolution runs on background thread.
  </done>
</task>

</tasks>

<verification>
- `swift build` compiles without errors
- GatewayDetector.swift exists in Services/
- AsyncStream<GatewayInfo> returned from startMonitoring()
- Debounce prevents rapid updates during network transitions
</verification>

<success_criteria>
- GatewayInfo struct with displayName computed property
- Gateway IP detection via sysctl (not NWPath.gateways per RESEARCH.md pitfall)
- WiFi SSID retrieval via CoreWLAN with graceful degradation
- NWPathMonitor setup with 200ms debouncing
- Immediate .unavailable on network loss (no debounce for disconnection)
</success_criteria>

<output>
After completion, create `.planning/phases/03-host-monitoring/03-02-SUMMARY.md`
</output>
