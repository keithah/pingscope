---
phase: 03-host-monitoring
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - Sources/PingMonitor/Services/PingService.swift
  - Sources/PingMonitor/Services/ConnectionWrapper.swift
autonomous: true

must_haves:
  truths:
    - "ICMP-simulated ping tries ports 53, 80, 443, 22, 25 in sequence until success"
    - "TCP ping uses configurable port (default 80)"
    - "UDP ping uses configurable port (default 53)"
    - "All three ping methods work through PingService.ping(host:)"
  artifacts:
    - path: "Sources/PingMonitor/Services/PingService.swift"
      provides: "Ping execution with all three methods"
      contains: "icmpSimulated"
    - path: "Sources/PingMonitor/Services/ConnectionWrapper.swift"
      provides: "Low-level connection measurement"
      contains: "measureConnection"
  key_links:
    - from: "Sources/PingMonitor/Services/PingService.swift"
      to: "PingMethod"
      via: "switch on host.pingMethod"
      pattern: "switch.*pingMethod"
---

<objective>
Update PingService to support all three ping methods: TCP, UDP, and ICMP-simulated (TCP probe sequence).

Purpose: This implements HOST-03, HOST-04, HOST-05. The ICMP-simulated method probes common ports in sequence to simulate ICMP behavior without raw sockets (per App Store sandbox constraint).

Output: PingService that handles all three ping methods based on Host.pingMethod.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-host-monitoring/03-CONTEXT.md
@.planning/phases/03-host-monitoring/03-RESEARCH.md

@Sources/PingMonitor/Services/PingService.swift
@Sources/PingMonitor/Services/ConnectionWrapper.swift
@Sources/PingMonitor/Models/Host.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update PingService for new ping methods</name>
  <files>
    Sources/PingMonitor/Services/PingService.swift
  </files>
  <action>
Update PingService to use PingMethod instead of Host.ProtocolType:

1. Update `ping(host:)` to switch on `host.pingMethod`:
   - `.tcp`: Use TCP NWParameters with host.port
   - `.udp`: Use UDP NWParameters with host.port
   - `.icmpSimulated`: Call new `pingICMPSimulated` method

2. Add private method `pingICMPSimulated(host:timeout:) async -> PingResult`:
   - Define ports array: [53, 80, 443, 22, 25] (DNS, HTTP, HTTPS, SSH, SMTP)
   - Try each port in sequence using TCP connection
   - Return first successful result
   - If all fail, return last failure result
   - Use same timeout for each attempt (not cumulative)

3. Update the overloaded `ping(address:port:protocolType:timeout:)` method:
   - Replace `protocolType: Host.ProtocolType` parameter with `pingMethod: PingMethod`
   - Handle only .tcp and .udp (ICMP-simulated uses the port sequence, not single port)

4. Remove any references to `Host.ProtocolType` (now using PingMethod)

Note: The existing timeout racing with withThrowingTaskGroup remains unchanged - that pattern works well.
  </action>
  <verify>
`swift build` compiles without errors. PingService supports all three ping methods.
  </verify>
  <done>
PingService.ping(host:) handles .tcp, .udp, and .icmpSimulated ping methods. ICMP-simulated tries ports 53, 80, 443, 22, 25 in sequence.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix downstream compilation errors</name>
  <files>
    Sources/PingMonitor/Services/PingService.swift
  </files>
  <action>
Ensure all existing code compiles with the PingMethod change:

1. Check if any other files reference `Host.ProtocolType`:
   - The only usage should be in Host.swift (removed in Plan 01)
   - And PingService.swift (updated in Task 1)

2. Verify ConnectionWrapper doesn't need changes:
   - It takes NWParameters directly, not protocol type
   - Should still work as-is

3. If tests exist that use ProtocolType:
   - Update test helpers to use PingMethod
   - Tests in PingServiceTests.swift may need updates

4. Run `swift build` to catch any remaining references
  </action>
  <verify>
`swift build` compiles without errors across entire project.
  </verify>
  <done>
Project builds cleanly. All references to Host.ProtocolType replaced with PingMethod.
  </done>
</task>

</tasks>

<verification>
- `swift build` compiles without errors
- `swift test` passes (may need test updates)
- PingService handles all three ping methods
</verification>

<success_criteria>
- ICMP-simulated ping tries ports [53, 80, 443, 22, 25] in sequence
- TCP ping uses host.port with TCP NWParameters
- UDP ping uses host.port with UDP NWParameters
- Project compiles cleanly with PingMethod replacing ProtocolType
</success_criteria>

<output>
After completion, create `.planning/phases/03-host-monitoring/03-03-SUMMARY.md`
</output>
