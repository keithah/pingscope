---
phase: 03-host-monitoring
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - Sources/PingMonitor/Services/HostStore.swift
autonomous: true

must_haves:
  truths:
    - "Hosts persist across app restarts via UserDefaults"
    - "Custom hosts can be added, updated, and deleted"
    - "Default hosts (isDefault: true) cannot be deleted"
    - "Default hosts are always present even if no custom hosts saved"
  artifacts:
    - path: "Sources/PingMonitor/Services/HostStore.swift"
      provides: "Host CRUD and persistence"
      exports: ["HostStore"]
      min_lines: 80
  key_links:
    - from: "Sources/PingMonitor/Services/HostStore.swift"
      to: "UserDefaults"
      via: "JSONEncoder/Decoder"
      pattern: "JSONEncoder|JSONDecoder"
---

<objective>
Create the HostStore actor for CRUD operations and UserDefaults persistence of hosts.

Purpose: This implements HOST-09 (add, edit, delete) and HOST-10 (default hosts protected). The store manages the host list with persistence while protecting default hosts from deletion.

Output: HostStore actor with add/update/remove methods and automatic persistence.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-host-monitoring/03-CONTEXT.md
@.planning/phases/03-host-monitoring/03-RESEARCH.md

@Sources/PingMonitor/Models/Host.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HostStore actor with CRUD operations</name>
  <files>
    Sources/PingMonitor/Services/HostStore.swift
  </files>
  <action>
Create `HostStore.swift`:

1. `HostStore` actor:
   - Private `defaults: UserDefaults = .standard`
   - Private `key: String = "pingmonitor.savedHosts"`
   - Private(set) `hosts: [Host]` (all hosts including defaults)
   - Private(set) `gatewayHost: Host?` (special gateway host, managed separately)

2. Initializer:
   - Load persisted hosts from UserDefaults
   - If no persisted hosts, use Host.defaults (Google DNS, Cloudflare)
   - Ensure default hosts are always present (merge with persisted)
   - Gateway host is NOT persisted (it's auto-detected)

3. Private persistence methods:
   - `func loadHosts() -> [Host]`:
     - Get data from UserDefaults for key
     - Decode with JSONDecoder
     - Return empty array if decode fails or no data
   - `func persistHosts()`:
     - Encode hosts array with JSONEncoder
     - Save to UserDefaults
     - Only persist non-gateway hosts

4. CRUD methods:
   - `func add(_ host: Host)`:
     - Append to hosts array
     - Call persistHosts()
   - `func update(_ host: Host)`:
     - Find by id and replace
     - Call persistHosts()
     - If host.isDefault, still allow updating overrides (but not deleting)
   - `func remove(_ host: Host)`:
     - Guard !host.isDefault (cannot delete defaults per HOST-10)
     - Remove by id
     - Call persistHosts()
   - `func removeAt(offsets: IndexSet)`:
     - For List onDelete support
     - Only remove non-default hosts

5. Gateway management (separate from CRUD):
   - `func setGatewayHost(_ info: GatewayInfo)`:
     - Create Host from GatewayInfo with isDefault: true
     - Set gatewayHost property
     - Does NOT persist (gateway is ephemeral)
   - `func clearGatewayHost()`:
     - Set gatewayHost to nil

6. Computed property:
   - `var allHosts: [Host]`:
     - Returns hosts + gatewayHost (if present)
     - Gateway appears after defaults, before custom hosts
  </action>
  <verify>
`swift build` compiles. HostStore provides CRUD with persistence.
  </verify>
  <done>
HostStore actor exists with add/update/remove methods. Hosts persist to UserDefaults via Codable. Default hosts protected from deletion. Gateway host managed separately (not persisted).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add host validation and merging</name>
  <files>
    Sources/PingMonitor/Services/HostStore.swift
  </files>
  <action>
Add validation and default merging logic:

1. Add `func ensureDefaultsPresent()`:
   - Check if Google DNS and Cloudflare exist in hosts array
   - If missing, prepend them (by matching isDefault flag and name)
   - Called during init and after any load

2. Add host validation helper:
   - `func isValidHost(_ host: Host) -> Bool`:
     - Name is non-empty
     - Address is non-empty
     - Port is > 0
   - Used before add/update to prevent invalid hosts

3. Add duplicate detection:
   - `func hostExists(address: String, port: UInt16) -> Bool`:
     - Check if host with same address+port exists
     - Used by UI to warn (but not block per CONTEXT.md) on duplicate

4. Add ordering support:
   - Defaults (isDefault: true) always appear first
   - Gateway appears after other defaults
   - Custom hosts appear in order added
   - `func sortedHosts() -> [Host]` returns properly ordered list
  </action>
  <verify>
`swift build` compiles. Default hosts always present. Host validation works.
  </verify>
  <done>
HostStore ensures defaults are always present. Validation prevents empty names/addresses. Hosts are ordered with defaults first, then gateway, then custom.
  </done>
</task>

</tasks>

<verification>
- `swift build` compiles without errors
- HostStore.swift exists in Services/
- Default hosts cannot be deleted (guarded)
- Hosts persist to UserDefaults
</verification>

<success_criteria>
- HostStore actor with add/update/remove methods
- UserDefaults persistence via JSONEncoder/JSONDecoder
- Default hosts (isDefault: true) protected from deletion
- Gateway host managed separately (not persisted)
- Default hosts always present even on first launch
</success_criteria>

<output>
After completion, create `.planning/phases/03-host-monitoring/03-04-SUMMARY.md`
</output>
