---
phase: 03-host-monitoring
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - Sources/PingMonitor/MenuBar/MenuBarStatusEvaluator.swift
  - Sources/PingMonitor/ViewModels/MenuBarViewModel.swift
  - Sources/PingMonitor/MenuBar/MenuBarRuntime.swift
  - Tests/PingMonitorTests/MenuBarViewModelTests.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can configure per-host latency thresholds and status evaluation uses those thresholds"
    - "Switching selected host immediately changes status boundaries to that host's effective thresholds"
    - "Global defaults are used only when a host does not define threshold overrides"
  artifacts:
    - path: "Sources/PingMonitor/MenuBar/MenuBarStatusEvaluator.swift"
      provides: "Threshold-aware status evaluation for green/yellow/red"
      contains: "greenThresholdMS|yellowThresholdMS"
    - path: "Sources/PingMonitor/ViewModels/MenuBarViewModel.swift"
      provides: "Selected-host threshold state wired into status computation"
      contains: "setSelectedHost"
    - path: "Sources/PingMonitor/MenuBar/MenuBarRuntime.swift"
      provides: "Selection flow that pushes effective host thresholds into MenuBarViewModel"
      contains: "syncSelection"
    - path: "Tests/PingMonitorTests/MenuBarViewModelTests.swift"
      provides: "Regression tests for host-specific threshold behavior"
      contains: "threshold"
  key_links:
    - from: "Sources/PingMonitor/MenuBar/MenuBarRuntime.swift"
      to: "Sources/PingMonitor/ViewModels/MenuBarViewModel.swift"
      via: "setSelectedHost with host + global defaults"
      pattern: "setSelectedHost"
      enables_truths:
        - "Switching selected host immediately changes status boundaries to that host's effective thresholds"
    - from: "Sources/PingMonitor/ViewModels/MenuBarViewModel.swift"
      to: "Sources/PingMonitor/MenuBar/MenuBarStatusEvaluator.swift"
      via: "evaluate call with effective thresholds"
      pattern: "evaluate"
      enables_truths:
        - "User can configure per-host latency thresholds and status evaluation uses those thresholds"
        - "Global defaults are used only when a host does not define threshold overrides"
    - from: "Sources/PingMonitor/ViewModels/MenuBarViewModel.swift"
      to: "Sources/PingMonitor/Models/Host.swift"
      via: "effectiveGreenThresholdMS/effectiveYellowThresholdMS when selected host changes"
      pattern: "effective(Green|Yellow)ThresholdMS"
      enables_truths:
        - "Global defaults are used only when a host does not define threshold overrides"
---

<objective>
Close the HOST-08 verification gap by making menu bar status evaluation consume selected-host effective thresholds.

Purpose: Threshold overrides already exist in `Host` but status classification still uses static evaluator config. This plan wires selected-host effective green/yellow thresholds through runtime into status evaluation.

Output: Threshold-aware menu bar status computation with regression coverage.
</objective>

<execution_context>
@/Users/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-host-monitoring/03-host-monitoring-VERIFICATION.md
@.planning/phases/03-host-monitoring/03-01-SUMMARY.md
@.planning/phases/03-host-monitoring/03-07-SUMMARY.md

@Sources/PingMonitor/Models/Host.swift
@Sources/PingMonitor/Models/GlobalDefaults.swift
@Sources/PingMonitor/MenuBar/MenuBarStatusEvaluator.swift
@Sources/PingMonitor/ViewModels/MenuBarViewModel.swift
@Sources/PingMonitor/MenuBar/MenuBarRuntime.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make MenuBarStatusEvaluator threshold-aware per evaluation</name>
  <files>
    Sources/PingMonitor/MenuBar/MenuBarStatusEvaluator.swift
  </files>
  <action>
Refactor evaluator inputs so status can use dynamic thresholds from selected-host configuration. Update the evaluator API to receive effective threshold values at evaluation time (green and yellow boundaries). Preserve existing monitoring guards (`isMonitoringActive`, `hasReceivedAnyResult`) and sustained-failure red behavior. Implement latency banding with host thresholds (`<= green => green`, `> green and <= yellow => yellow`, `> yellow => red`) and keep behavior deterministic if thresholds are misconfigured by normalizing or guarding threshold order.
  </action>
  <verify>
`swift build` succeeds and evaluator no longer relies on a fixed `healthyUpperBoundMS` path.
  </verify>
  <done>
Evaluator status output can be driven by per-host effective thresholds on each call.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire selected-host effective thresholds through runtime and view model</name>
  <files>
    Sources/PingMonitor/ViewModels/MenuBarViewModel.swift
    Sources/PingMonitor/MenuBar/MenuBarRuntime.swift
  </files>
  <action>
Connect host selection state to threshold-aware evaluation. Extend `MenuBarViewModel` to store active green/yellow thresholds and feed them into evaluator in `updateState`. Update selected-host APIs so runtime passes both selected host and global defaults, computing thresholds via `host.effectiveGreenThresholdMS(_:)` and `host.effectiveYellowThresholdMS(_:)`. Ensure threshold updates apply on startup selection, host switch, add/edit refresh, and gateway host replacement through the existing `syncSelection` flow. Do not alter existing smoothing or summary text behavior beyond status classification requirements.
  </action>
  <verify>
`swift build` succeeds and runtime selection flow sets threshold-aware state before status evaluation.
  </verify>
  <done>
Menu bar status reflects effective thresholds of the currently selected host instead of static defaults.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add regression tests for host-threshold status behavior</name>
  <files>
    Tests/PingMonitorTests/MenuBarViewModelTests.swift
  </files>
  <action>
Expand tests to prove threshold wiring works end-to-end in view-model evaluation. Add a case where the selected host uses stricter thresholds and the same latency moves from yellow/red relative to defaults. Add a fallback case where overrides are nil and global thresholds drive status. Add a host-switch case showing status classification changes after switching to another host with different effective thresholds. Keep tests deterministic with direct result ingestion and non-smoothed evaluator settings.
  </action>
  <verify>
`swift test --filter MenuBarViewModelTests` passes.
  </verify>
  <done>
Automated tests fail if selected-host thresholds are not wired into status classification.
  </done>
</task>

</tasks>

<verification>
- `swift build`
- `swift test --filter MenuBarViewModelTests`
- `swift test --filter MenuBarIntegrationSmokeTests`
</verification>

<success_criteria>
- HOST-08 gap is closed: per-host threshold configuration changes menu bar status output.
- Status evaluation consumes selected-host effective thresholds with global fallback when overrides are absent.
- Host switch/selection updates apply threshold context immediately without restart.
</success_criteria>

<output>
After completion, create `.planning/phases/03-host-monitoring/03-09-SUMMARY.md`
</output>
