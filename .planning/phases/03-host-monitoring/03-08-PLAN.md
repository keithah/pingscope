---
phase: 03-host-monitoring
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - Sources/PingMonitor/Services/PingScheduler.swift
  - Sources/PingMonitor/App/AppDelegate.swift
  - Tests/PingMonitorTests/PingSchedulerTests.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can configure per-host ping interval and monitoring uses that interval"
    - "Hosts with shorter intervals are pinged more frequently than hosts using default interval"
    - "Host add/edit/delete and refresh paths preserve per-host interval cadence without app restart"
  artifacts:
    - path: "Sources/PingMonitor/Services/PingScheduler.swift"
      provides: "Per-host cadence scheduling based on effective host interval"
      contains: "effectiveInterval"
      supports_truths:
        - "User can configure per-host ping interval and monitoring uses that interval"
        - "Hosts with shorter intervals are pinged more frequently than hosts using default interval"
    - path: "Sources/PingMonitor/App/AppDelegate.swift"
      provides: "Scheduler wiring that passes host set and global interval fallback"
      contains: "scheduler.start|scheduler.updateHosts|scheduler.refresh"
      supports_truths:
        - "Host add/edit/delete and refresh paths preserve per-host interval cadence without app restart"
    - path: "Tests/PingMonitorTests/PingSchedulerTests.swift"
      provides: "Regression coverage for per-host interval cadence"
      contains: "intervalOverride"
      supports_truths:
        - "Hosts with shorter intervals are pinged more frequently than hosts using default interval"
        - "Host add/edit/delete and refresh paths preserve per-host interval cadence without app restart"
  key_links:
    - from: "Sources/PingMonitor/Services/PingScheduler.swift"
      to: "Sources/PingMonitor/Models/Host.swift"
      via: "Host.effectiveInterval(_:)"
      pattern: "effectiveInterval"
    - from: "Sources/PingMonitor/App/AppDelegate.swift"
      to: "Sources/PingMonitor/Services/PingScheduler.swift"
      via: "start/update/refresh calls with global fallback"
      pattern: "scheduler\\.(start|updateHosts|refresh)"
---

<objective>
Close the HOST-06 verification gap by making scheduler cadence truly per-host.

Purpose: Interval overrides already persist in Host settings, but runtime monitoring still pings all hosts on one shared loop. This plan wires per-host effective interval values into scheduling so user configuration changes monitoring cadence.

Output: Per-host interval-aware scheduling in runtime, plus regression tests proving cadence behavior.
</objective>

<execution_context>
@/Users/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-host-monitoring/03-host-monitoring-VERIFICATION.md
@.planning/phases/03-host-monitoring/03-01-SUMMARY.md
@.planning/phases/03-host-monitoring/03-07-SUMMARY.md

@Sources/PingMonitor/Models/Host.swift
@Sources/PingMonitor/Services/PingScheduler.swift
@Sources/PingMonitor/App/AppDelegate.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement per-host cadence in PingScheduler</name>
  <files>
    Sources/PingMonitor/Services/PingScheduler.swift
  </files>
  <action>
Replace the single shared `interval` loop with per-host cadence scheduling. Compute each host's effective interval from `Host.effectiveInterval(_:)` using a global fallback value passed into scheduler APIs. Track next due time per host and run pings when due so hosts with shorter intervals run more often in the same wall-clock window. Keep existing stagger behavior for concurrently due hosts so bursts remain spread. Preserve cancel-before-restart semantics for start/update/refresh and keep scheduler logic actor-isolated with no shared mutable state outside the actor.
  </action>
  <verify>
`swift build` succeeds and `PingScheduler` no longer relies on one shared `interval` property for all hosts.
  </verify>
  <done>
Scheduler cadence uses per-host effective interval values and can run hosts at different rates in one monitoring session.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire AppDelegate scheduler calls to per-host interval APIs</name>
  <files>
    Sources/PingMonitor/App/AppDelegate.swift
    Sources/PingMonitor/Services/PingScheduler.swift
  </files>
  <action>
Update scheduler integration points so runtime always provides required fallback settings. Update `startScheduler`, `refreshHostsAndScheduler`, `switchHostAndRefreshScheduler`, and refresh callbacks to call the scheduler API that supports per-host effective intervals. Ensure all call sites pass `runtime.globalDefaults.interval` as fallback while host overrides come from each `Host`. Keep host-target updates (`hostStore.allHosts`) and result handling behavior unchanged except for cadence wiring, and do not regress existing gateway update, selection, or host CRUD flows.
  </action>
  <verify>
`swift build` succeeds and AppDelegate scheduler call sites pass global interval fallback into scheduler APIs.
  </verify>
  <done>
Runtime scheduling paths (startup, host refresh, host switch) all execute with per-host cadence support wired.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add regression tests for interval override cadence</name>
  <files>
    Tests/PingMonitorTests/PingSchedulerTests.swift
  </files>
  <action>
Create deterministic scheduler-focused tests that prove per-host cadence behavior. Add at least one test where two hosts have different effective intervals and assert the shorter-interval host produces more results over a bounded time window. Add a fallback test where the host interval override is nil and cadence uses the provided global interval. Use lightweight test doubles for ping service and result collection to avoid network dependency, and keep timing tolerances bounded so tests stay stable.
  </action>
  <verify>
`swift test --filter PingSchedulerTests` passes.
  </verify>
  <done>
Automated tests fail if scheduler reverts to one shared cadence or ignores interval overrides.
  </done>
</task>

</tasks>

<verification>
- `swift build`
- `swift test --filter PingSchedulerTests`
- `swift test --filter MenuBarIntegrationSmokeTests` (quick regression on app-level scheduler wiring)
</verification>

<success_criteria>
- HOST-06 gap is closed: per-host interval configuration affects actual monitoring cadence.
- Scheduler uses `Host.effectiveInterval(_:)` wiring instead of a single global loop interval.
- App runtime paths that start/update scheduling continue to work with host CRUD and selection flows.
</success_criteria>

<output>
After completion, create `.planning/phases/03-host-monitoring/03-08-SUMMARY.md`
</output>
