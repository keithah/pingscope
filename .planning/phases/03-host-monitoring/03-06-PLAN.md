---
phase: 03-host-monitoring
plan: 06
type: execute
wave: 3
depends_on: ["03-03", "03-04"]
files_modified:
  - Sources/PingMonitor/Views/AddHostSheet.swift
  - Sources/PingMonitor/ViewModels/AddHostViewModel.swift
autonomous: true

must_haves:
  truths:
    - "User can add a new host with hostname and display name"
    - "User can edit existing host settings"
    - "Test ping warns if unreachable but allows save"
    - "Optional fields use global defaults when not set"
  artifacts:
    - path: "Sources/PingMonitor/Views/AddHostSheet.swift"
      provides: "Add/edit host sheet UI"
      min_lines: 80
    - path: "Sources/PingMonitor/ViewModels/AddHostViewModel.swift"
      provides: "Add/edit form state and validation"
      exports: ["AddHostViewModel"]
  key_links:
    - from: "Sources/PingMonitor/Views/AddHostSheet.swift"
      to: "AddHostViewModel"
      via: "@StateObject"
      pattern: "@StateObject"
---

<objective>
Create the add/edit host sheet with form validation and test ping functionality.

Purpose: This implements HOST-09 add/edit flow. Per CONTEXT.md: required fields are hostname/IP and display name, test ping before saving warns but doesn't block, optional fields use global defaults.

Output: AddHostSheet view that handles both add and edit modes with test ping.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-host-monitoring/03-CONTEXT.md
@.planning/phases/03-host-monitoring/03-RESEARCH.md

@Sources/PingMonitor/Models/Host.swift
@Sources/PingMonitor/Models/GlobalDefaults.swift
@Sources/PingMonitor/Models/PingMethod.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AddHostViewModel</name>
  <files>
    Sources/PingMonitor/ViewModels/AddHostViewModel.swift
  </files>
  <action>
Create `AddHostViewModel.swift`:

1. Enum `AddHostMode`:
   - `case add`
   - `case edit(Host)`

2. `@MainActor class AddHostViewModel: ObservableObject`:
   - `let mode: AddHostMode`
   - Form fields (all @Published):
     - `var hostname: String = ""`
     - `var displayName: String = ""`
     - `var port: String = ""` (String for text field, convert to UInt16)
     - `var pingMethod: PingMethod = .tcp`
     - `var useCustomInterval: Bool = false`
     - `var intervalSeconds: String = ""`
     - `var useCustomTimeout: Bool = false`
     - `var timeoutSeconds: String = ""`
     - `var useCustomThresholds: Bool = false`
     - `var greenThresholdMS: String = ""`
     - `var yellowThresholdMS: String = ""`
   - Test state:
     - `var isTesting: Bool = false`
     - `var testResult: TestResult? = nil` (enum: .success(latencyMS), .failed(error), .none)
     - `var showTestWarning: Bool = false`
   - Callbacks:
     - `let onSave: (Host) -> Void`
     - `let onCancel: () -> Void`

3. Initializer:
   - Init with mode, onSave, onCancel
   - If mode is .edit(host), populate form fields from host
   - For optional overrides, set useCustom* = true and populate if override exists

4. Computed validation:
   - `var isValid: Bool`:
     - hostname.trimmingCharacters(in: .whitespaces).isEmpty == false
     - displayName.trimmingCharacters(in: .whitespaces).isEmpty == false
   - `var portNumber: UInt16?`: Parse port string, return nil if invalid
   - `var effectivePort: UInt16`: portNumber ?? pingMethod.defaultPort

5. Methods:
   - `func testPing() async`:
     - Set isTesting = true
     - Create temporary Host with form values
     - Call PingService.ping(host:)
     - Set testResult based on result
     - Set showTestWarning = true if failed
     - Set isTesting = false
   - `func save()`:
     - Build Host from form values
     - Set optional overrides only if useCustom* is true
     - Call onSave(host)
   - `func cancel()`:
     - Call onCancel()
  </action>
  <verify>
`swift build` compiles. ViewModel manages form state and validation.
  </verify>
  <done>
AddHostViewModel exists with form fields, validation, test ping, and save/cancel actions. Edit mode populates from existing host.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AddHostSheet view</name>
  <files>
    Sources/PingMonitor/Views/AddHostSheet.swift
  </files>
  <action>
Create `AddHostSheet.swift`:

1. `struct AddHostSheet: View`:
   - `@StateObject var viewModel: AddHostViewModel`
   - `@Environment(\.dismiss) private var dismiss`

2. Body structure using Form:
   - Section "Host Details" (required):
     - TextField "Hostname or IP" bound to viewModel.hostname
     - TextField "Display Name" bound to viewModel.displayName
     - Picker for pingMethod (TCP, UDP, ICMP Simulated)
     - TextField "Port" bound to viewModel.port (with .keyboardType(.numberPad) hint)
       - Placeholder shows pingMethod.defaultPort

3. Section "Test Connection":
   - Button "Test Ping" with action { Task { await viewModel.testPing() } }
     - Disabled if hostname.isEmpty || isTesting
     - Show ProgressView if isTesting
   - If testResult exists:
     - Success: green checkmark + latency (e.g., "Connected: 12ms")
     - Failed: yellow warning + message
   - Note: Warning shown but save still allowed per CONTEXT.md

4. Section "Advanced" (optional overrides):
   - Use DisclosureGroup to collapse by default
   - Toggle "Custom Interval" with viewModel.useCustomInterval
     - If on: TextField for intervalSeconds
   - Toggle "Custom Timeout" with viewModel.useCustomTimeout
     - If on: TextField for timeoutSeconds
   - Toggle "Custom Thresholds" with viewModel.useCustomThresholds
     - If on: TextFields for green/yellow thresholds

5. Toolbar:
   - Leading: "Cancel" button -> viewModel.cancel(); dismiss()
   - Trailing: "Save" button -> viewModel.save(); dismiss()
     - Disabled if !viewModel.isValid

6. Title: "Add Host" or "Edit Host" based on viewModel.mode
  </action>
  <verify>
`swift build` compiles. Sheet renders form with required and optional fields.
  </verify>
  <done>
AddHostSheet shows form with hostname, display name, ping method, optional port, test ping button, and collapsible advanced settings. Test warning doesn't block save.
  </done>
</task>

</tasks>

<verification>
- `swift build` compiles without errors
- Views exist in Sources/PingMonitor/Views/
- Form validates required fields
- Test ping provides feedback without blocking save
</verification>

<success_criteria>
- AddHostViewModel manages form state for add and edit modes
- AddHostSheet shows required fields (hostname, display name)
- Ping method picker with TCP/UDP/ICMP-Simulated options
- Test ping warns on failure but Save button remains enabled
- Advanced section with optional override toggles
- Cancel and Save buttons in toolbar
</success_criteria>

<output>
After completion, create `.planning/phases/03-host-monitoring/03-06-SUMMARY.md`
</output>
