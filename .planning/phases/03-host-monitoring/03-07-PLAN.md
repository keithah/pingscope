---
phase: 03-host-monitoring
plan: 07
type: execute
wave: 4
depends_on: ["03-02", "03-05", "03-06"]
files_modified:
  - Sources/PingMonitor/App/AppDelegate.swift
  - Sources/PingMonitor/MenuBar/MenuBarRuntime.swift
  - Sources/PingMonitor/MenuBar/StatusItemController.swift
autonomous: false

must_haves:
  truths:
    - "App monitors all hosts simultaneously (not just active host)"
    - "Gateway host is auto-detected and updates when network changes"
    - "Host list is accessible from popover or context menu"
    - "Network change indicator appears briefly when gateway changes"
  artifacts:
    - path: "Sources/PingMonitor/App/AppDelegate.swift"
      provides: "App lifecycle with HostStore and GatewayDetector"
      contains: "HostStore|GatewayDetector"
    - path: "Sources/PingMonitor/MenuBar/MenuBarRuntime.swift"
      provides: "Runtime state for menu bar"
      contains: "HostStore"
  key_links:
    - from: "Sources/PingMonitor/App/AppDelegate.swift"
      to: "HostStore"
      via: "initialization and host updates"
      pattern: "HostStore"
    - from: "Sources/PingMonitor/App/AppDelegate.swift"
      to: "GatewayDetector"
      via: "startMonitoring"
      pattern: "startMonitoring"
---

<objective>
Wire HostStore and GatewayDetector into the app lifecycle for multi-host monitoring.

Purpose: This completes HOST-01 (monitor multiple hosts) and HOST-02 (auto-detect gateway). The app now monitors all configured hosts and updates the gateway when the network changes.

Output: Fully integrated multi-host monitoring with gateway detection and "Network changed" indicator.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-host-monitoring/03-CONTEXT.md
@.planning/phases/03-host-monitoring/03-RESEARCH.md

@Sources/PingMonitor/App/AppDelegate.swift
@Sources/PingMonitor/MenuBar/StatusItemController.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update MenuBarRuntime for multi-host</name>
  <files>
    Sources/PingMonitor/App/AppDelegate.swift
  </files>
  <action>
Refactor MenuBarRuntime and AppDelegate for multi-host support:

1. Extract MenuBarRuntime to its own file if needed, or update in AppDelegate.swift:
   - Replace `availableHosts: [Host]` with reference to HostStore
   - Add `hostStore: HostStore` property
   - Add `gatewayDetector: GatewayDetector` property
   - Add `networkChangeIndicator: Bool = false` for brief "Network changed" display

2. Update AppDelegate:
   - Create HostStore instance
   - Create GatewayDetector instance
   - Create GlobalDefaults instance (or use .default)

3. Start gateway monitoring on app launch:
   - Task to consume GatewayDetector.startMonitoring() stream
   - On each GatewayInfo:
     - Update hostStore.setGatewayHost(info) or clearGatewayHost()
     - If gateway changed: set networkChangeIndicator = true
     - Dispatch brief delay (2 seconds) then set networkChangeIndicator = false

4. Update scheduler to monitor all hosts:
   - Replace `scheduler.start(hosts: [selectedHost])` with `scheduler.start(hosts: hostStore.allHosts)`
   - On host store changes (add/remove), call scheduler.updateHosts(hostStore.allHosts)

5. Route ping results to correct host in latencies map:
   - The scheduler result handler receives PingResult with host address
   - Match to host.id and update viewModel latencies
  </action>
  <verify>
`swift build` compiles. AppDelegate creates and wires HostStore and GatewayDetector.
  </verify>
  <done>
MenuBarRuntime uses HostStore. GatewayDetector starts on launch. Scheduler monitors all hosts. Network change indicator briefly shows.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire host list UI into popover</name>
  <files>
    Sources/PingMonitor/Views/StatusPopoverView.swift
    Sources/PingMonitor/App/AppDelegate.swift
  </files>
  <action>
Add host list access to the UI:

1. Update StatusPopoverView (or create new section):
   - Add "Hosts" section that embeds HostListView
   - Or add button "Manage Hosts" that presents HostListView as sheet
   - Decision: Embed directly for quick access (popover already has space)

2. Create HostListViewModel in AppDelegate:
   - Wire callbacks to HostStore methods
   - Wire onSelectHost to change active host in MenuBarRuntime

3. Pass HostListViewModel to StatusPopoverView:
   - Update StatusPopoverViewModel or pass directly
   - Ensure latencies update as pings come in

4. Connect AddHostSheet sheets:
   - HostListView already has sheet modifiers from Plan 05
   - Now wire actual AddHostSheet from Plan 06

5. Update context menu if needed:
   - "Switch Host" could show submenu of all hosts (optional enhancement)
   - Keep existing switch behavior as fallback
  </action>
  <verify>
`swift build` compiles. Host list visible in popover. Add/edit sheets work.
  </verify>
  <done>
HostListView accessible from popover. Add/edit host flows work. Host selection updates active host and scheduler.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete multi-host monitoring with:
- All configured hosts pinged simultaneously
- Gateway auto-detected and named by network
- Host list UI with add/edit/delete
- Network change indicator
  </what-built>
  <how-to-verify>
1. Launch app: `swift run`
2. Verify menu bar shows ping latency
3. Left-click to open popover
4. Find host list section - should show Google DNS, Cloudflare, and Gateway
5. Verify each host shows latency updating
6. Click "+" to add custom host:
   - Enter hostname (e.g., "apple.com")
   - Enter display name (e.g., "Apple")
   - Click "Test Ping" - should show result
   - Click "Save"
7. New host appears in list with latency
8. Try to delete Google DNS - should be prevented (lock icon, no delete option)
9. Delete the custom host - confirmation should appear, then delete works
10. Switch networks (if possible) - gateway should update and brief indicator shown
  </how-to-verify>
  <resume-signal>Type "approved" if multi-host monitoring works correctly, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- `swift build` compiles without errors
- `swift run` launches app with multi-host monitoring
- All hosts show updating latencies
- Gateway auto-detected with network-aware name
- Add/edit/delete flows work (defaults protected)
</verification>

<success_criteria>
- App monitors multiple hosts simultaneously (HOST-01)
- Default gateway auto-detected (HOST-02)
- All three ping methods available (HOST-03, HOST-04, HOST-05)
- Per-host settings configurable (HOST-06, HOST-07, HOST-08)
- Host management works (HOST-09)
- Default hosts protected from deletion (HOST-10)
</success_criteria>

<output>
After completion, create `.planning/phases/03-host-monitoring/03-07-SUMMARY.md`
</output>
