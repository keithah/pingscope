---
phase: 14-privacy-and-compliance
plan: 03
type: execute
wave: 2
depends_on:
  - 14-01
files_modified: []
autonomous: false
requirements:
  - PRIV-06
  - PRIV-07
  - PRIV-08

must_haves:
  truths:
    - "App Store build archives successfully with AppStore scheme"
    - "Archived app runs in sandbox environment (SandboxDetector.isRunningInSandbox = true)"
    - "ICMP option is hidden from UI in sandboxed build"
    - "TCP ping works correctly in sandboxed build"
    - "UDP ping works correctly in sandboxed build"
  artifacts: []
  key_links:
    - from: "PingMethod.availableCases"
      to: "SandboxDetector.isRunningInSandbox"
      via: "conditional method filtering"
      pattern: "SandboxDetector\\.isRunningInSandbox.*\\[.tcp, .udp\\]"
---

<objective>
Verify App Store sandboxed build functions correctly with ICMP hidden and TCP/UDP working before submission.

Purpose: Ensure dual-mode sandbox behavior works as designed in production App Store build configuration.
Output: Validated App Store .xcarchive with confirmed sandbox behavior and functional TCP/UDP ping methods.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-privacy-and-compliance/14-RESEARCH.md
@.planning/phases/14-privacy-and-compliance/14-01-SUMMARY.md
@Scripts/verify-sandbox.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Archive App Store build</name>
  <files>N/A</files>
  <action>
Archive PingScope using AppStore scheme in Xcode:

```bash
# Clean build folder
xcodebuild clean -project PingScope.xcodeproj -scheme PingScope-AppStore

# Archive App Store build
xcodebuild archive \
  -project PingScope.xcodeproj \
  -scheme PingScope-AppStore \
  -archivePath ~/Library/Developer/Xcode/Archives/PingScope-AppStore-Verification.xcarchive
```

**Expected outcome:**
- Build succeeds with no errors
- Archive created at ~/Library/Developer/Xcode/Archives/PingScope-AppStore-Verification.xcarchive
- Archive contains PingScope.app with App Store entitlements (sandbox enabled)

**Verification during archive:**
- Watch for code signing errors (indicates entitlement issues)
- Watch for asset catalog errors (icon validation)
- Watch for Info.plist errors (missing required keys)

**If archive fails:**
- Check scheme configuration: Product → Scheme → Edit Scheme → Archive → Build Configuration = Release
- Check signing: Build Settings → Signing → Code Signing Identity = "Apple Distribution"
- Check entitlements: Verify Configuration/PingScope-AppStore.entitlements is selected
  </action>
  <verify>
```bash
# Verify archive exists
test -d ~/Library/Developer/Xcode/Archives/PingScope-AppStore-Verification.xcarchive && echo "✓ Archive created"

# Verify app bundle exists in archive
test -d ~/Library/Developer/Xcode/Archives/PingScope-AppStore-Verification.xcarchive/Products/Applications/PingScope.app && echo "✓ App bundle present"

# Run sandbox verification script
Scripts/verify-sandbox.sh ~/Library/Developer/Xcode/Archives/PingScope-AppStore-Verification.xcarchive/Products/Applications/PingScope.app
```
  </verify>
  <done>
PingScope-AppStore-Verification.xcarchive created successfully, contains PingScope.app signed with App Store entitlements, and passes all six verification checks from verify-sandbox.sh script.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify sandbox behavior and TCP/UDP functionality</name>
  <what-built>
Archived App Store build with sandbox enabled, export compliance declared, and privacy manifest embedded. Build uses PingScope-AppStore scheme with com.apple.security.app-sandbox entitlement.
  </what-built>
  <how-to-verify>
**1. Export archived app for testing:**

```bash
# Open Xcode Organizer
open ~/Library/Developer/Xcode/Archives/

# In Organizer:
# - Select PingScope-AppStore-Verification.xcarchive
# - Click "Distribute App"
# - Choose "Custom" → "Copy App"
# - Save to ~/Desktop/PingScope-AppStore-Test.app
```

**2. Install on clean environment:**

Option A (Recommended): Test on different macOS user account
```bash
# Create test user account via System Settings → Users & Groups
# Log into test user account
# Copy PingScope-AppStore-Test.app to test user's Applications folder
```

Option B: Test on current user (less reliable for sandbox detection)
```bash
# Copy to /Applications
cp -R ~/Desktop/PingScope-AppStore-Test.app /Applications/
```

**3. Launch app and verify sandbox behavior:**

```bash
# Launch PingScope
open /Applications/PingScope-AppStore-Test.app
```

In running app:
1. **Verify ICMP is hidden:**
   - Click menu bar icon → Settings → Hosts
   - Add new host (e.g., "google.com")
   - Click "Method" dropdown
   - **Expected:** Only "TCP" and "UDP" options visible (no "ICMP")
   - **If ICMP visible:** Sandbox detection failed - report issue

2. **Verify TCP ping works:**
   - Select existing host (e.g., default gateway)
   - Set method to "TCP"
   - Port: 80
   - **Expected:** Latency graph updates, ping times display in menu bar
   - **If fails:** Network client entitlement missing - report issue

3. **Verify UDP ping works:**
   - Select host (e.g., 8.8.8.8)
   - Set method to "UDP"
   - Port: 53
   - **Expected:** Latency graph updates, ping times display in menu bar
   - **If fails:** Network client entitlement missing - report issue

4. **Verify sandbox detection:**
   - Open Console.app
   - Filter for process: PingScope
   - Look for log message containing "SandboxDetector"
   - **Expected:** Should show sandbox=true or path containing "/Library/Containers/"
   - **If false:** Sandbox detection implementation issue - report

**4. Check codesign verification:**

```bash
# Verify sandbox entitlement
codesign -d --entitlements - /Applications/PingScope-AppStore-Test.app | grep -A1 "app-sandbox"
# Expected output:
# <key>com.apple.security.app-sandbox</key>
# <true/>

# Verify network client entitlement
codesign -d --entitlements - /Applications/PingScope-AppStore-Test.app | grep -A1 "network.client"
# Expected output:
# <key>com.apple.security.network.client</key>
# <true/>
```

**Success criteria:**
- ✓ ICMP option hidden in method dropdown
- ✓ TCP ping to port 80 succeeds
- ✓ UDP ping to port 53 succeeds
- ✓ Menu bar updates with latency values
- ✓ App launches without crashes
- ✓ codesign shows sandbox=true and network.client=true

**Common issues:**
- ICMP visible → SandboxDetector path check may need adjustment
- TCP/UDP fail → Network client entitlement missing from AppStore.entitlements
- App crashes on launch → Entitlement configuration error
  </how-to-verify>
  <resume-signal>
Reply with:
- "sandbox-verified" if all checks pass (ICMP hidden, TCP works, UDP works, sandbox detected)
- Describe specific failure if any check fails (include which check and observed behavior)
  </resume-signal>
</task>

</tasks>

<verification>
All five success criteria met:
1. App Store build archived successfully
2. Sandbox detection returns true (path contains /Library/Containers/)
3. ICMP option hidden from method dropdown
4. TCP ping works (port 80 to standard hosts)
5. UDP ping works (port 53 to DNS servers)
</verification>

<success_criteria>
1. xcodebuild archive succeeds with AppStore scheme producing valid .xcarchive
2. verify-sandbox.sh script passes all six checks on archived app bundle
3. Exported app runs on clean macOS environment or test user account
4. SandboxDetector.isRunningInSandbox returns true in running app
5. ICMP method is not visible in Settings → Hosts → Method dropdown
6. TCP ping to port 80 succeeds with latency updates in UI
7. UDP ping to port 53 succeeds with latency updates in UI
8. codesign verification confirms sandbox=true and network.client=true entitlements
</success_criteria>

<output>
After completion, create `.planning/phases/14-privacy-and-compliance/14-03-SUMMARY.md` documenting:
- Archive creation details (scheme, path, size)
- verify-sandbox.sh validation results (all checks)
- Manual verification steps performed
- Sandbox detection confirmation (logged path, isRunningInSandbox value)
- TCP/UDP functionality test results
- ICMP hiding confirmation
- Any issues encountered and resolutions
</output>
