---
phase: 14-privacy-and-compliance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Configuration/Info.plist
  - Sources/PingScope/Resources/PrivacyInfo.xcprivacy
  - Scripts/verify-sandbox.sh
autonomous: true
requirements:
  - PRIV-01
  - PRIV-02
  - PRIV-05

must_haves:
  truths:
    - "PrivacyInfo.xcprivacy declares UserDefaults access with CA92.1 reason code"
    - "Info.plist declares ITSAppUsesNonExemptEncryption=NO for streamlined export compliance"
    - "Privacy manifest explicitly omits NSPrivacyCollectedDataTypes (Data Not Collected)"
    - "Verification script validates sandbox configuration, entitlements, and privacy manifest"
  artifacts:
    - path: "Configuration/Info.plist"
      provides: "Export compliance declaration"
      contains: "ITSAppUsesNonExemptEncryption"
    - path: "Sources/PingScope/Resources/PrivacyInfo.xcprivacy"
      provides: "Privacy manifest with required reason APIs"
      contains: "NSPrivacyAccessedAPITypes"
    - path: "Scripts/verify-sandbox.sh"
      provides: "Automated sandbox verification tool"
      min_lines: 50
  key_links:
    - from: "Scripts/verify-sandbox.sh"
      to: "Configuration/Info.plist"
      via: "PlistBuddy verification"
      pattern: "PlistBuddy.*ITSAppUsesNonExemptEncryption"
    - from: "Scripts/verify-sandbox.sh"
      to: "Sources/PingScope/Resources/PrivacyInfo.xcprivacy"
      via: "grep for required reason codes"
      pattern: "grep.*CA92\\.1"
---

<objective>
Complete file-based compliance requirements for App Store submission including export compliance declaration, privacy manifest verification, and automated sandbox validation tooling.

Purpose: Enable streamlined App Store uploads and ensure privacy manifest meets Apple's May 2024 enforcement requirements.
Output: Info.plist with export compliance, verified privacy manifest, and reusable verification script.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-privacy-and-compliance/14-RESEARCH.md
@Configuration/Info.plist
@Sources/PingScope/Resources/PrivacyInfo.xcprivacy
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add export compliance declaration to Info.plist</name>
  <files>Configuration/Info.plist</files>
  <action>
Add ITSAppUsesNonExemptEncryption key to Info.plist immediately before the closing `</dict></plist>` tags:

```xml
    <!-- Export Compliance -->
    <key>ITSAppUsesNonExemptEncryption</key>
    <false/>
</dict>
</plist>
```

**Rationale:** PingScope uses only standard OS networking APIs (TCP, UDP, ICMP sockets) with no custom encryption. This declaration streamlines App Store uploads by skipping the manual export compliance questionnaire on every submission.

**Why NO:** App uses no custom cryptography libraries (no CryptoKit encryption, no CommonCrypto, no proprietary algorithms). Network protocols are unencrypted by design.

**Context:** Per Apple documentation, HTTPS via URLSession and standard OS networking are exempt from export documentation requirements.
  </action>
  <verify>
```bash
# Verify key exists and is set to false
/usr/libexec/PlistBuddy -c "Print ITSAppUsesNonExemptEncryption" Configuration/Info.plist
# Should output: false
```
  </verify>
  <done>
ITSAppUsesNonExemptEncryption key exists in Configuration/Info.plist with value `false`, enabling streamlined export compliance for all future submissions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify privacy manifest completeness</name>
  <files>Sources/PingScope/Resources/PrivacyInfo.xcprivacy</files>
  <action>
Review existing PrivacyInfo.xcprivacy and confirm it meets requirements:

**Required elements (MUST be present):**
1. NSPrivacyAccessedAPITypes array with UserDefaults category
2. NSPrivacyAccessedAPICategoryUserDefaults with CA92.1 reason code

**Optional elements (SHOULD be omitted):**
- NSPrivacyCollectedDataTypes (omit entirely when no data collected)
- NSPrivacyTracking (defaults to false when omitted)
- NSPrivacyTrackingDomains (not needed when tracking=false)

**Verification steps:**
1. Read current PrivacyInfo.xcprivacy
2. Confirm NSPrivacyAccessedAPITypes exists with UserDefaults CA92.1
3. Confirm NSPrivacyCollectedDataTypes is NOT present (Data Not Collected)
4. Confirm NSPrivacyTracking is NOT present (defaults false)
5. Document findings in verification output

**If privacy manifest is already correct:** Output "Privacy manifest verified complete - no changes needed"

**If NSPrivacyCollectedDataTypes is present:** Remove it only if it's an empty array or contains placeholder content. Keep it if explicitly populated.

**Context:** Research shows existing implementation already has correct UserDefaults CA92.1 declaration. Best practice is to omit NSPrivacyCollectedDataTypes entirely when no data is collected.
  </action>
  <verify>
```bash
# Verify UserDefaults category is declared
grep -q "NSPrivacyAccessedAPICategoryUserDefaults" Sources/PingScope/Resources/PrivacyInfo.xcprivacy && echo "✓ UserDefaults declared"

# Verify CA92.1 reason code
grep -q "CA92.1" Sources/PingScope/Resources/PrivacyInfo.xcprivacy && echo "✓ CA92.1 reason code present"

# Verify NSPrivacyCollectedDataTypes is omitted (should fail grep)
! grep -q "NSPrivacyCollectedDataTypes" Sources/PingScope/Resources/PrivacyInfo.xcprivacy && echo "✓ Data collection key omitted (Data Not Collected)"
```
  </verify>
  <done>
Privacy manifest contains NSPrivacyAccessedAPITypes with UserDefaults CA92.1 reason code, omits NSPrivacyCollectedDataTypes (Data Not Collected status), and omits NSPrivacyTracking (defaults to false).
  </done>
</task>

<task type="auto">
  <name>Task 3: Create sandbox verification script</name>
  <files>Scripts/verify-sandbox.sh</files>
  <action>
Create Scripts/verify-sandbox.sh executable script that validates App Store build sandbox configuration. Script should check:

1. **Sandbox entitlement:** com.apple.security.app-sandbox = true
2. **Network client entitlement:** com.apple.security.network.client = true
3. **Privacy manifest exists:** PrivacyInfo.xcprivacy present in Resources
4. **UserDefaults API declared:** NSPrivacyAccessedAPICategoryUserDefaults in manifest
5. **CA92.1 reason code:** Correct reason for app-only UserDefaults access
6. **Export compliance:** ITSAppUsesNonExemptEncryption = false in Info.plist

**Script structure:**
```bash
#!/usr/bin/env bash
# verify-sandbox.sh - Validate App Store build compliance

APP_PATH="$1"

if [ -z "$APP_PATH" ]; then
    echo "Usage: $0 /path/to/PingScope.app"
    exit 1
fi

echo "=== PingScope Sandbox Verification ==="
echo "App: $APP_PATH"
echo

# 1. Check sandbox entitlement
# 2. Check network client entitlement
# 3. Check privacy manifest exists
# 4. Check UserDefaults API declaration
# 5. Check CA92.1 reason code
# 6. Check export compliance

# Use codesign -d --entitlements for entitlement checks
# Use grep for privacy manifest content checks
# Use PlistBuddy for Info.plist checks

# Exit 0 if all checks pass, exit 1 if any fail
```

**Implementation details:**
- Use `codesign -d --entitlements -` for entitlement extraction
- Use `/usr/libexec/PlistBuddy` for Info.plist queries
- Print ✓ for passed checks, ✗ for failures
- Provide clear error messages for failed checks
- Make script executable: chmod +x

**Use research code example** from 14-RESEARCH.md "Sandbox Verification Script" section as implementation reference (lines 384-462).
  </action>
  <verify>
```bash
# Verify script exists and is executable
test -x Scripts/verify-sandbox.sh && echo "✓ Script is executable"

# Verify script contains all required checks
grep -q "com.apple.security.app-sandbox" Scripts/verify-sandbox.sh && echo "✓ Sandbox check present"
grep -q "com.apple.security.network.client" Scripts/verify-sandbox.sh && echo "✓ Network client check present"
grep -q "PrivacyInfo.xcprivacy" Scripts/verify-sandbox.sh && echo "✓ Privacy manifest check present"
grep -q "CA92.1" Scripts/verify-sandbox.sh && echo "✓ Reason code check present"
grep -q "ITSAppUsesNonExemptEncryption" Scripts/verify-sandbox.sh && echo "✓ Export compliance check present"
```
  </verify>
  <done>
Scripts/verify-sandbox.sh exists, is executable, validates all six compliance requirements (sandbox entitlement, network client, privacy manifest, UserDefaults API, CA92.1 reason code, export compliance), and provides clear pass/fail output.
  </done>
</task>

</tasks>

<verification>
1. Run verification script on any existing .app bundle (Developer ID build):
   ```bash
   # Should show sandbox=DISABLED for Developer ID build
   Scripts/verify-sandbox.sh ~/Library/Developer/Xcode/DerivedData/PingScope-*/Build/Products/Debug/PingScope.app
   ```

2. Verify Info.plist export compliance:
   ```bash
   /usr/libexec/PlistBuddy -c "Print ITSAppUsesNonExemptEncryption" Configuration/Info.plist
   # Should output: false
   ```

3. Verify privacy manifest structure:
   ```bash
   plutil -lint Sources/PingScope/Resources/PrivacyInfo.xcprivacy
   # Should output: OK
   ```
</verification>

<success_criteria>
1. Configuration/Info.plist contains ITSAppUsesNonExemptEncryption=false
2. Sources/PingScope/Resources/PrivacyInfo.xcprivacy declares UserDefaults with CA92.1, omits NSPrivacyCollectedDataTypes
3. Scripts/verify-sandbox.sh exists, is executable, and validates all six compliance checks
4. Verification script provides clear pass/fail output with actionable error messages
5. All modified files pass lint checks (plutil for plist files, bash -n for script)
</success_criteria>

<output>
After completion, create `.planning/phases/14-privacy-and-compliance/14-01-SUMMARY.md` documenting:
- Export compliance addition (Info.plist change)
- Privacy manifest verification results
- Verification script creation and usage
- Files modified and validation commands
</output>
