---
phase: 04-display-modes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Sources/PingMonitor/Models/DisplayMode.swift
  - Sources/PingMonitor/MenuBar/DisplayPreferencesStore.swift
  - Sources/PingMonitor/MenuBar/ModePreferenceStore.swift
  - Tests/PingMonitorTests/DisplayPreferencesStoreTests.swift
autonomous: true

must_haves:
  truths:
    - "Display-mode preferences survive app relaunches"
    - "Shared display context (selected host and time range) has one source of truth"
    - "Per-mode state is independent between full and compact"
  artifacts:
    - path: "Sources/PingMonitor/Models/DisplayMode.swift"
      provides: "Display mode and persisted state contracts"
      contains: "enum DisplayMode"
    - path: "Sources/PingMonitor/MenuBar/DisplayPreferencesStore.swift"
      provides: "UserDefaults-backed display preferences persistence"
      contains: "final class DisplayPreferencesStore"
    - path: "Sources/PingMonitor/MenuBar/ModePreferenceStore.swift"
      provides: "Boolean mode toggles used by runtime and settings"
      contains: "isCompactModeEnabled|isStayOnTopEnabled"
  key_links:
    - from: "Sources/PingMonitor/MenuBar/DisplayPreferencesStore.swift"
      to: "UserDefaults"
      via: "encode/decode persisted display preferences"
      pattern: "UserDefaults|JSONEncoder|JSONDecoder"
    - from: "Sources/PingMonitor/Models/DisplayMode.swift"
      to: "Sources/PingMonitor/MenuBar/DisplayPreferencesStore.swift"
      via: "Codable shared/per-mode structs"
      pattern: "DisplaySharedState|DisplayModeState"
---

<objective>
Create the display-mode persistence foundation used by all Phase 4 UI and window behavior.

Purpose: DISP-03 and DISP-06 depend on stable state contracts before UI wiring. This plan establishes one persisted model for shared state and per-mode memory without adding external dependencies.

Output: `DisplayMode` domain types and a dedicated preferences store with regression tests.
</objective>

<execution_context>
@/Users/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/04-display-modes/04-CONTEXT.md
@.planning/phases/04-display-modes/04-RESEARCH.md

@Sources/PingMonitor/MenuBar/ModePreferenceStore.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define display-mode persistence contracts</name>
  <files>
    Sources/PingMonitor/Models/DisplayMode.swift
  </files>
  <action>
Create mode/state types used throughout Phase 4:

- Add `DisplayMode` (`full`, `compact`) and lightweight time-range enum for Phase 4 filtering state.
- Add shared state model containing `selectedHostID` + `selectedTimeRange`.
- Add per-mode state model containing `graphVisible`, `historyVisible`, and persisted frame data.
- Include default sizes aligned to locked decisions (`450x500` full, `280x220` compact).
- Keep this contract scoped to display behavior only; do not pull in Phase 5 visualization/statistics logic.
  </action>
  <verify>`swift build` succeeds and `DisplayMode.swift` compiles with no warnings.</verify>
  <done>Codable display-state contracts exist and encode both shared and per-mode memory targets.</done>
</task>

<task type="auto">
  <name>Task 2: Implement DisplayPreferencesStore and mode toggle persistence wiring</name>
  <files>
    Sources/PingMonitor/MenuBar/DisplayPreferencesStore.swift
    Sources/PingMonitor/MenuBar/ModePreferenceStore.swift
  </files>
  <action>
Implement `DisplayPreferencesStore` backed by `UserDefaults`:

- Persist and restore one aggregate preferences payload with shared + per-mode state.
- Provide focused read/write APIs for shared state and per-mode overlays to avoid a mutable state blob anti-pattern.
- Keep `ModePreferenceStore` as source for compact/stay-on-top toggles, but add any missing helper APIs needed for settings/runtime reuse.
- Ensure defaults are deterministic on first launch and remain backward-compatible when keys are absent.
  </action>
  <verify>`swift build` succeeds and persistence APIs round-trip values across a new store instance.</verify>
  <done>Display preferences and mode toggles can be persisted/restored without relying on UI-local state.</done>
</task>

<task type="auto">
  <name>Task 3: Add regression tests for display preference persistence</name>
  <files>
    Tests/PingMonitorTests/DisplayPreferencesStoreTests.swift
  </files>
  <action>
Add focused tests for the persistence layer:

- Verify default values when no preferences exist.
- Verify shared state persists independently from per-mode panel/frame state.
- Verify full and compact mode state updates do not overwrite each other.
- Use isolated `UserDefaults` suite names per test for deterministic behavior.
  </action>
  <verify>`swift test --filter DisplayPreferencesStoreTests` passes.</verify>
  <done>Persistence behavior is covered by deterministic tests guarding shared-vs-per-mode separation.</done>
</task>

</tasks>

<verification>
- `swift build`
- `swift test --filter DisplayPreferencesStoreTests`
</verification>

<success_criteria>
- DISP-03 persistence prerequisites are in place (mode-related state survives relaunch)
- Shared host/time-range state and per-mode panel/frame state are represented separately
- Regression tests protect against state-collision regressions
</success_criteria>

<output>
After completion, create `.planning/phases/04-display-modes/04-01-SUMMARY.md`
</output>
