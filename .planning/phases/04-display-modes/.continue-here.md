---
phase: 04-display-modes
task: 1
total_tasks: 2
status: in_progress
last_updated: 2026-02-14T15:34:00Z
---

<current_state>
We are in Phase 4 (Display Modes), Plan 04-05 (human verification) after completing all prior implementation plans (04-01..04-04).

App now opens a chromeless, resizable window for the main display and supports full/compact modes with persistent per-mode frame.
The remaining work is finishing the Plan 04-05 human verification checklist, with a focus on floating Stay-on-Top behavior.

User request order:
1) Improve host pills at narrow widths
2) Shrink compact default size
3) Fix Stay-on-Top so it is movable and resizable (currently: it locks to the top and cannot be moved/resized)

After fixes, rerun Plan 04-05 checkpoint verification (both tasks) and produce 04-05-SUMMARY.md.
</current_state>

<completed_work>

- Phase 4 plans executed and summarized:
  - 04-01: persistence contracts/store
  - 04-02: full/compact views + shared view model
  - 04-03: display shell coordinator + anchoring + drag handle
  - 04-04: runtime integration, toggles, smoke tests

- Plan 04-05 (human verification) led to iterative fixes:
  - Removed legacy popover UI path; display now uses DisplayRootView.
  - Standard window is borderless/chromeless and resizable.
  - Hide-on-click-off works without interfering with resize edges.
  - Frame persistence across reopen fixed by:
    - preserving persisted frame data from UI toggles
    - avoiding hidden-window frame overwrites
    - persisting per-window mode (standard vs floating)
    - forcing restored frame after content swaps (and next runloop)
  - Graph now shrinks with window resize.

- Latest user-driven polish applied (commit 0815d99):
  - Host pills truncate + cap width to fit narrow windows.
  - Compact default size reduced.
  - Floating header made fully draggable; floating window max size unlocked.

</completed_work>

<remaining_work>

- Task 1 (Plan 04-05): Verify full/compact behavior against expectations.
  - Known: user previously confirmed many parts worked; re-verify after recent sizing/pill changes.

- Task 2 (Plan 04-05): Verify floating Stay-on-Top behavior.
  - Reported issue to resolve: when Stay on Top is enabled, window appears locked to the menu bar/top and user cannot move or resize it.
  - After fixes: ensure handle-based move works, resize works, does not auto-dismiss on click-off, stays in current Space only, and reopen behavior matches requirements.

</remaining_work>

<decisions_made>

- Chromeless windows are required (no titlebar/traffic lights). Borderless shells for both standard and floating.
- Standard (stay-on-top OFF) should dismiss like popover on click-off, but must not dismiss when grabbing resize edges.
- Size should persist per mode across hide/reopen, including during shell changes.
- Floating window movement is handle-only; making the entire floating header act as the handle improves discoverability.
- Compact should be significantly smaller by default; user will resize to preferred size.

</decisions_made>

<blockers>
- None technical-blocking, but user acceptance is currently blocked on floating Stay-on-Top being movable/resizable.
</blockers>

<context>
This session involved debugging a tricky borderless-window behavior on macOS: reopening would snap sizes back due to content/controller swap autosizing, and persistence could be overwritten by the wrong shell/mode.

Approach that worked:
- Persist frames aggressively and per-mode/per-shell.
- Avoid writes from hidden windows.
- Force frame after setting contentViewController (and again next runloop) to defeat late autosizing.

Now we are in polish + human verification mode: match the screenshots/vibe, let user dial in sizes, and ensure floating behavior feels natural.
</context>

<next_action>
Start with:
1) Reproduce Stay-on-Top issue: enable from context menu, open display, attempt move/resize.
2) Inspect DisplayModeCoordinator.showFloatingWindow anchoring conditions and any code that re-anchors every open even when a persisted non-zero origin exists.
3) Ensure floating uses persisted frame once the user has moved/resized, and that the header drag handle covers the intended area.
4) Relaunch and rerun Plan 04-05 Task 2 verification steps.
</next_action>
