---
phase: 04-display-modes
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - Sources/PingMonitor/MenuBar/DisplayModeCoordinator.swift
  - Sources/PingMonitor/Views/WindowDragHandleView.swift
  - Tests/PingMonitorTests/DisplayModeCoordinatorTests.swift
autonomous: true

must_haves:
  truths:
    - "Stay-on-top mode can open a borderless floating window"
    - "Floating window opens near the menu bar icon and remains on-screen"
    - "Floating window can be moved only via dedicated drag handle"
    - "Floating window stays in current Space only"
  artifacts:
    - path: "Sources/PingMonitor/MenuBar/DisplayModeCoordinator.swift"
      provides: "Presentation shell routing and anchor/clamp placement"
      contains: "showPopover|showFloatingWindow"
    - path: "Sources/PingMonitor/Views/WindowDragHandleView.swift"
      provides: "Explicit drag handle bridge for borderless window"
      contains: "performDrag"
  key_links:
    - from: "Sources/PingMonitor/MenuBar/DisplayModeCoordinator.swift"
      to: "NSStatusBarButton"
      via: "status item anchor conversion to screen coordinates"
      pattern: "convertToScreen|relativeTo"
    - from: "Sources/PingMonitor/MenuBar/DisplayModeCoordinator.swift"
      to: "NSWindow.collectionBehavior"
      via: "current-space-only floating behavior"
      pattern: "moveToActiveSpace|transient"
---

<objective>
Implement the presentation shell coordinator for popover and floating-window behavior.

Purpose: DISP-04, DISP-05, and DISP-06 depend on correct AppKit-level window behavior, independent of content layout work.

Output: Coordinator APIs for opening/closing/repositioning display shells plus drag-handle support and focused tests.
</objective>

<execution_context>
@/Users/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/04-display-modes/04-CONTEXT.md
@.planning/phases/04-display-modes/04-RESEARCH.md
@.planning/phases/04-display-modes/04-01-SUMMARY.md

@Sources/PingMonitor/App/AppDelegate.swift
@Sources/PingMonitor/MenuBar/StatusItemController.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build DisplayModeCoordinator with anchor-and-clamp placement</name>
  <files>
    Sources/PingMonitor/MenuBar/DisplayModeCoordinator.swift
  </files>
  <action>
Create `DisplayModeCoordinator` to own presentation mechanics:

- Route open behavior between popover and floating window based on stay-on-top state.
- Compute anchor rect from `NSStatusBarButton`, then place floating window near the icon.
- Clamp restored/anchored frame to current screen `visibleFrame` to prevent off-screen reopen.
- Re-anchor window near status item after mode switch and on reopen.
  </action>
  <verify>`swift build` succeeds and coordinator APIs compile for AppDelegate integration.</verify>
  <done>Presentation logic is centralized and exposes deterministic popover/window behavior.</done>
</task>

<task type="auto">
  <name>Task 2: Implement drag-handle-only floating behavior</name>
  <files>
    Sources/PingMonitor/MenuBar/DisplayModeCoordinator.swift
    Sources/PingMonitor/Views/WindowDragHandleView.swift
  </files>
  <action>
Configure floating window behavior to match locked requirements:

- Use a borderless `NSWindow` at `.floating` level for stay-on-top mode.
- Keep `isMovableByWindowBackground = false`.
- Provide a dedicated drag handle view that forwards mouse down to `window.performDrag(with:)`.
- Set collection behavior for current-space usage only (`.transient`, `.moveToActiveSpace`) and avoid all-spaces flags.
  </action>
  <verify>`swift build` succeeds and no all-spaces flags/background drag flags are used.</verify>
  <done>Floating window is borderless, movable via handle only, and constrained to current Space behavior.</done>
</task>

<task type="auto">
  <name>Task 3: Add coordinator tests for placement and window flags</name>
  <files>
    Tests/PingMonitorTests/DisplayModeCoordinatorTests.swift
  </files>
  <action>
Add deterministic tests for coordinator behavior:

- Validate anchor-to-window placement math clamps inside visible frame.
- Validate floating window config includes required style/level/collection behavior.
- Validate background drag remains disabled and drag-handle path is used.
  </action>
  <verify>`swift test --filter DisplayModeCoordinatorTests` passes.</verify>
  <done>Coordinator behavior is regression-protected for positioning, movability, and space behavior.</done>
</task>

</tasks>

<verification>
- `swift build`
- `swift test --filter DisplayModeCoordinatorTests`
</verification>

<success_criteria>
- DISP-04 shell behavior exists for stay-on-top mode
- DISP-05 floating window is borderless with drag-handle-only movement
- DISP-06 anchor/clamp logic exists and is test-covered
</success_criteria>

<output>
After completion, create `.planning/phases/04-display-modes/04-03-SUMMARY.md`
</output>
