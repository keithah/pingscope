---
phase: 02-menu-bar-state
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - Sources/PingMonitor/MenuBar/StatusItemController.swift
  - Sources/PingMonitor/MenuBar/ContextMenuFactory.swift
  - Sources/PingMonitor/MenuBar/ModePreferenceStore.swift
  - Tests/PingMonitorTests/ContextMenuFactoryTests.swift
autonomous: true

must_haves:
  truths:
    - "Menu bar shows color dot and compact latency text in real time"
    - "Left-click toggles popover visibility"
    - "Right-click, ctrl-click, and cmd-click open context menu without forcing popover closed"
    - "Context menu includes host switch, mode toggles, Settings, and Quit in required grouping"
  artifacts:
    - path: "Sources/PingMonitor/MenuBar/StatusItemController.swift"
      provides: "Status item rendering and click routing"
      contains: "NSStatusItem"
    - path: "Sources/PingMonitor/MenuBar/ContextMenuFactory.swift"
      provides: "State-driven context menu builder"
      contains: "NSMenu"
    - path: "Sources/PingMonitor/MenuBar/ModePreferenceStore.swift"
      provides: "Persistence for compact and stay-on-top toggles"
      contains: "UserDefaults"
  key_links:
    - from: "StatusItemController.swift"
      to: "MenuBarViewModel.swift"
      via: "observe state and refresh title/dot"
      pattern: "displayText|status"
    - from: "StatusItemController.swift"
      to: "ContextMenuFactory.swift"
      via: "build and present context menu on right/control/command click"
      pattern: "ContextMenuFactory|menu"
---

<objective>
Implement the menu bar status item controller and context menu behavior expected in Phase 2.

Purpose: This plan delivers the core user interaction surface in the menu bar, mapping state into visible status and wiring click behavior exactly to phase decisions.

Output: Working status item with dot + latency readout, click routing, grouped context menu actions, and persisted mode toggles.
</objective>

<execution_context>
@/Users/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-menu-bar-state/02-CONTEXT.md
@.planning/phases/02-menu-bar-state/02-RESEARCH.md
@.planning/phases/02-menu-bar-state/02-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build status item controller with deterministic click routing</name>
  <files>
    - Sources/PingMonitor/MenuBar/StatusItemController.swift
  </files>
  <action>
Create `StatusItemController` around `NSStatusItem` and its button, with explicit event routing:

- Render compact menu bar content using view model output (dot color + text only, no host name).
- Left-click (`leftMouseUp`) toggles popover open/closed.
- Right-click (`rightMouseUp`) plus ctrl-click/cmd-click path opens context menu.
- If popover is already open and context menu opens, keep popover open.

Use clear adapter methods so UI event routing is unit-testable without requiring full app launch.
  </action>
  <verify>
Run `swift build` and ensure AppKit controller compiles.
Smoke-run command `swift run PingMonitor` and check status item appears.
  </verify>
  <done>
StatusItemController can update menu title/dot from view model and route left/right/control/command clicks according to phase decisions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement context menu factory and mode preference persistence</name>
  <files>
    - Sources/PingMonitor/MenuBar/ContextMenuFactory.swift
    - Sources/PingMonitor/MenuBar/ModePreferenceStore.swift
    - Tests/PingMonitorTests/ContextMenuFactoryTests.swift
  </files>
  <action>
Create a state-driven menu builder that produces required grouping and actions:

- Top group: current host + switch action flow (not full inline host list).
- Middle group: compact and stay-on-top mode toggles styled/ordered to mirror old-app intent.
- Bottom group: separator + Settings + Quit.

Add `ModePreferenceStore` backed by `UserDefaults` for mode flags so toggles survive relaunch even before full settings phase. Test menu structure and action wiring through `ContextMenuFactoryTests` (section ordering, required items, checked-state behavior).
  </action>
  <verify>
Run `swift test --filter ContextMenuFactoryTests`.
Run `swift test` to ensure full suite remains green.
  </verify>
  <done>
Context menu is generated from runtime state with required sections/items, and mode toggles persist via UserDefaults with test coverage for menu composition.
  </done>
</task>

</tasks>

<verification>
Status item compiles, context menu structure is tested, and app can launch with menu bar item visible.
</verification>

<success_criteria>
- MENU-01, MENU-02, MENU-04, MENU-05, MENU-06, MENU-07 implementation paths exist.
- Click routing behavior is explicit and deterministic.
- Menu composition is state-driven and test-validated.
</success_criteria>

<output>
After completion, create `.planning/phases/02-menu-bar-state/02-menu-bar-state-02-SUMMARY.md`
</output>
