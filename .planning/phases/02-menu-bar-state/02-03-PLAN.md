---
phase: 02-menu-bar-state
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - Sources/PingMonitor/ViewModels/StatusPopoverViewModel.swift
  - Sources/PingMonitor/Views/StatusPopoverView.swift
  - Tests/PingMonitorTests/StatusPopoverViewModelTests.swift
autonomous: true

must_haves:
  truths:
    - "Left-click popover content shows current status and quick actions"
    - "Popover emphasizes both current status and immediate actions"
    - "Popover state reflects selected host and latest ping display data"
  artifacts:
    - path: "Sources/PingMonitor/ViewModels/StatusPopoverViewModel.swift"
      provides: "UI model for popover sections and actions"
      contains: "@MainActor"
    - path: "Sources/PingMonitor/Views/StatusPopoverView.swift"
      provides: "SwiftUI popover interface"
      contains: "struct StatusPopoverView"
    - path: "Tests/PingMonitorTests/StatusPopoverViewModelTests.swift"
      provides: "Behavior validation for popover view-model output"
      contains: "test"
  key_links:
    - from: "StatusPopoverViewModel.swift"
      to: "MenuBarViewModel.swift"
      via: "consume status text/color and host selection"
      pattern: "MenuBarViewModel"
    - from: "StatusPopoverView.swift"
      to: "StatusPopoverViewModel.swift"
      via: "bind quick-action controls to view-model actions"
      pattern: "@ObservedObject|@StateObject"
---

<objective>
Build the SwiftUI popover surface used by left-click interaction in the menu bar.

Purpose: The popover is the first interactive app UI in Phase 2 and must present concise status plus quick actions without waiting for later phases.

Output: A tested popover view and view model ready for injection into status item controller.
</objective>

<execution_context>
@/Users/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-menu-bar-state/02-CONTEXT.md
@.planning/phases/02-menu-bar-state/02-RESEARCH.md
@.planning/phases/02-menu-bar-state/02-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement popover view model with status-first + action-ready sections</name>
  <files>
    - Sources/PingMonitor/ViewModels/StatusPopoverViewModel.swift
    - Tests/PingMonitorTests/StatusPopoverViewModelTests.swift
  </files>
  <action>
Create a dedicated popover view model that transforms menu bar state into UI sections and actions.

- Surface current status label, color category, active host summary, and latest latency text.
- Include quick actions for refresh, open settings, and host switch entry points (actual settings screen can be stubbed with callback hook in this phase).
- Keep logic testable by exposing pure state transformation methods and action callbacks.

Add tests for expected section ordering, fallback `N/A` display behavior, and correct action callback firing.
  </action>
  <verify>
Run `swift test --filter StatusPopoverViewModelTests`.
  </verify>
  <done>
Popover view model emits all data needed for the phase UI emphasis and action hooks, with deterministic test coverage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SwiftUI popover view bound to popover view model</name>
  <files>
    - Sources/PingMonitor/Views/StatusPopoverView.swift
  </files>
  <action>
Implement `StatusPopoverView` as a compact SwiftUI layout that balances two concerns on first open:

- Current status visibility (status color/label + latency text)
- Immediate quick actions (refresh, host switch entry, settings entry)

Use concise visual hierarchy suitable for popover size constraints and ensure this file only handles presentation/binding (no menu bar click routing logic here).
  </action>
  <verify>
Run `swift build` and confirm `StatusPopoverView` compiles.
  </verify>
  <done>
Popover view is ready to be embedded by status item controller and presents status + quick actions in one first-open layout.
  </done>
</task>

</tasks>

<verification>
Popover view model tests pass and SwiftUI popover compiles cleanly.
</verification>

<success_criteria>
- MENU-03 UI surface is implemented as a popover (not a standard window).
- Popover content emphasizes status plus quick actions as required by context decisions.
- Popover view has no direct coupling to status-item event handling internals.
</success_criteria>

<output>
After completion, create `.planning/phases/02-menu-bar-state/02-menu-bar-state-03-SUMMARY.md`
</output>
