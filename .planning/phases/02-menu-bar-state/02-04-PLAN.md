---
phase: 02-menu-bar-state
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - Sources/PingMonitor/App/AppDelegate.swift
  - Sources/PingMonitor/PingMonitorApp.swift
  - Sources/PingMonitor/MenuBar/StatusItemController.swift
  - Tests/PingMonitorTests/MenuBarIntegrationSmokeTests.swift
autonomous: false

must_haves:
  truths:
    - "Left-click opens and closes popover from status item"
    - "Right-click context menu works while preserving open left-click popover"
    - "Menu bar status text/color update from live scheduler events"
    - "Settings and Quit actions are reachable from the context menu"
  artifacts:
    - path: "Sources/PingMonitor/App/AppDelegate.swift"
      provides: "App lifecycle wiring for menu bar mode"
      contains: "NSApplicationDelegate"
    - path: "Sources/PingMonitor/PingMonitorApp.swift"
      provides: "SwiftUI app entry wired to delegate"
      contains: "NSApplicationDelegateAdaptor"
    - path: "Tests/PingMonitorTests/MenuBarIntegrationSmokeTests.swift"
      provides: "Integration-level behavior checks for menu state flow"
      contains: "test"
  key_links:
    - from: "AppDelegate.swift"
      to: "PingScheduler.swift"
      via: "scheduler callback updates menu bar view model"
      pattern: "setResultHandler|start"
    - from: "AppDelegate.swift"
      to: "StatusItemController.swift"
      via: "inject view model, popover content, and menu actions"
      pattern: "StatusItemController"
    - from: "StatusItemController.swift"
      to: "StatusPopoverView.swift"
      via: "NSPopover content hosting"
      pattern: "NSHostingController"
---

<objective>
Integrate menu bar controller, popover UI, and ping scheduler into the running app, then validate end-to-end behavior.

Purpose: Prior plans build components; this plan wires them into a functioning Phase 2 experience and confirms user-observable requirements through automated checks plus one human verification checkpoint.

Output: Runnable menu-bar-first app behavior meeting all Phase 2 menu requirements.
</objective>

<execution_context>
@/Users/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-menu-bar-state/02-CONTEXT.md
@.planning/phases/02-menu-bar-state/02-RESEARCH.md
@.planning/phases/02-menu-bar-state/02-02-PLAN.md
@.planning/phases/02-menu-bar-state/02-03-PLAN.md
@Sources/PingMonitor/Services/PingScheduler.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire app lifecycle to menu bar architecture</name>
  <files>
    - Sources/PingMonitor/App/AppDelegate.swift
    - Sources/PingMonitor/PingMonitorApp.swift
    - Sources/PingMonitor/MenuBar/StatusItemController.swift
  </files>
  <action>
Integrate the Phase 2 components into app startup and runtime flow:

- Add `AppDelegate` that initializes ping services, menu bar view model, status item controller, and popover content.
- Update `PingMonitorApp` to use `NSApplicationDelegateAdaptor` and run as menu-bar-first app flow for this phase.
- Wire scheduler result callbacks into view model updates so menu text/color update in real time.
- Connect menu actions (host switch hook, mode toggles, settings entry hook, quit action) through controller delegates/callbacks.

Preserve clear ownership boundaries: delegate handles wiring, controller handles AppKit interactions, view models handle state.
  </action>
  <verify>
Run `swift build`.
Run `swift run PingMonitor` and verify app launches without crashes.
  </verify>
  <done>
App boots into functional menu bar behavior with live state updates and both interaction surfaces (popover + context menu) wired.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration smoke tests for state-to-menu behavior</name>
  <files>
    - Tests/PingMonitorTests/MenuBarIntegrationSmokeTests.swift
  </files>
  <action>
Add integration-level tests that validate the critical wiring paths without requiring full UI automation:

- Scheduler result -> menu bar view model state transition.
- Context menu action callbacks toggle stored mode preferences.
- Host selection action updates selected host state used by menu and popover.

Use test doubles where needed for scheduler emissions and action callbacks; do not attempt brittle pixel-level UI assertions.
  </action>
  <verify>
Run `swift test --filter MenuBarIntegrationSmokeTests`.
Run `swift test`.
  </verify>
  <done>
Core integration links are regression-protected by smoke tests and pass in CI-style command execution.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 2 menu bar flow: live status item, left-click popover, right-click context menu, host and mode actions, settings/quit commands.</what-built>
  <how-to-verify>
1. Run `swift run PingMonitor`.
2. Confirm status item appears with dot + compact latency text (or `N/A` at startup).
3. Left-click once: popover opens; left-click again: popover closes.
4. Re-open popover, then right-click status item: context menu appears and popover remains open.
5. Test ctrl-click and cmd-click to confirm they open the same context menu behavior.
6. In context menu, confirm grouping order: host controls first, mode toggles second, separator, then Settings and Quit.
7. Trigger host switch and mode toggles; confirm displayed state reflects changes.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
`swift build`, `swift test`, and manual interaction checklist complete with expected behavior.
</verification>

<success_criteria>
- MENU-01 through MENU-07 are all demonstrably reachable in running app behavior.
- Left/right/control/command interactions match locked phase context decisions.
- Phase 2 is ready for execution handoff without ambiguity.
</success_criteria>

<output>
After completion, create `.planning/phases/02-menu-bar-state/02-menu-bar-state-04-SUMMARY.md`
</output>
