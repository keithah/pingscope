---
phase: 17-widget-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - PingScope.xcodeproj/project.pbxproj
  - PingScope/PingScope-AppStore.entitlements
  - PingScope/PingScope-DeveloperID.entitlements
  - PingScopeWidget/PingScopeWidget.entitlements
  - PingScopeWidget/Info.plist
  - Sources/PingScope/Widget/WidgetDataStore.swift
  - Sources/PingScope/Widget/WidgetData.swift
autonomous: true
requirements:
  - WI-01
  - WI-02
  - WI-03
  - WI-04
  - WI-05

must_haves:
  truths:
    - Main app and widget extension can both access shared UserDefaults suite
    - Main app can write ping data to shared container
    - WidgetCenter.reloadTimelines() triggers when data is written
  artifacts:
    - path: "PingScopeWidget/PingScopeWidget.entitlements"
      provides: "App Group entitlement with Team ID prefix"
      contains: "com.apple.security.application-groups"
    - path: "Sources/PingScope/Widget/WidgetDataStore.swift"
      provides: "Actor service for writing widget data"
      min_lines: 30
    - path: "Sources/PingScope/Widget/WidgetData.swift"
      provides: "Codable model for widget sharing"
      contains: "struct WidgetData"
  key_links:
    - from: "Sources/PingScope/Widget/WidgetDataStore.swift"
      to: "shared UserDefaults suite"
      via: "UserDefaults(suiteName:)"
      pattern: "UserDefaults\\(suiteName:"
    - from: "Sources/PingScope/Widget/WidgetDataStore.swift"
      to: "WidgetCenter"
      via: "reloadTimelines call"
      pattern: "WidgetCenter\\.shared\\.reloadTimelines"
---

<objective>
Establish the widget infrastructure foundation including App Groups configuration with macOS Sequoia Team ID prefix, widget extension Xcode target, and shared data store service.

Purpose: Enable data sharing between main app and widget extension following macOS Sequoia requirements
Output: Widget extension target with proper entitlements and data sharing infrastructure
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-widget-foundation/17-RESEARCH.md
@.planning/phases/17-widget-foundation/17-CONTEXT.md
@Sources/PingScope/Models/Host.swift
@Sources/PingScope/Models/PingResult.swift
</context>

<tasks>

<task type="auto">
  <name>Create Widget Extension Xcode Target</name>
  <files>
    PingScope.xcodeproj/project.pbxproj
    PingScopeWidget/PingScopeWidget.entitlements
    PingScopeWidget/Info.plist
  </files>
  <action>
Using Xcode command-line tools, create a new Widget Extension target named "PingScopeWidget":

1. Use `xcodebuild -project PingScope.xcodeproj -list` to understand current structure
2. Manually edit project.pbxproj to add Widget Extension target with:
   - Product Name: PingScopeWidget
   - Bundle ID: com.hadm.PingScope.widget (child of main app bundle ID)
   - Platform: macOS
   - Deployment Target: 13.0
   - Product Type: com.apple.product-type.app-extension.widgetkit

3. Create PingScopeWidget/ directory structure with:
   - Info.plist with NSExtension configuration
   - PingScopeWidget.entitlements placeholder (will configure in next task)

Note: Widget extensions MUST be Xcode targets (not SPM targets) per WidgetKit requirements. Bundle ID hierarchy is critical for proper installation.
  </action>
  <verify>
Run: xcodebuild -project PingScope.xcodeproj -list
Confirm: "PingScopeWidget" appears in Targets list
Confirm: PingScopeWidget/ directory exists with Info.plist
  </verify>
  <done>
Widget extension target exists in Xcode project with correct bundle ID and platform configuration.
  </done>
</task>

<task type="auto">
  <name>Configure App Groups with macOS Sequoia Team ID Prefix</name>
  <files>
    PingScope/PingScope-AppStore.entitlements
    PingScope/PingScope-DeveloperID.entitlements
    PingScopeWidget/PingScopeWidget.entitlements
  </files>
  <action>
Configure App Groups entitlements for shared container access using macOS Sequoia Team ID prefix format:

**CRITICAL:** macOS Sequoia requires Team ID prefix format `TEAMID.group.name` (not iOS-style `group.` prefix).

1. Find Apple Developer Team ID:
   - Check Xcode project settings Signing & Capabilities
   - Team ID appears next to team name (e.g., "ABCD123456")
   - Store in variable for reuse

2. Add to PingScope/PingScope-AppStore.entitlements:
```xml
<key>com.apple.security.application-groups</key>
<array>
    <string>TEAMID.group.com.hadm.PingScope</string>
</array>
```

3. Add identical App Groups array to PingScope/PingScope-DeveloperID.entitlements

4. Add identical App Groups array to PingScopeWidget/PingScopeWidget.entitlements

Replace `TEAMID` with actual Team ID from step 1. All three entitlement files MUST use identical group identifier.

Reference: Research findings from Apple Developer Forums (macOS Sequoia App Groups requirement)
  </action>
  <verify>
Run: grep -A 3 "com.apple.security.application-groups" PingScope/PingScope-AppStore.entitlements PingScope/PingScope-DeveloperID.entitlements PingScopeWidget/PingScopeWidget.entitlements
Confirm: All three files contain identical App Groups configuration with Team ID prefix format
Confirm: No `group.` prefix used (would fail on macOS Sequoia)
  </verify>
  <done>
App Groups entitlement configured identically in main app (both schemes) and widget extension using Team ID prefix format required by macOS Sequoia.
  </done>
</task>

<task type="auto">
  <name>Create WidgetDataStore and WidgetData Models</name>
  <files>
    Sources/PingScope/Widget/WidgetDataStore.swift
    Sources/PingScope/Widget/WidgetData.swift
  </files>
  <action>
Create shared data infrastructure for widget updates:

1. **Create Sources/PingScope/Widget/WidgetData.swift:**
```swift
import Foundation

/// Simplified widget data model for sharing via UserDefaults
struct WidgetData: Codable, Equatable, Sendable {
    let version: Int = 1
    let results: [SimplifiedPingResult]
    let hosts: [SimplifiedHost]
    let lastUpdate: Date

    struct SimplifiedPingResult: Codable, Equatable, Sendable {
        let hostID: UUID
        let latencyMS: Double?
        let isSuccess: Bool
        let timestamp: Date
    }

    struct SimplifiedHost: Codable, Equatable, Sendable {
        let id: UUID
        let name: String
        let address: String
    }

    static let placeholder = WidgetData(
        results: [],
        hosts: [],
        lastUpdate: Date()
    )

    var isStale: Bool {
        Date().timeIntervalSince(lastUpdate) > 15 * 60
    }
}
```

2. **Create Sources/PingScope/Widget/WidgetDataStore.swift:**
```swift
import Foundation
import WidgetKit

/// Actor service for writing ping results to widget shared container
actor WidgetDataStore {
    private let shared: UserDefaults
    private let groupIdentifier: String

    init(groupIdentifier: String) {
        self.groupIdentifier = groupIdentifier
        guard let suite = UserDefaults(suiteName: groupIdentifier) else {
            fatalError("Failed to create UserDefaults suite for: \(groupIdentifier)")
        }
        self.shared = suite
    }

    /// Save ping results to shared container and trigger widget reload
    func savePingResults(_ results: [PingResult], hosts: [Host]) async {
        let widgetData = WidgetData(
            results: results.map { result in
                let latencyMS: Double? = result.latency.map { duration in
                    Double(duration.components.seconds) * 1000 +
                    Double(duration.components.attoseconds) / 1_000_000_000_000_000
                }

                return WidgetData.SimplifiedPingResult(
                    hostID: UUID(), // Will match by address in next iteration
                    latencyMS: latencyMS,
                    isSuccess: result.isSuccess,
                    timestamp: result.timestamp
                )
            },
            hosts: hosts.map { host in
                WidgetData.SimplifiedHost(
                    id: host.id,
                    name: host.name,
                    address: host.address
                )
            },
            lastUpdate: Date()
        )

        guard let encoded = try? JSONEncoder().encode(widgetData) else {
            print("Failed to encode widget data")
            return
        }

        shared.set(encoded, forKey: "widgetData")

        // Trigger widget timeline reload
        WidgetCenter.shared.reloadTimelines(ofKind: "PingScopeWidget")
    }
}
```

Use Team ID prefix from previous task for groupIdentifier. Models are simplified to avoid Duration encoding complexity in widgets.
  </action>
  <verify>
Run: swift build
Confirm: Sources/PingScope/Widget/ files compile successfully
Confirm: WidgetData.isStale calculates 15-minute threshold
Confirm: WidgetDataStore calls WidgetCenter.shared.reloadTimelines
  </verify>
  <done>
WidgetDataStore actor exists with savePingResults method that writes to shared UserDefaults and calls WidgetCenter.reloadTimelines. WidgetData model provides simplified Codable representation of ping state.
  </done>
</task>

</tasks>

<verification>
1. Widget extension target exists in PingScope.xcodeproj
2. App Groups entitlements configured identically across all three targets
3. Team ID prefix format used (not `group.` prefix)
4. WidgetDataStore can write to shared UserDefaults suite
5. WidgetCenter.reloadTimelines() called after data writes
</verification>

<success_criteria>
- Widget extension target builds successfully
- App Groups configuration uses macOS Sequoia Team ID prefix format
- WidgetDataStore compiles and provides data sharing interface
- Shared UserDefaults suite accessible from both app and widget code paths
</success_criteria>

<output>
After completion, create `.planning/phases/17-widget-foundation/17-01-SUMMARY.md`
</output>
