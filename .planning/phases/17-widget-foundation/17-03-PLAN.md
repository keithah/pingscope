---
phase: 17-widget-foundation
plan: 03
type: execute
wave: 3
depends_on: ["17-02"]
files_modified:
  - Sources/PingScope/App/AppDelegate.swift
  - PingScope/Info.plist
  - PingScopeWidget/PingScopeWidgetView.swift
autonomous: false
requirements:
  - WUI-08

must_haves:
  truths:
    - Tapping any widget opens main PingScope app
    - Main app writes ping data to shared container on each ping cycle
    - Widgets update within 5-15 minutes showing current status
    - Widgets display correctly in both light and dark mode
  artifacts:
    - path: "PingScope/Info.plist"
      provides: "URL scheme registration"
      contains: "CFBundleURLTypes"
    - path: "Sources/PingScope/App/AppDelegate.swift"
      provides: "Deep link handler"
      contains: "application.*open urls"
  key_links:
    - from: "PingScopeWidget/PingScopeWidgetView.swift"
      to: "pingscope:// URL"
      via: ".widgetURL modifier"
      pattern: "widgetURL.*pingscope"
    - from: "Sources/PingScope/App/AppDelegate.swift"
      to: "WidgetDataStore"
      via: "savePingResults call"
      pattern: "widgetDataStore\\.savePingResults"

---

<objective>
Integrate widgets with main app through deep linking, ping result wiring, and end-to-end verification of all widget functionality in both light and dark modes.

Purpose: Complete the widget foundation with app integration and human verification
Output: Fully functional widgets that update from app data and open app on tap
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/17-widget-foundation/17-RESEARCH.md
@.planning/phases/17-widget-foundation/17-01-SUMMARY.md
@.planning/phases/17-widget-foundation/17-02-SUMMARY.md
@Sources/PingScope/App/AppDelegate.swift
@Sources/PingScope/Services/PingScheduler.swift
</context>

<tasks>

<task type="auto">
  <name>Configure Deep Linking and Widget Data Wiring</name>
  <files>
    PingScope/Info.plist
    Sources/PingScope/App/AppDelegate.swift
    PingScopeWidget/PingScopeWidgetView.swift
  </files>
  <action>
Wire widgets to main app through deep linking and ping result updates:

1. **Add URL scheme to PingScope/Info.plist:**
```xml
<key>CFBundleURLTypes</key>
<array>
    <dict>
        <key>CFBundleURLName</key>
        <string>com.hadm.pingscope</string>
        <key>CFBundleURLSchemes</key>
        <array>
            <string>pingscope</string>
        </array>
    </dict>
</array>
```

2. **Update PingScopeWidget/PingScopeWidgetView.swift to add widgetURL modifier:**

Add to each widget size view (Small/Medium/Large):
```swift
.widgetURL(URL(string: "pingscope://open"))
```

Place after existing .containerBackground modifier.

3. **Add deep link handler to AppDelegate:**

Find `AppDelegate` class and add:
```swift
func application(_ application: NSApplication, open urls: [URL]) {
    // Handle pingscope://open by activating app
    NSApp.activate(ignoringOtherApps: true)

    // Future: parse URL path for specific actions (e.g., open settings, select host)
}
```

4. **Wire PingScheduler to WidgetDataStore:**

In AppDelegate, find where PingScheduler results are processed. Add WidgetDataStore initialization and call:

```swift
// Initialize widget data store with same group ID from Plan 01
private let widgetDataStore = WidgetDataStore(
    groupIdentifier: "TEAMID.group.com.hadm.PingScope"
)

// In ping result handler (after scheduler emits results):
Task {
    await widgetDataStore.savePingResults(results, hosts: allHosts)
}
```

Replace TEAMID with actual Team ID from Plan 01. This triggers widget updates on every ping cycle completion.

**Critical:** WidgetDataStore.savePingResults calls WidgetCenter.reloadTimelines(), so widgets update immediately when new data is written (in addition to 10-minute baseline timeline).
  </action>
  <verify>
Run: swift build
Confirm: PingScope and PingScopeWidget targets both compile
Confirm: Info.plist contains CFBundleURLTypes with "pingscope" scheme
Confirm: AppDelegate contains application(_:open:) method
Confirm: AppDelegate initializes WidgetDataStore and calls savePingResults
  </verify>
  <done>
Deep linking configured with pingscope:// URL scheme. Widget views include .widgetURL modifier. AppDelegate handles deep links and writes ping results to WidgetDataStore on each cycle.
  </done>
</task>

<task type="checkpoint:human-verify">
  <name>Verify Widget Functionality and Requirements</name>
  <what-built>
Complete WidgetKit integration for macOS with three widget sizes, App Groups shared data, deep linking, and automatic updates from main app ping cycles.

**What Claude automated:**
1. Widget Extension Xcode target with proper bundle ID hierarchy
2. App Groups entitlements using macOS Sequoia Team ID prefix
3. WidgetDataStore actor writing to shared UserDefaults
4. TimelineProvider reading cached data with 10-minute refresh
5. Small/medium/large widget views with status colors and stale indicators
6. Deep linking via pingscope:// URL scheme
7. AppDelegate wiring to write ping results to widget container
  </what-built>
  <how-to-verify>
**Prerequisites:**
- Build and run PingScope app (Cmd+R in Xcode)
- Open macOS Notification Center or Widget Gallery

**Verification Steps:**

**WI-01, WI-02, WI-03: App Groups and Extension Setup**
1. Open Xcode project settings → Signing & Capabilities for PingScope target
2. Confirm: App Groups entitlement shows with Team ID prefix (e.g., ABC123.group.com.hadm.PingScope)
3. Confirm: Same App Groups entitlement in PingScopeWidget target
4. Confirm: PingScopeWidget target exists with bundle ID com.hadm.PingScope.widget

**WI-04, WI-05, WI-06: Data Sharing and Updates**
5. Run main PingScope app
6. Wait 5-10 seconds for first ping cycle to complete
7. Open Console.app, filter for "PingScope"
8. Confirm: No "Failed to create UserDefaults suite" errors
9. Confirm: WidgetCenter.reloadTimelines logged (if debug enabled)

**WUI-01, WUI-02: Small Widget**
10. Open Widget Gallery (click date/time in menu bar, scroll to bottom, click "Edit Widgets")
11. Find "PingScope" in widget list
12. Drag Small widget to desktop
13. Confirm: Shows single host name (e.g., "Google DNS")
14. Confirm: Shows color-coded status dot (green/yellow/red)
15. Confirm: Shows latency value (e.g., "25.3 ms") or "Timeout"
16. Confirm: Shows relative timestamp (e.g., "2m ago")

**WUI-03, WUI-04: Medium Widget**
17. Drag Medium widget to desktop
18. Confirm: Shows 3 hosts horizontally
19. Confirm: Each host shows color-coded status dot
20. Confirm: Each host shows latency or "Timeout"

**WUI-05, WUI-06, WUI-07: Large Widget**
21. Drag Large widget to desktop
22. Confirm: Shows all configured hosts in vertical list
23. Confirm: Shows "PingScope" header
24. Confirm: Shows last update timestamp in header
25. Confirm: Each host shows status dot + name + latency

**WUI-08: Deep Linking**
26. Click on any widget (small/medium/large)
27. Confirm: PingScope app activates and comes to foreground

**WUI-09: Stale Data Indicator**
28. Quit PingScope app
29. Wait 16 minutes
30. Check widgets
31. Confirm: Widget content appears dimmed/faded (60% opacity)
32. Confirm: Orange warning indicator visible (triangle icon or "Stale" text)

**WUI-10: Dark Mode Support**
33. System Settings → Appearance → Dark
34. Check all three widget sizes
35. Confirm: Text is readable (light text on dark background)
36. Confirm: Status dots remain visible
37. System Settings → Appearance → Light
38. Confirm: Text is readable (dark text on light background)

**Success Criteria (Phase 17 Roadmap):**
✓ 1. User can add small widget showing single host status with color-coded indicator and current latency
✓ 2. User can add medium widget showing multi-host summary (3 hosts) with status indicators
✓ 3. User can add large widget showing all configured hosts with statistics
✓ 4. Widget displays last update timestamp and shows stale data indicator when >15 minutes old
✓ 5. Tapping any widget opens main PingScope app
✓ 6. Widgets update within 5-15 minutes showing current ping status from running app
✓ 7. Widgets display correctly in both light and dark mode

**Common Issues:**

- **Widget shows "No Data"**: Rebuild PingScopeWidget target, ensure App Groups match exactly
- **Widget not in gallery**: Clean build folder (Cmd+Shift+K), rebuild all targets
- **Permission error in Console**: Verify Team ID prefix in App Groups (not `group.` prefix)
- **Widget doesn't update**: Confirm WidgetDataStore.savePingResults called in AppDelegate
- **Deep link doesn't work**: Check Info.plist CFBundleURLTypes configuration

**Screenshot Locations (for documentation):**
- Notification Center with all three widget sizes
- Light mode and dark mode comparison
- Stale data indicator appearance
  </how-to-verify>
  <resume-signal>
Type "approved" if all success criteria pass, or describe specific issues/failures.

If failures exist, note which requirement IDs failed and what the observed behavior was.
  </resume-signal>
</task>

</tasks>

<verification>
1. Deep linking works (tapping widget opens app)
2. Widgets appear in macOS widget gallery
3. All three sizes display correctly
4. Widgets update from app ping data
5. Dark mode renders properly
6. Stale data indicator works (>15min)
</verification>

<success_criteria>
- All 17 widget requirements (WI-01 through WUI-10) verified by human testing
- Widgets appear in gallery and can be added to desktop/Notification Center
- Tapping widgets opens PingScope app via deep link
- Data flows from app to widgets via shared UserDefaults
- Visual appearance correct in both light and dark modes
</success_criteria>

<output>
After completion, create `.planning/phases/17-widget-foundation/17-03-SUMMARY.md`
</output>
