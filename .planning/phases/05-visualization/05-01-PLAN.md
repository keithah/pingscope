---
phase: 05-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Sources/PingScope/ViewModels/DisplayViewModel.swift
  - Tests/PingScopeTests/DisplayViewModelTests.swift
autonomous: true

must_haves:
  truths:
    - "Selecting 'Last 1 hour' shows up to one hour of samples without truncation"
    - "Per-host sample history retains the newest 3600 samples in-memory (session-only)"
    - "Graph + history projections stay newest-first and remain bounded in memory"
  artifacts:
    - path: "Sources/PingScope/ViewModels/DisplayViewModel.swift"
      provides: "Per-host in-memory sample storage and time-range filtered projections"
      contains: "sampleBufferLimit|filteredSamples"
    - path: "Tests/PingScopeTests/DisplayViewModelTests.swift"
      provides: "Regression coverage for bounded sample retention"
      contains: "bounded|sample"
  key_links:
    - from: "Sources/PingScope/ViewModels/DisplayViewModel.swift"
      to: "Sources/PingScope/Models/DisplayMode.swift"
      via: "selectedTimeRange.windowDuration filtering"
      pattern: "windowDuration"
    - from: "Sources/PingScope/ViewModels/DisplayViewModel.swift"
      to: "Sources/PingScope/Views/RecentResultsListView.swift"
      via: "selectedHostRecentResults projection"
      pattern: "selectedHostRecentResults"
---

<objective>
Increase per-host in-memory history capacity to support the full 1-hour time range.

Purpose: Phase 5 requires a usable 1-hour view; the app must retain enough samples per host to make that filter meaningful without persisting to disk.

Output: A 3600-sample per-host buffer default + tests that lock in bounded retention behavior.
</objective>

<execution_context>
@/Users/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/05-visualization/05-CONTEXT.md

@Sources/PingScope/ViewModels/DisplayViewModel.swift
@Tests/PingScopeTests/DisplayViewModelTests.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Increase default per-host sample buffer to 3600</name>
  <files>Sources/PingScope/ViewModels/DisplayViewModel.swift</files>
  <action>
Update `DisplayViewModel`'s default `sampleBufferLimit` from 360 to 3600.

Constraints:
- Keep storage session-only (no persistence).
- Keep the existing time-range filtering logic (`windowDuration` cutoff) unchanged.
- Preserve bounded memory behavior by trimming from the oldest samples.
  </action>
  <verify>swift test</verify>
  <done>
Default `DisplayViewModel()` retains up to 3600 samples per host and continues trimming oldest-first beyond the limit.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add regression test locking the 3600 default retention</name>
  <files>Tests/PingScopeTests/DisplayViewModelTests.swift</files>
  <action>
Add a unit test that constructs `DisplayViewModel(preferencesStore: store)` with defaults and ingests >3600 samples for a single host (timestamps within the last hour). Assert that the projected `recentResults(for: host.id, limit: nil)` returns exactly 3600 rows.

Notes:
- Use timestamps that are safely within the 1-hour window so time-range filtering does not reduce the count.
- Keep the loop tight and deterministic (no sleeps).
  </action>
  <verify>swift test</verify>
  <done>
The test fails if the default buffer size regresses below 3600 or becomes unbounded.
  </done>
</task>

</tasks>

<verification>
- `swift test` passes.
</verification>

<success_criteria>
- `DisplayViewModel` defaults to a 3600-sample per-host buffer.
- There is a test that proves bounded retention at 3600 with timestamps inside the 1-hour window.
</success_criteria>

<output>
After completion, create `.planning/phases/05-visualization/05-01-SUMMARY.md`
</output>
