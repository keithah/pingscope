---
phase: 09-regression-test-wiring-recovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Tests/PingScopeTests/StatusItemTitleFormatterTests.swift
  - Tests/PingScopeTests/ContextMenuFactoryTests.swift
  - Tests/PingScopeTests/MenuBarIntegrationSmokeTests.swift
autonomous: true

must_haves:
  truths:
    - "Test targets compile without stale symbol/signature errors"
    - "ContextMenuActions test wiring aligns with current production interface"
    - "Regression suite runs to completion in local verification flow"
  artifacts:
    - path: "Tests/PingScopeTests/ContextMenuFactoryTests.swift"
      provides: "ContextMenuFactory tests with correct ContextMenuActions signature"
      contains: "onOpenAbout:"
    - path: "Tests/PingScopeTests/MenuBarIntegrationSmokeTests.swift"
      provides: "Integration smoke tests with correct ContextMenuActions signature"
      contains: "onOpenAbout:"
  key_links:
    - from: "Tests/PingScopeTests/ContextMenuFactoryTests.swift"
      to: "Sources/PingScope/MenuBar/ContextMenuFactory.swift"
      via: "ContextMenuActions initializer signature match"
      pattern: "onOpenAbout.*onQuit"
    - from: "Tests/PingScopeTests/MenuBarIntegrationSmokeTests.swift"
      to: "Sources/PingScope/MenuBar/ContextMenuFactory.swift"
      via: "ContextMenuActions initializer signature match"
      pattern: "onOpenAbout.*onQuit"
---

<objective>
Repair stale test references and re-establish compile-green regression baseline.

Purpose: The milestone audit identified three specific compilation failures blocking the test suite. Fixing these restores automated regression verification capability for the project.

Output: Clean-compiling test targets and passing regression suite.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-regression-test-wiring-recovery/09-RESEARCH.md

# Production interface (target alignment)
@Sources/PingScope/MenuBar/ContextMenuFactory.swift

# Test files requiring repair
@Tests/PingScopeTests/StatusItemTitleFormatterTests.swift
@Tests/PingScopeTests/ContextMenuFactoryTests.swift
@Tests/PingScopeTests/MenuBarIntegrationSmokeTests.swift

# Existing coverage (confirms removal is safe)
@Tests/PingScopeTests/MenuBarViewModelTests.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove obsolete StatusItemTitleFormatterTests.swift</name>
  <files>Tests/PingScopeTests/StatusItemTitleFormatterTests.swift</files>
  <action>
Delete `Tests/PingScopeTests/StatusItemTitleFormatterTests.swift` entirely.

**Why safe to remove:** The test file references `StatusItemTitleFormatter`, a type that no longer exists in production code. The formatting logic was inlined into `MenuBarViewModel.formatLatencyText()`. The behaviors tested (compact mode suffix removal, fallback text handling, non-compact mode preservation) are covered by `MenuBarViewModelTests` via the `compactLatencyText` property tests.

**Before removal, confirm coverage:**
- `testStartupStateIsGrayWithNAText` tests N/A fallback
- `testHealthyAndWarningTransitions` tests "42 ms" / "130 ms" formatted output
- `testSustainedFailureTurnsRedAfterThreshold` tests N/A on failure
- `testSmoothingReducesAbruptTextJumps` tests formatted text changes

All assertions use `compactLatencyText` which returns the formatted string.
  </action>
  <verify>
Run: `swift build --build-tests 2>&1 | grep StatusItemTitleFormatter`
Expected: No output (no references remain)
  </verify>
  <done>StatusItemTitleFormatterTests.swift deleted, no stale StatusItemTitleFormatter references in test compilation</done>
</task>

<task type="auto">
  <name>Task 2: Add onOpenAbout parameter to ContextMenuActions calls and verify full regression</name>
  <files>Tests/PingScopeTests/ContextMenuFactoryTests.swift, Tests/PingScopeTests/MenuBarIntegrationSmokeTests.swift</files>
  <action>
**Fix ContextMenuFactoryTests.swift:**

1. In `testActionsInvokeCallbacks()` (lines 40-46):
   - Add `var openAboutCalled = false` alongside other callback flags
   - Add `onOpenAbout: { openAboutCalled = true },` between `onOpenSettings:` and `onQuit:`
   - Add assertion `XCTAssertTrue(openAboutCalled)` after triggering
   - Add trigger call for the about menu item

2. In `makeMenu(state:)` helper (lines 83-89):
   - Add `onOpenAbout: {},` between `onOpenSettings: {},` and `onQuit: {}`

3. In `testMenuStructureIncludesRequiredSectionsAndItems()`:
   - Update item count assertion from 8 to 9 (new About item)
   - Add assertion for About PingScope item position (after Settings)

**Fix MenuBarIntegrationSmokeTests.swift:**

1. In `testContextMenuCallbacksToggleAndPersistModePreferences()` (lines 35-41):
   - Add `onOpenAbout: {},` between `onOpenSettings: {},` and `onQuit: {}`

**Production signature reference:**
```swift
struct ContextMenuActions {
    var onSwitchHost: () -> Void
    var onToggleCompactMode: () -> Void
    var onToggleStayOnTop: () -> Void
    var onOpenSettings: () -> Void
    var onOpenAbout: () -> Void    // <-- This parameter was added
    var onQuit: () -> Void
}
```

**After fixes, run full verification sequence:**

1. Quick targeted validation:
   ```bash
   swift build --build-tests
   ```

2. Full regression suite:
   ```bash
   swift test
   ```

Document command invocations and outcomes in summary.
  </action>
  <verify>
1. Compile check: `swift build --build-tests` exits 0 with no errors
2. Full test run: `swift test` completes with all tests passing
3. No stale wiring errors in output
  </verify>
  <done>
- ContextMenuFactoryTests.swift compiles with correct ContextMenuActions signature
- MenuBarIntegrationSmokeTests.swift compiles with correct ContextMenuActions signature
- `swift build --build-tests` succeeds
- `swift test` runs to completion with all tests passing
  </done>
</task>

</tasks>

<verification>
## Phase Verification

1. **Compile baseline:**
   ```bash
   swift build --build-tests
   ```
   Expected: Exit 0, no errors

2. **Full regression run:**
   ```bash
   swift test
   ```
   Expected: All tests pass

3. **Evidence capture:**
   - Document before state (compilation errors)
   - Document after state (clean compile + test pass)
   - Include exact command invocations and outcomes

## Failure Policy
- Compile errors: Block completion, fix before proceeding
- Deterministic test failures: Block completion, investigate and fix
- Transient/flaky failures: Single retry allowed with explicit logging
- Repeated flakiness: Treat as unresolved, blocks completion
</verification>

<success_criteria>
1. Test targets compile without stale symbol/signature errors
2. `StatusItemTitleFormatter` reference removed (obsolete test deleted)
3. `ContextMenuActions` test wiring aligns with current production interface (includes `onOpenAbout`)
4. Regression suite runs to completion in local verification flow
5. Before/after evidence documented in summary
</success_criteria>

<output>
After completion, create `.planning/phases/09-regression-test-wiring-recovery/09-01-SUMMARY.md` with:
- Before state: compilation error evidence
- Changes made: file deletions and modifications
- After state: compile and test run results
- Command invocations with exact outputs
</output>
