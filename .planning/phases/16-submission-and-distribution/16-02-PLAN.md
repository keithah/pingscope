---
phase: 16-submission-and-distribution
plan: 02
type: execute
wave: 2
depends_on: [16-01]
files_modified: []
autonomous: false
requirements: [SUBM-05, SUBM-06]

must_haves:
  truths:
    - "Package uploaded successfully to App Store Connect"
    - "Build appears in App Store Connect Builds section"
    - "Build processing completes (status: Ready to Submit or Ready to Test)"
    - "Internal TestFlight testers can install and run the App Store build"
  artifacts: []
  key_links:
    - from: "xcrun altool --upload-app"
      to: "App Store Connect"
      via: "API authentication"
      pattern: "apiKey.*apiIssuer"
---

<objective>
Upload validated package to App Store Connect and test via TestFlight internal testing.

Purpose: Submit first build to Apple's servers, confirm upload processing succeeds, and verify sandboxed build works identically to Developer ID build (except ICMP).
Output: App Store build available in TestFlight for internal testing, confirmed functional.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-submission-and-distribution/16-RESEARCH.md
@.planning/phases/16-submission-and-distribution/16-01-SUMMARY.md
@AppStoreAssets/Metadata/review-notes.txt
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <action>Upload package to App Store Connect</action>
  <instructions>
**What to do:** Upload dist/PingScope.pkg to App Store Connect using xcrun altool or Transporter.

**Option 1: Using xcrun altool (recommended)**

If you have App Store Connect API key configured:
```bash
xcrun altool --upload-app \
  -f dist/PingScope.pkg \
  -t macos \
  --apiKey YOUR_KEY_ID \
  --apiIssuer YOUR_ISSUER_ID
```

If using Apple ID authentication:
```bash
xcrun altool --upload-app \
  -f dist/PingScope.pkg \
  -t macos \
  -u YOUR_APPLE_ID \
  -p "@keychain:AC_PASSWORD"
```

**Option 2: Using Transporter app**
1. Open Transporter app
2. Click "Add App" button
3. Select `dist/PingScope.pkg`
4. Click "Deliver" (cloud icon with up arrow)
5. Wait for upload to complete (progress bar)

**Expected timeline:**
- Upload: 1-5 minutes (depends on connection speed)
- Processing: 5-30 minutes (Apple's server-side validation)
- Email notification: "Your app has been processed" or "Your app has issues"

**After upload:**
1. Wait for email confirmation from App Store Connect
2. Check https://appstoreconnect.apple.com → My Apps → PingScope → TestFlight → Builds
3. Build should appear with status "Processing" → "Ready to Submit" or "Ready to Test"

**Common upload errors:**
- ITMS-90062 (duplicate binary): Increment CFBundleVersion in Configuration/Info.plist and rebuild
- Network timeout: Retry upload, altool handles retries automatically
- Invalid provisioning profile: Ensure App Store provisioning profile matches bundle ID
- Missing app record: Create app record in App Store Connect first (com.hadm.pingscope)

**If build processing fails:**
- Check email for specific error details
- Common issues: missing icon, invalid entitlements, Info.plist errors
- Fix and re-upload with incremented build number

**Why human-required:** Upload requires Apple ID authentication (2FA), API key configuration, or may encounter errors needing interpretation.
  </instructions>
  <resume-signal>Type "uploaded" when build appears in App Store Connect with status "Processing", "Ready to Submit", or "Ready to Test"</resume-signal>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure TestFlight internal testing and add testers</action>
  <instructions>
**What to do:** Set up TestFlight internal testing group and add testers.

**Prerequisites:**
- Build must have "Ready to Submit" or "Ready to Test" status (processing complete)
- You must have App Store Connect account with Admin, App Manager, or Developer role

**Steps:**

1. **Complete Export Compliance (if prompted)**
   - Go to https://appstoreconnect.apple.com → My Apps → PingScope → TestFlight
   - Click on the processed build
   - If "Export Compliance" section shows "Missing Compliance", click "Provide Export Compliance Information"
   - Question: "Does your app use encryption?" → Answer: **NO**
   - Rationale: PingScope uses standard TLS (App Transport Security) but not custom encryption
   - This matches Info.plist declaration: `ITSAppUsesNonExemptEncryption = false`

2. **Add Beta App Information (if missing)**
   - Go to TestFlight → App Information
   - Beta App Name: PingScope
   - Beta App Description: "Network latency monitoring from your Mac menu bar"
   - Feedback Email: (your support email)
   - Privacy Policy URL: (optional for internal testing)

3. **Create Internal Testing Group**
   - Go to TestFlight → Internal Testing
   - Click "+" to create new group
   - Group Name: "Internal Team"
   - Enable Automatic Distribution: OFF (manual control for first build)

4. **Add Internal Testers**
   - In the "Internal Team" group, click "Testers" → "+"
   - Add yourself and any team members with App Store Connect access
   - Note: Internal testers = App Store Connect users only (max 100)
   - External testers require App Review (defer to post-launch)

5. **Add Build to Group**
   - Click "Builds" section in "Internal Team" group
   - Click "+" to add build
   - Select the uploaded build (version 1.1.0 build 1)
   - Click "Add"

**What happens next:**
- Testers receive email: "You're Invited to Test PingScope"
- Testers must install TestFlight app from Mac App Store
- Testers click email link → Opens TestFlight → "Install" button appears

**Why human-required:** TestFlight configuration requires App Store Connect UI interaction (no API), export compliance questions, and tester management decisions.
  </instructions>
  <resume-signal>Type "configured" when internal testing group created, testers added, and build assigned to group</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>App Store build uploaded to App Store Connect and available in TestFlight for internal testing</what-built>
  <how-to-verify>
**Install and test the TestFlight build:**

1. **Install TestFlight build**
   - Open TestFlight app on Mac (install from Mac App Store if needed)
   - Click invitation email link or open TestFlight → PingScope should appear
   - Click "Install" button
   - Wait for download and installation (app installs to /Applications/PingScope.app)

2. **Verify sandbox behavior**
   - Launch PingScope from Applications folder
   - Open Settings (Cmd+,)
   - Go to Hosts tab → Click existing host or add new host
   - Method dropdown should show **only TCP and UDP** (ICMP hidden)
   - Confirm: No ICMP option in picker (correct for sandboxed App Store build)

3. **Verify TCP ping works**
   - Create or edit host: Address = google.com, Port = 80, Method = TCP
   - Save and select as active host
   - Menu bar should show latency updates (e.g., "52ms")
   - Open full display mode → graph should show latency points
   - Confirm: TCP ping working, latency displayed

4. **Verify UDP ping works**
   - Create or edit host: Address = 8.8.8.8, Port = 53, Method = UDP
   - Save and select as active host
   - Menu bar should show latency updates
   - Confirm: UDP ping working, latency displayed

5. **Verify no crashes during 5-minute session**
   - Let app run for 5 minutes monitoring active host
   - Switch between full and compact display modes
   - Open Settings and change preferences
   - Confirm: No crashes, no errors, smooth operation

6. **Verify Console.app sandbox detection log**
   - Open Console.app (Applications → Utilities)
   - Search for "PingScope" in search bar
   - Look for "SandboxDetector" log message
   - Expected: Log shows `sandbox=true` or similar confirmation
   - Confirm: App correctly detects it's running in sandbox

**Expected results:**
- ✓ ICMP method not visible in UI (sandboxed behavior correct)
- ✓ TCP ping functional (port 80 to google.com works)
- ✓ UDP ping functional (port 53 to 8.8.8.8 works)
- ✓ No crashes during testing session
- ✓ Menu bar updates with latency values
- ✓ Display modes work correctly
- ✓ Console.app shows sandbox detection log

**If issues found:**
- ICMP visible: Wrong build uploaded (Developer ID instead of App Store)
- TCP/UDP not working: Network client entitlement missing
- Crashes: Check Console.app for error logs, may need bug fix

**Comparison to Developer ID build:**
- App Store build: ICMP hidden, TCP/UDP work
- Developer ID build: ICMP visible and functional, TCP/UDP work
- Otherwise identical: same UI, same features, same behavior
  </how-to-verify>
  <resume-signal>Type "approved" if TestFlight build works correctly (ICMP hidden, TCP/UDP functional), or describe issues if verification fails</resume-signal>
</task>

</tasks>

<verification>
After completion:
- Build uploaded to App Store Connect successfully
- Build processing completed (status: Ready to Submit or Ready to Test)
- Export compliance completed (encryption = NO)
- Internal TestFlight group created with testers added
- Build available in TestFlight app for installation
- TestFlight build tested and confirmed functional (ICMP hidden, TCP/UDP work)
</verification>

<success_criteria>
- Package uploads successfully to App Store Connect
- Build processing completes without errors (email confirmation received)
- Build appears in TestFlight Builds section
- Internal testers can install build from TestFlight app
- Installed build shows correct sandbox behavior (ICMP hidden)
- TCP and UDP ping methods work correctly in TestFlight build
- No crashes during 5-minute testing session
- SUBM-05: Package uploaded successfully via altool or Transporter
- SUBM-06: Internal TestFlight build tested and approved
</success_criteria>

<output>
After completion, create `.planning/phases/16-submission-and-distribution/16-02-SUMMARY.md`
</output>
