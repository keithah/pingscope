---
phase: 16-submission-and-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Configuration/ExportOptions-AppStore.plist
  - Scripts/validate-appstore-build.sh
autonomous: false
requirements: [SUBM-01, SUBM-02, SUBM-03, SUBM-04]

must_haves:
  truths:
    - "App builds successfully with PingScope-AppStore scheme"
    - "Archive exports as .pkg file suitable for App Store upload"
    - "xcrun altool validation passes all checks"
  artifacts:
    - path: "Configuration/ExportOptions-AppStore.plist"
      provides: "Export configuration for app-store method"
      contains: "<key>method</key>"
    - path: "Scripts/validate-appstore-build.sh"
      provides: "Automated pre-upload validation"
      exports: ["#!/bin/bash"]
    - path: "dist/PingScope.xcarchive"
      provides: "Xcode archive with App Store entitlements"
    - path: "dist/PingScope.pkg"
      provides: "Signed App Store package"
  key_links:
    - from: "xcodebuild archive"
      to: "PingScope-AppStore scheme"
      via: "-scheme flag"
      pattern: "-scheme PingScope-AppStore"
    - from: "xcodebuild -exportArchive"
      to: "Configuration/ExportOptions-AppStore.plist"
      via: "-exportOptionsPlist flag"
      pattern: "-exportOptionsPlist.*ExportOptions-AppStore"
---

<objective>
Archive PingScope for App Store submission and validate locally before upload.

Purpose: Create production-ready App Store build and catch validation errors early before upload to App Store Connect.
Output: Validated .pkg file ready for upload to App Store Connect via altool or Transporter.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-submission-and-distribution/16-RESEARCH.md
@Configuration/PingScope-AppStore.entitlements
@Configuration/Info.plist
@.planning/phases/13-xcode-infrastructure-setup/13-02-SUMMARY.md
@.planning/phases/14-privacy-and-compliance/14-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExportOptions-AppStore.plist and archive App Store build</name>
  <files>
    Configuration/ExportOptions-AppStore.plist
  </files>
  <action>
Create ExportOptions-AppStore.plist in Configuration/ directory with app-store export method:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>app-store</string>
    <key>uploadSymbols</key>
    <true/>
    <key>compileBitcode</key>
    <false/>
</dict>
</plist>
```

Archive PingScope using PingScope-AppStore scheme:

```bash
xcodebuild archive \
  -project PingScope.xcodeproj \
  -scheme PingScope-AppStore \
  -destination 'generic/platform=macOS' \
  -archivePath dist/PingScope.xcarchive
```

Export archive as .pkg for App Store:

```bash
xcodebuild -exportArchive \
  -archivePath dist/PingScope.xcarchive \
  -exportOptionsPlist Configuration/ExportOptions-AppStore.plist \
  -exportPath dist/
```

Note: When method=app-store, xcodebuild exports .pkg (not .app) automatically for macOS.

Verify .pkg was created:

```bash
ls -lh dist/PingScope.pkg
```
  </action>
  <verify>
Run these checks:

1. ExportOptions-AppStore.plist exists and contains method=app-store
2. Archive exists at dist/PingScope.xcarchive/Products/Applications/PingScope.app
3. Package exists at dist/PingScope.pkg (not .app directory)
4. Package is signed: `pkgutil --check-signature dist/PingScope.pkg | grep "signed by"`

Expected: All checks pass, .pkg file created successfully.
  </verify>
  <done>
Configuration/ExportOptions-AppStore.plist exists with app-store method. Archive created successfully. Package file dist/PingScope.pkg exists and is signed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create validation script and validate App Store package</name>
  <files>
    Scripts/validate-appstore-build.sh
  </files>
  <action>
Create Scripts/validate-appstore-build.sh executable validation script:

```bash
#!/bin/bash
# Validate App Store build before upload
# Checks: archive entitlements, package signature, bundle ID, version format

set -e

ARCHIVE_PATH="dist/PingScope.xcarchive/Products/Applications/PingScope.app"
PACKAGE_PATH="dist/PingScope.pkg"

echo "=== App Store Build Validation ==="
echo ""

# Check 1: Archive exists
if [ ! -d "$ARCHIVE_PATH" ]; then
  echo "❌ Archive not found at $ARCHIVE_PATH"
  exit 1
fi
echo "✓ Archive found"

# Check 2: Package exists
if [ ! -f "$PACKAGE_PATH" ]; then
  echo "❌ Package not found at $PACKAGE_PATH"
  exit 1
fi
echo "✓ Package found"

# Check 3: Sandbox entitlement enabled
SANDBOX=$(codesign -d --entitlements :- "$ARCHIVE_PATH" 2>&1 | grep -c "app-sandbox.*true" || true)
if [ "$SANDBOX" -eq 0 ]; then
  echo "❌ Sandbox entitlement missing or disabled"
  exit 1
fi
echo "✓ Sandbox enabled"

# Check 4: Network client entitlement
NETWORK=$(codesign -d --entitlements :- "$ARCHIVE_PATH" 2>&1 | grep -c "network.client.*true" || true)
if [ "$NETWORK" -eq 0 ]; then
  echo "❌ Network client entitlement missing"
  exit 1
fi
echo "✓ Network client entitlement present"

# Check 5: Package signature
pkgutil --check-signature "$PACKAGE_PATH" > /dev/null 2>&1
if [ $? -ne 0 ]; then
  echo "❌ Package signature invalid"
  exit 1
fi
echo "✓ Package signed correctly"

# Check 6: Bundle identifier
BUNDLE_ID=$(defaults read "$ARCHIVE_PATH/Contents/Info.plist" CFBundleIdentifier)
if [ "$BUNDLE_ID" != "com.hadm.pingscope" ]; then
  echo "❌ Bundle ID mismatch: $BUNDLE_ID"
  exit 1
fi
echo "✓ Bundle ID correct: $BUNDLE_ID"

# Check 7: Version format
VERSION=$(defaults read "$ARCHIVE_PATH/Contents/Info.plist" CFBundleShortVersionString)
BUILD=$(defaults read "$ARCHIVE_PATH/Contents/Info.plist" CFBundleVersion)
echo "✓ Version: $VERSION"
echo "✓ Build: $BUILD"

echo ""
echo "=== All validation checks passed ==="
echo "Package ready for upload: $PACKAGE_PATH"
```

Make executable: `chmod +x Scripts/validate-appstore-build.sh`

Run validation script:

```bash
./Scripts/validate-appstore-build.sh
```

Expected: All 7 checks pass, script exits 0.
  </action>
  <verify>
Run `./Scripts/validate-appstore-build.sh` and confirm:
- All checks marked with ✓
- Script exits with code 0 (success)
- No ❌ errors reported

Package validation confirms: sandbox enabled, network client present, signed correctly, bundle ID matches.
  </verify>
  <done>
Scripts/validate-appstore-build.sh exists, is executable, runs successfully with all checks passing. Package validated and ready for upload.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Validate App Store package with Apple's validation service</action>
  <instructions>
**What to do:** Run Apple's official validation before uploading to App Store Connect.

**Option 1: Using xcrun altool (recommended for first validation)**

If you have App Store Connect API key configured:
```bash
xcrun altool --validate-app \
  -f dist/PingScope.pkg \
  -t macos \
  --apiKey YOUR_KEY_ID \
  --apiIssuer YOUR_ISSUER_ID
```

If using Apple ID authentication:
```bash
xcrun altool --validate-app \
  -f dist/PingScope.pkg \
  -t macos \
  -u YOUR_APPLE_ID \
  -p "@keychain:AC_PASSWORD"
```

**Option 2: Using Transporter app (if altool unavailable)**
1. Open Transporter app from Mac App Store
2. Click "Add App" button
3. Select `dist/PingScope.pkg`
4. Click "Verify" (cloud icon with checkmark)
5. Wait for validation to complete

**Expected outcome:**
- Validation succeeds with no errors
- If errors occur, read carefully and fix before upload

**Common validation errors:**
- Missing icon: Check Assets.xcassets has 1024x1024 App Store icon
- Invalid entitlements: Ensure only sandbox-compatible entitlements present
- Version conflict: Increment CFBundleVersion if upload attempted before
- Missing privacy manifest: Confirm PrivacyInfo.xcprivacy embedded

**If API key not configured:** You'll need Apple ID + app-specific password. Validation can proceed in next plan with upload step.

**Why human-required:** First App Store validation may require Apple ID 2FA authentication, API key setup, or resolving validation errors that need interpretation.
  </instructions>
  <resume-signal>Type "validated" when altool/Transporter validation passes, or "skip" if proceeding to upload without pre-validation (validation happens during upload)</resume-signal>
</task>

</tasks>

<verification>
After completion:
- Configuration/ExportOptions-AppStore.plist exists with app-store method
- dist/PingScope.pkg exists and is signed
- Scripts/validate-appstore-build.sh runs successfully (7 checks pass)
- Optional: xcrun altool --validate-app confirms package ready for upload
</verification>

<success_criteria>
- App builds with App Store scheme without errors
- Archive exports as .pkg file (macOS App Store format)
- Local validation script passes all entitlement/signing checks
- Package ready for upload to App Store Connect
- SUBM-01: Built with Xcode 26+ (confirmed in build output)
- SUBM-02: Apple Distribution certificate used for signing
- SUBM-03: App Store provisioning profile embedded in build
- SUBM-04: Package validates successfully with altool or Transporter
</success_criteria>

<output>
After completion, create `.planning/phases/16-submission-and-distribution/16-01-SUMMARY.md`
</output>
