---
phase: 16-submission-and-distribution
plan: 04
type: execute
wave: 4
depends_on: [16-03]
files_modified:
  - .github/workflows/appstore-release.yml
autonomous: true
requirements: [SUBM-09, SUBM-10]

must_haves:
  truths:
    - "GitHub Actions workflow created for automated App Store builds"
    - "Workflow can be triggered manually with version and build number inputs"
    - "Workflow archives, exports, validates, and uploads to App Store Connect"
  artifacts:
    - path: ".github/workflows/appstore-release.yml"
      provides: "CI/CD workflow for App Store releases"
      min_lines: 100
      contains: "workflow_dispatch"
  key_links:
    - from: ".github/workflows/appstore-release.yml"
      to: "PingScope-AppStore scheme"
      via: "xcodebuild -scheme"
      pattern: "PingScope-AppStore"
    - from: "GitHub Actions"
      to: "App Store Connect"
      via: "altool upload"
      pattern: "altool --upload-app"
---

<objective>
Create GitHub Actions workflow for automated App Store build and upload.

Purpose: Automate App Store release process for future versions using manual trigger with version inputs. Workflow handles archive, export, validation, and upload to App Store Connect.
Output: Working CI/CD workflow tested with manual trigger.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-submission-and-distribution/16-RESEARCH.md
@.planning/phases/16-submission-and-distribution/16-01-SUMMARY.md
@.planning/phases/16-submission-and-distribution/16-03-SUMMARY.md
@.github/workflows/production-release.yml
@Configuration/ExportOptions-AppStore.plist
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions workflow for App Store releases</name>
  <files>
    .github/workflows/appstore-release.yml
  </files>
  <action>
Create .github/workflows/appstore-release.yml for automated App Store builds:

```yaml
name: App Store Release

on:
  workflow_dispatch:
    inputs:
      marketing_version:
        description: 'Marketing version (e.g., 1.1.0)'
        required: true
        type: string
      build_number:
        description: 'Build number (must be unique, increment from last)'
        required: true
        type: string
      skip_testflight:
        description: 'Skip TestFlight upload (validation only)'
        required: false
        type: boolean
        default: false

env:
  SCHEME_NAME: "PingScope-AppStore"
  ARCHIVE_PATH: "dist/PingScope.xcarchive"
  EXPORT_PATH: "dist/"
  PACKAGE_NAME: "PingScope.pkg"

jobs:
  build-and-upload:
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set Xcode version
      run: |
        # Use latest Xcode available on GitHub-hosted runner
        sudo xcode-select -s /Applications/Xcode.app
        xcodebuild -version

    - name: Import App Store certificates
      run: |
        # Create temporary keychain (isolated from system)
        security create-keychain -p "build-pass" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "build-pass" build.keychain
        security set-keychain-settings -t 3600 -u build.keychain

        # Decode and import Apple Distribution certificate
        echo "${{ secrets.APPLE_DISTRIBUTION_P12 }}" | base64 -d > distribution.p12
        security import distribution.p12 \
          -k build.keychain \
          -P "${{ secrets.CERTIFICATE_PASSWORD }}" \
          -A

        # Set partition list for codesign access
        security set-key-partition-list \
          -S apple-tool:,apple:,codesign: \
          -s -k "build-pass" build.keychain

        # Find Apple Distribution identity
        SIGNING_IDENTITY=$(security find-identity -v -p codesigning build.keychain | grep "Apple Distribution" | head -1 | grep -o '"[^"]*"' | tr -d '"')

        if [ -z "$SIGNING_IDENTITY" ]; then
          echo "❌ Could not find Apple Distribution certificate"
          security find-identity -v -p codesigning build.keychain
          exit 1
        fi

        echo "APP_SIGNING_IDENTITY=$SIGNING_IDENTITY" >> $GITHUB_ENV
        echo "✅ Using signing identity: $SIGNING_IDENTITY"

    - name: Install provisioning profile
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        echo "${{ secrets.APPSTORE_PROVISIONING_PROFILE }}" | \
          base64 -d > ~/Library/MobileDevice/Provisioning\ Profiles/appstore.provisionprofile

        echo "✅ Provisioning profile installed"

    - name: Update version numbers
      run: |
        /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ inputs.marketing_version }}" Configuration/Info.plist
        /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ inputs.build_number }}" Configuration/Info.plist

        echo "✅ Version: ${{ inputs.marketing_version }}"
        echo "✅ Build: ${{ inputs.build_number }}"

    - name: Clean build directory
      run: |
        rm -rf dist/
        mkdir -p dist/
        echo "✅ Build directory cleaned"

    - name: Archive app
      run: |
        xcodebuild archive \
          -project PingScope.xcodeproj \
          -scheme "$SCHEME_NAME" \
          -destination 'generic/platform=macOS' \
          -archivePath "$ARCHIVE_PATH"

        echo "✅ Archive created"

    - name: Verify archive entitlements
      run: |
        # Verify sandbox entitlement present (required for App Store)
        SANDBOX_CHECK=$(codesign -d --entitlements :- "$ARCHIVE_PATH/Products/Applications/PingScope.app" 2>&1 | grep -c "app-sandbox.*true" || true)

        if [ "$SANDBOX_CHECK" -eq 0 ]; then
          echo "❌ Sandbox entitlement missing - wrong scheme?"
          codesign -d --entitlements :- "$ARCHIVE_PATH/Products/Applications/PingScope.app" 2>&1
          exit 1
        fi

        echo "✅ Sandbox entitlement verified"

    - name: Export for App Store
      run: |
        xcodebuild -exportArchive \
          -archivePath "$ARCHIVE_PATH" \
          -exportOptionsPlist Configuration/ExportOptions-AppStore.plist \
          -exportPath "$EXPORT_PATH"

        # Verify .pkg was created (macOS App Store uses .pkg, not .app)
        if [ ! -f "$EXPORT_PATH/$PACKAGE_NAME" ]; then
          echo "❌ Package not created - check export options"
          ls -la "$EXPORT_PATH"
          exit 1
        fi

        echo "✅ Package exported: $EXPORT_PATH/$PACKAGE_NAME"

    - name: Validate package
      run: |
        xcrun altool --validate-app \
          -f "$EXPORT_PATH/$PACKAGE_NAME" \
          -t macos \
          --apiKey "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" \
          --apiIssuer "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}"

        echo "✅ Package validation passed"

    - name: Upload to App Store Connect
      if: ${{ !inputs.skip_testflight }}
      run: |
        xcrun altool --upload-app \
          -f "$EXPORT_PATH/$PACKAGE_NAME" \
          -t macos \
          --apiKey "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" \
          --apiIssuer "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}"

        echo "✅ Upload complete"

    - name: Upload artifact (validation-only mode)
      if: ${{ inputs.skip_testflight }}
      uses: actions/upload-artifact@v4
      with:
        name: PingScope-${{ inputs.marketing_version }}-build-${{ inputs.build_number }}
        path: ${{ env.EXPORT_PATH }}/${{ env.PACKAGE_NAME }}
        retention-days: 7

    - name: Clean up
      if: always()
      run: |
        security delete-keychain build.keychain || true
        rm -f distribution.p12

    - name: Summary
      run: |
        echo "## App Store Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ inputs.marketing_version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Build:** ${{ inputs.build_number }}" >> $GITHUB_STEP_SUMMARY
        echo "**Scheme:** $SCHEME_NAME" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ inputs.skip_testflight }}" == "true" ]; then
          echo "**Mode:** Validation only (package saved as artifact)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Download package artifact from Actions run" >> $GITHUB_STEP_SUMMARY
          echo "2. Upload manually using Transporter or altool" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Status:** Uploaded to App Store Connect" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Wait for email: 'Your app has been processed' (5-30 min)" >> $GITHUB_STEP_SUMMARY
          echo "2. Check App Store Connect → TestFlight → Builds" >> $GITHUB_STEP_SUMMARY
          echo "3. Complete export compliance (encryption = NO)" >> $GITHUB_STEP_SUMMARY
          echo "4. Add build to internal testing group" >> $GITHUB_STEP_SUMMARY
          echo "5. Test in TestFlight" >> $GITHUB_STEP_SUMMARY
          echo "6. Submit for App Review in App Store Connect" >> $GITHUB_STEP_SUMMARY
        fi
```

Save workflow file.

Key differences from production-release.yml (Developer ID workflow):
1. Uses `macos-latest` (GitHub-hosted) instead of `self-hosted` runner
2. Uses Apple Distribution certificate instead of Developer ID certificates
3. Imports App Store provisioning profile instead of Developer ID profile
4. Archives with PingScope-AppStore scheme (sandboxed) instead of PingScope-DeveloperID
5. Uses altool with App Store Connect API authentication
6. No DMG/PKG installer creation (App Store handles distribution)
7. No notarization step (App Store handles that)
8. No GitHub release creation (App Store is the release)

Required GitHub Secrets (user must configure):
- `APPLE_DISTRIBUTION_P12`: Base64-encoded Apple Distribution certificate (.p12)
- `CERTIFICATE_PASSWORD`: Password for .p12 file
- `APPSTORE_PROVISIONING_PROFILE`: Base64-encoded App Store provisioning profile
- `APP_STORE_CONNECT_KEY_ID`: App Store Connect API key ID
- `APP_STORE_CONNECT_ISSUER_ID`: App Store Connect API issuer ID

To encode secrets:
```bash
# Certificate
base64 -i AppleDistribution.p12 | pbcopy

# Provisioning profile
base64 -i AppStore.provisionprofile | pbcopy
```

Manual trigger usage:
```bash
# Via GitHub CLI
gh workflow run appstore-release.yml \
  -f marketing_version=1.1.0 \
  -f build_number=2 \
  -f skip_testflight=false

# Via GitHub UI
# Actions → App Store Release → Run workflow → Enter inputs → Run
```
  </action>
  <verify>
Check workflow file:
1. File exists at .github/workflows/appstore-release.yml
2. Contains `workflow_dispatch` trigger with 3 inputs (marketing_version, build_number, skip_testflight)
3. Uses PingScope-AppStore scheme for archive
4. Verifies sandbox entitlement after archive
5. Uses altool for validation and upload with API key authentication
6. Includes cleanup step (always runs) to delete temporary keychain
7. Provides summary with next steps for user

File is comprehensive (>100 lines) and follows GitHub Actions best practices.
  </verify>
  <done>
.github/workflows/appstore-release.yml created with complete CI/CD workflow for App Store releases. Workflow supports manual trigger with version inputs, archives app, validates package, uploads to App Store Connect using API authentication.
  </done>
</task>

<task type="auto">
  <name>Task 2: Document GitHub Secrets setup in SUBMISSION.md</name>
  <files>
    AppStoreAssets/SUBMISSION.md
  </files>
  <action>
Append CI/CD automation section to AppStoreAssets/SUBMISSION.md after the "Checklist Template" section:

```markdown

---

## CI/CD Automation (GitHub Actions)

### Overview

After first manual submission, future releases can use GitHub Actions workflow for automated build and upload.

### Required GitHub Secrets

Configure these secrets in GitHub Settings → Secrets and variables → Actions:

| Secret Name | Value | How to Obtain |
|------------|-------|---------------|
| `APPLE_DISTRIBUTION_P12` | Base64-encoded .p12 certificate | Export from Keychain Access → Certificates → Apple Distribution → Export → base64 encode |
| `CERTIFICATE_PASSWORD` | Password for .p12 file | Password you set when exporting certificate |
| `APPSTORE_PROVISIONING_PROFILE` | Base64-encoded .provisionprofile | Download from developer.apple.com → Profiles → base64 encode |
| `APP_STORE_CONNECT_KEY_ID` | API key ID (e.g., ABCD123456) | App Store Connect → Users and Access → Keys → Key ID |
| `APP_STORE_CONNECT_ISSUER_ID` | Issuer ID (UUID format) | App Store Connect → Users and Access → Keys → Issuer ID |

### Obtaining App Store Connect API Key

One-time setup (skip if already configured):

1. Go to https://appstoreconnect.apple.com
2. Navigate to Users and Access → Keys
3. Click "+" to create new key
4. Name: "GitHub Actions CI/CD"
5. Access: App Manager or Developer
6. Click "Generate"
7. Download `AuthKey_XXXXX.p8` file (ONE TIME DOWNLOAD - save securely)
8. Note Key ID and Issuer ID from the page
9. Store .p8 file securely (needed for encoding secret)

### Encoding Secrets

**Apple Distribution Certificate:**
```bash
# Export certificate from Keychain Access
# 1. Open Keychain Access
# 2. Find "Apple Distribution: Your Name (TEAMID)"
# 3. Right-click → Export → Save as AppleDistribution.p12
# 4. Set password when prompted

# Encode for GitHub Secret
base64 -i AppleDistribution.p12 | pbcopy
# Paste into GitHub Secret: APPLE_DISTRIBUTION_P12
```

**App Store Provisioning Profile:**
```bash
# Download from developer.apple.com
# 1. Go to Certificates, Identifiers & Profiles
# 2. Profiles → App Store profile for com.hadm.pingscope
# 3. Download → Save as AppStore.provisionprofile

# Encode for GitHub Secret
base64 -i AppStore.provisionprofile | pbcopy
# Paste into GitHub Secret: APPSTORE_PROVISIONING_PROFILE
```

**API Key (for altool authentication):**
```bash
# The .p8 file itself is NOT uploaded to GitHub
# Only the Key ID and Issuer ID are stored as secrets
# Keep .p8 file in secure location (1Password, Keychain)
```

### Triggering Automated Release

**Via GitHub UI:**
1. Go to Actions tab in GitHub repo
2. Select "App Store Release" workflow
3. Click "Run workflow" dropdown
4. Fill inputs:
   - Marketing version: 1.1.0 (user-facing version)
   - Build number: 2 (must be unique, increment from last)
   - Skip TestFlight: false (upload to App Store Connect)
5. Click "Run workflow"

**Via GitHub CLI:**
```bash
gh workflow run appstore-release.yml \
  -f marketing_version=1.1.0 \
  -f build_number=2 \
  -f skip_testflight=false
```

### Workflow Steps

Automated workflow performs:
1. ✅ Checkout code
2. ✅ Import Apple Distribution certificate
3. ✅ Install App Store provisioning profile
4. ✅ Update version numbers in Configuration/Info.plist
5. ✅ Archive with PingScope-AppStore scheme
6. ✅ Verify sandbox entitlement present
7. ✅ Export as .pkg for App Store
8. ✅ Validate package with altool
9. ✅ Upload to App Store Connect (if skip_testflight=false)

### After Automated Upload

Manual steps still required:
1. Wait for email: "Your app has been processed" (5-30 min)
2. Go to App Store Connect → PingScope → TestFlight
3. Complete export compliance (encryption = NO)
4. Add build to internal testing group
5. Test in TestFlight (verify sandbox behavior)
6. Go to App Store Connect → PingScope → App Store
7. Create new version or select existing
8. Select uploaded build
9. Update metadata if changed (description, screenshots, keywords)
10. Submit for App Review

### Validation-Only Mode

To test workflow without uploading:
```bash
gh workflow run appstore-release.yml \
  -f marketing_version=1.1.0 \
  -f build_number=999 \
  -f skip_testflight=true
```

This mode:
- Archives and exports package
- Validates with altool
- Saves package as GitHub artifact (download from Actions run)
- Does NOT upload to App Store Connect

Useful for testing workflow changes or creating packages for manual upload.

### Build Number Management

**Manual tracking:** Increment by 1 for each upload (1, 2, 3, 4...)

**Automated tracking:** Use git commit count or GitHub run number (future enhancement).

**Critical:** Never reuse build number. App Store Connect rejects duplicate CFBundleVersion even if previous build rejected.

### Troubleshooting Workflow

**Certificate import fails:**
- Check APPLE_DISTRIBUTION_P12 is base64-encoded correctly
- Verify CERTIFICATE_PASSWORD matches export password
- Confirm certificate not expired (valid 1 year from issue)

**Sandbox entitlement missing:**
- Wrong scheme selected (should be PingScope-AppStore)
- Entitlements file not linked in Xcode project
- Build configuration incorrect

**Upload fails:**
- Check APP_STORE_CONNECT_KEY_ID and ISSUER_ID correct
- Verify API key not revoked in App Store Connect
- Confirm app record exists in App Store Connect
- Check build number not duplicate

**Package validation fails:**
- Run locally: `./Scripts/validate-appstore-build.sh`
- Check archive entitlements: `codesign -d --entitlements :- dist/PingScope.xcarchive/...`
- Verify Info.plist version format correct

### Workflow Logs

Access logs:
1. GitHub → Actions → Select workflow run
2. Click job name "build-and-upload"
3. Expand steps to see detailed output
4. Download logs for offline review

Logs include:
- Xcode version
- Archive creation output
- Package export output
- altool validation/upload results
- Any errors encountered

### Future Enhancements

Potential workflow improvements (defer to v1.2+):
- Automatic build number from git commit count
- fastlane integration for metadata updates
- TestFlight tester distribution automation
- Release notes generation from git commits
- Screenshot validation before upload
```

Save updated SUBMISSION.md.
  </action>
  <verify>
AppStoreAssets/SUBMISSION.md contains new "CI/CD Automation" section with:
- GitHub Secrets table with all 5 required secrets
- App Store Connect API key setup instructions
- Certificate and provisioning profile encoding commands
- Workflow trigger instructions (UI and CLI)
- Workflow steps overview
- Post-upload manual steps list
- Validation-only mode explanation
- Build number management guidance
- Troubleshooting common issues
- Future enhancements section

Section is comprehensive (adds significant automation guidance).
  </verify>
  <done>
AppStoreAssets/SUBMISSION.md updated with CI/CD automation section. Documentation covers GitHub Secrets setup, API key generation, automated release triggering, and troubleshooting workflow issues.
  </done>
</task>

<task type="auto">
  <name>Task 3: Test workflow syntax and create README note</name>
  <files>
    .github/workflows/appstore-release.yml
  </files>
  <action>
Validate workflow YAML syntax locally:

```bash
# GitHub CLI validates workflow syntax
gh workflow view appstore-release.yml
```

Expected: Workflow displays without syntax errors.

If gh CLI not available, check manually:
- YAML is properly indented (spaces, not tabs)
- All `${{ }}` expressions valid
- `if:` conditions use correct syntax
- `secrets.` references formatted correctly

Add comment header to workflow file explaining purpose:

Edit .github/workflows/appstore-release.yml - add after first line:

```yaml
name: App Store Release

# Automated workflow for building and uploading PingScope to App Store Connect
#
# Trigger: Manual (workflow_dispatch) with version inputs
# Runner: GitHub-hosted macos-latest
# Purpose: Archive App Store build, validate, upload to TestFlight
#
# Prerequisites:
#   - GitHub Secrets configured (see AppStoreAssets/SUBMISSION.md)
#   - App Store Connect API key generated
#   - Apple Distribution certificate in Keychain
#   - App Store provisioning profile downloaded
#
# Usage:
#   Via UI: Actions → App Store Release → Run workflow → Enter inputs
#   Via CLI: gh workflow run appstore-release.yml -f marketing_version=1.1.0 -f build_number=2
#
# For detailed documentation, see: AppStoreAssets/SUBMISSION.md (CI/CD Automation section)
```

Commit workflow file.
  </action>
  <verify>
Run validation:
```bash
gh workflow view appstore-release.yml
```

Or check manually:
- Workflow file has descriptive header comment
- YAML syntax is valid (no parse errors)
- All required GitHub Actions syntax elements present
- File ready for commit

Expected: Workflow viewable, syntax valid.
  </verify>
  <done>
Workflow syntax validated. Header comment added explaining purpose, prerequisites, and usage. File ready for use with manual trigger.
  </done>
</task>

</tasks>

<verification>
After completion:
- .github/workflows/appstore-release.yml created with workflow_dispatch trigger
- Workflow archives PingScope-AppStore scheme, validates, uploads to App Store Connect
- AppStoreAssets/SUBMISSION.md updated with CI/CD automation section
- GitHub Secrets documented (5 required secrets with encoding instructions)
- Workflow syntax validated (gh workflow view or manual check)
- Header comment explains workflow purpose and usage
</verification>

<success_criteria>
- GitHub Actions workflow created for App Store releases
- Workflow supports manual trigger with version and build number inputs
- Workflow uses GitHub-hosted macos-latest runner (not self-hosted)
- Archive step uses PingScope-AppStore scheme with sandbox entitlements
- Validation and upload use altool with App Store Connect API authentication
- Skip TestFlight mode supported for validation-only runs
- Documentation updated with GitHub Secrets setup instructions
- Workflow ready for first test run (secrets must be configured by user)
- SUBM-09: GitHub Actions workflow created (.github/workflows/appstore-release.yml)
- SUBM-10: CI/CD workflow documented and ready for manual trigger testing
</success_criteria>

<output>
After completion, create `.planning/phases/16-submission-and-distribution/16-04-SUMMARY.md`
</output>
