---
phase: 06-notifications-settings
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - Sources/PingScope/Views/Settings/PingMonitorSettingsView.swift
  - Sources/PingScope/Views/Settings/NotificationSettingsView.swift
  - Sources/PingScope/PingMonitorApp.swift
  - Sources/PingScope/App/AppDelegate.swift
autonomous: true
gap_closure: true
gap_scope:
  mode: gap-only
  source_verification: ".planning/phases/06-notifications-settings/06-notifications-settings-VERIFICATION.md"
  failed_truths:
    - "User can configure notification settings per-host and globally"
    - "Settings panel opens with Cmd+, and shows all three tabs"
  requirements_in_scope:
    - "NOTF-03"
    - "SETT-02"
  requirements_not_in_scope:
    - "NOTF-01, NOTF-02, NOTF-04, NOTF-05, NOTF-06, NOTF-07, NOTF-08 (NEEDS HUMAN; validated in 06-06)"
    - "NOTF-09, NOTF-10, SETT-01, SETT-03, SETT-04, SETT-06 (already satisfied in verification)"

must_haves:
  truths:
    - "Settings panel opens with Cmd+, and shows three tabs: Hosts, Notifications, Display"
    - "User can configure global notification cooldown/threshold/intermittent controls from active Settings"
    - "Notification settings changed in Settings persist across close and restart"
  artifacts:
    - path: "Sources/PingScope/Views/Settings/PingMonitorSettingsView.swift"
      provides: "Active tabbed settings shell used by both Settings scene and dedicated Settings window"
      contains: "TabView"
      supports_truths:
        - "Settings panel opens with Cmd+, and shows three tabs: Hosts, Notifications, Display"
    - path: "Sources/PingScope/Views/Settings/NotificationSettingsView.swift"
      provides: "User-facing advanced notification controls wired to persisted preferences"
      contains: "cooldownSeconds|highLatencyThresholdMS|degradationPercentage|intermittent"
      supports_truths:
        - "User can configure global notification cooldown/threshold/intermittent controls from active Settings"
        - "Notification settings changed in Settings persist across close and restart"
    - path: "Sources/PingScope/PingMonitorApp.swift"
      provides: "Cmd+, settings command path remains wired to openSettings()"
      contains: "keyboardShortcut(\",\", modifiers: [.command])"
      supports_truths:
        - "Settings panel opens with Cmd+, and shows three tabs: Hosts, Notifications, Display"
  key_links:
    - from: "Sources/PingScope/PingMonitorApp.swift"
      to: "Sources/PingScope/App/AppDelegate.swift"
      via: "CommandGroup appSettings button calling openSettings()"
      pattern: "openSettings\(\)"
    - from: "Sources/PingScope/App/AppDelegate.swift"
      to: "Sources/PingScope/Views/Settings/PingMonitorSettingsView.swift"
      via: "NSHostingController root view"
      pattern: "PingMonitorSettingsView"
    - from: "Sources/PingScope/Views/Settings/PingMonitorSettingsView.swift"
      to: "Sources/PingScope/Views/Settings/NotificationSettingsView.swift"
      via: "Notifications tab content"
      pattern: "NotificationSettingsView"
---

<objective>
Close Phase 6 verification gaps by restoring a tabbed Settings shell and wiring advanced notification controls into the active user path.

Purpose: Phase 7 refactoring replaced the prior tabbed Settings shell with a single-page layout, which made required notification controls unreachable and broke the "three tabs" must-have.
Scope note: This is a gap-only closure plan scoped to failed truths from `06-notifications-settings-VERIFICATION.md`, not a reimplementation of all NOTF requirements.
Output: Active Settings UI (Cmd+, and dedicated window) exposes Hosts/Notifications/Display tabs, with full global notification configuration persisted through NotificationPreferencesStore.
</objective>

<execution_context>
@/Users/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-notifications-settings/06-notifications-settings-VERIFICATION.md
@.planning/phases/06-notifications-settings/06-04-SUMMARY.md
@.planning/phases/07-settings/07-02-SUMMARY.md
@.planning/phases/07-settings/07-03-SUMMARY.md

@Sources/PingScope/PingMonitorApp.swift
@Sources/PingScope/App/AppDelegate.swift
@Sources/PingScope/Views/Settings/PingMonitorSettingsView.swift
@Sources/PingScope/Views/Settings/NotificationSettingsView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restore a three-tab active Settings shell</name>
  <files>
    Sources/PingScope/Views/Settings/PingMonitorSettingsView.swift
    Sources/PingScope/PingMonitorApp.swift
    Sources/PingScope/App/AppDelegate.swift
  </files>
  <action>
Refactor the active Settings UI so the view shown by `AppDelegate.openSettings()` and the SwiftUI `Settings` scene presents a `TabView` with exactly three tabs: Hosts, Notifications, and Display. Keep existing runtime dependency wiring (shared `HostListViewModel`, `DisplayViewModel`, `NotificationPreferencesStore`) and keep Cmd+, command routing unchanged. Move existing host CRUD UI into Hosts tab and existing display toggles into Display tab without regressing add/edit/delete sheets, delete confirmation, or reset/default actions.

Avoid creating a second disconnected settings implementation; there must be one tabbed shell used by both entrypoints.
  </action>
  <verify>
`swift build` succeeds and `rg "Label\(\"Hosts\"|Label\(\"Notifications\"|Label\(\"Display\"" Sources/PingScope/Views/Settings/PingMonitorSettingsView.swift` finds all three tabs.
  </verify>
  <done>
Opening Settings via Cmd+, context menu, or in-app actions renders one tabbed Settings window with Hosts, Notifications, and Display tabs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire advanced notification controls into active Notifications tab</name>
  <files>
    Sources/PingScope/Views/Settings/PingMonitorSettingsView.swift
    Sources/PingScope/Views/Settings/NotificationSettingsView.swift
  </files>
  <action>
Use `NotificationSettingsView` as the Notifications tab content and ensure it is wired to the shared `NotificationPreferencesStore` already provided by AppDelegate so edits persist to UserDefaults. Expose and persist global controls required by the gap report: cooldown period, high-latency threshold, degradation percentage, and intermittent failure window/count (plus existing alert-type toggles).

Preserve existing behavior that host-level notification enable/disable remains managed per host (do not introduce a new per-host alert-type matrix unless already present in current model/contracts).
  </action>
  <verify>
`swift build` succeeds and `rg "cooldownSeconds|highLatencyThresholdMS|degradationPercentage|intermittent" Sources/PingScope/Views/Settings/NotificationSettingsView.swift` confirms advanced controls are present in the active notification view.
  </verify>
  <done>
Users can change cooldown, threshold, and intermittent notification settings from the active Settings flow and values persist through `NotificationPreferencesStore`.
  </done>
</task>

</tasks>

<verification>
- `swift build`
- `swift test --filter MenuBarIntegrationSmokeTests`
- Manual spot-check during execution: open Settings and confirm tab shell contains Hosts/Notifications/Display.
</verification>

<success_criteria>
- Gap truth closed: active Settings exposes full global notification configuration (not orphaned).
- Gap truth closed: Settings opened by Cmd+, has a three-tab structure (Hosts/Notifications/Display).
- Existing host CRUD and display settings behavior remains functional in their tab destinations.
- Gap-only requirement coverage is explicit: this plan closes blocked wiring for `NOTF-03`/`SETT-02`; other NOTF items remain covered by prior plans and runtime human verification.
</success_criteria>

<output>
After completion, create `.planning/phases/06-notifications-settings/06-07-SUMMARY.md`
</output>
