# fastlane/Fastfile
# Lanes for PingScope CI/CD automation.
#
# Environment variables required for API key lanes:
#   ASC_KEY_ID      — App Store Connect API key ID
#   ASC_ISSUER_ID   — App Store Connect issuer ID
#   ASC_KEY_CONTENT — Base64-encoded .p8 API key content
#
# Usage:
#   bundle exec fastlane submit_review     # Submit latest build for App Store review
#   bundle exec fastlane build_appstore    # Build App Store archive locally

default_platform(:mac)

platform :mac do

  # ── Private: ASC API key authentication ──────────────────────────────────────
  desc "Load App Store Connect API key from environment variables"
  private_lane :api_key do
    app_store_connect_api_key(
      key_id:              ENV["ASC_KEY_ID"],
      issuer_id:           ENV["ASC_ISSUER_ID"],
      key_content:         ENV["ASC_KEY_CONTENT"],
      is_key_content_base64: true,
      in_house:            false
    )
  end

  # ── Build: App Store archive (local use — no Xcode IDE required) ─────────────
  desc "Build App Store archive locally using xcodebuild via fastlane gym"
  lane :build_appstore do
    build_mac_app(
      project:          "PingScope.xcodeproj",
      scheme:           "PingScope-AppStore",
      configuration:    "Release",
      export_method:    "app-store",
      output_directory: "./build",
      output_name:      "PingScope.pkg"
    )
  end

  # ── Submit: trigger App Store review for the latest processed build ──────────
  desc "Submit the latest TestFlight build for App Store review (no binary upload)"
  lane :submit_review do
    key = api_key
    deliver(
      api_key:               key,
      submit_for_review:     true,
      automatic_release:     false,
      force:                 true,
      skip_metadata:         true,
      skip_screenshots:      true,
      skip_binary_upload:    true,
      platform:              "osx"
    )
  end

end
