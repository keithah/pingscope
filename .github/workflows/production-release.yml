name: Production Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 2.0.0)'
        required: true
        default: '2.0.0'

env:
  PRODUCT_NAME: "PingScope"
  PRODUCT_DISPLAY_NAME: "PingScope"
  BUNDLE_ID: "com.hadm.pingscope"

jobs:
  build-and-release:
    runs-on: macos-26
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        fi

    - name: Import signing certificates
      run: |
        # Create keychain with proper settings
        security create-keychain -p "build-keychain-pass" build.keychain || true
        security default-keychain -s build.keychain
        security unlock-keychain -p "build-keychain-pass" build.keychain
        security set-keychain-settings -t 3600 -u build.keychain

        # Import Developer ID Application certificate
        echo "${{ secrets.APPLE_CERTIFICATE_P12 }}" | base64 -d > app_certificate.p12
        echo "Importing Application certificate..."
        security import app_certificate.p12 -k build.keychain -P "${{ secrets.CERTIFICATE_PASSWORD }}" -A

        # Import Developer ID Installer certificate
        echo "${{ secrets.APPLE_INSTALLER_P12 }}" | base64 -d > installer_certificate.p12
        echo "Importing Installer certificate..."
        security import installer_certificate.p12 -k build.keychain -P "${{ secrets.CERTIFICATE_PASSWORD }}" -A

        # Set key partition list to allow codesign access
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "build-keychain-pass" build.keychain

        # Find Developer ID identities dynamically
        echo "=== Finding Developer ID identities ==="
        APP_SIGNING_IDENTITY=$(security find-identity -v -p codesigning build.keychain | grep "Developer ID Application" | head -1 | grep -o '"[^"]*"' | tr -d '"')
        INSTALLER_SIGNING_IDENTITY=$(security find-identity -v -p codesigning build.keychain | grep "Developer ID Installer" | head -1 | grep -o '"[^"]*"' | tr -d '"')

        if [ -z "$APP_SIGNING_IDENTITY" ]; then
          echo "❌ Could not find Developer ID Application certificate"
          security find-identity -v -p codesigning build.keychain
          exit 1
        fi

        if [ -z "$INSTALLER_SIGNING_IDENTITY" ]; then
          echo "❌ Could not find Developer ID Installer certificate"
          security find-identity -v -p codesigning build.keychain
          exit 1
        fi

        echo "APP_SIGNING_IDENTITY=$APP_SIGNING_IDENTITY" >> $GITHUB_ENV
        echo "INSTALLER_SIGNING_IDENTITY=$INSTALLER_SIGNING_IDENTITY" >> $GITHUB_ENV
        echo "✅ Using Application signing: $APP_SIGNING_IDENTITY"
        echo "✅ Using Installer signing: $INSTALLER_SIGNING_IDENTITY"

    - name: Build Release Binary
      run: |
        swift build -c release

    - name: Build App Bundle
      id: bundle
      run: |
        APP_PATH=$(scripts/build-app-bundle.sh release)
        echo "APP_PATH=$APP_PATH" >> $GITHUB_OUTPUT

    - name: Set up notarization credentials
      run: |
        xcrun notarytool store-credentials "NotarytoolProfile" \
          --apple-id "${{ secrets.APPLE_ID }}" \
          --password "${{ secrets.APPLE_APP_PASSWORD }}" \
          --team-id "${{ secrets.APPLE_TEAM_ID }}"

    - name: Sign and Notarize (DMG + PKG)
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        deploy/sign-notarize.sh \
          --version "$VERSION" \
          --app "${{ steps.bundle.outputs.APP_PATH }}" \
          --sign-app "$APP_SIGNING_IDENTITY" \
          --sign-installer "$INSTALLER_SIGNING_IDENTITY" \
          --notary-profile "NotarytoolProfile"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        name: PingScope v${{ steps.version.outputs.VERSION }}
        body: |
          ## PingScope v${{ steps.version.outputs.VERSION }}

          ### Installation

          **DMG Installation (Recommended)**
          1. Download `PingScope-${{ steps.version.outputs.VERSION }}.dmg`
          2. Open the DMG file
          3. Drag PingScope to your Applications folder

          **PKG Installation**
          1. Download `PingScope-${{ steps.version.outputs.VERSION }}.pkg`
          2. Double-click to run the installer

          ### Security
          - ✅ Signed with Developer ID
          - ✅ Notarized by Apple
          - ✅ Hardened runtime enabled

          ### Requirements
          - macOS 13.0 (Ventura) or later
        files: |
          /private/tmp/artifacts/PingScope-v${{ steps.version.outputs.VERSION }}/PingScope-v${{ steps.version.outputs.VERSION }}.dmg
          /private/tmp/artifacts/PingScope-v${{ steps.version.outputs.VERSION }}/PingScope-v${{ steps.version.outputs.VERSION }}.pkg
          /private/tmp/artifacts/PingScope-v${{ steps.version.outputs.VERSION }}/checksums-v${{ steps.version.outputs.VERSION }}.txt
        draft: false
        prerelease: false

    - name: Clean up keychain
      if: always()
      run: |
        security delete-keychain build.keychain || true
        rm -f app_certificate.p12 installer_certificate.p12
